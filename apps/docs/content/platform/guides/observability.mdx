---
title: Observability
description: Sistema completo de observabilidade com Golden Signals, m√©tricas Node.js e monitoramento em tempo real
date: 2026-01-06
author: Chris + Claude Sonnet 4.5
version: 2.0.0
tags: [observability, monitoring, metrics, golden-signals, prometheus, grafana]
---

# Observability

> Monitoramento avan√ßado baseado em padr√µes Prometheus/Grafana com Golden Signals e m√©tricas espec√≠ficas de Node.js

## Vis√£o Geral

O Kaven Boilerplate implementa um sistema robusto de observabilidade que combina:

- ‚úÖ **Golden Signals** (Google SRE) - Latency, Traffic, Errors, Saturation
- ‚úÖ **M√©tricas Node.js** - Event Loop Lag, Memory Heap, Active Handles/Requests
- ‚úÖ **Visualiza√ß√£o em Tempo Real** - Dashboard com atualiza√ß√£o autom√°tica
- ‚úÖ **Cores Sem√¢nticas** - Design System integrado para status visual
- ‚úÖ **Internacionaliza√ß√£o** - Suporte a pt-BR e EN

**Acesso:** `/observability`

---

## Golden Signals

Implementa√ß√£o dos 4 sinais essenciais de sa√∫de do sistema (Google SRE):

### 1. Latency (Tempo de Resposta)

Mede o tempo que leva para processar requisi√ß√µes.

**M√©tricas:**

- **p50 (mediana):** 50% das requisi√ß√µes s√£o mais r√°pidas
- **p95:** 95% das requisi√ß√µes s√£o mais r√°pidas (SLA t√≠pico)
- **p99:** 99% das requisi√ß√µes s√£o mais r√°pidas (tail latency)

**Fonte:** Histograma de lat√™ncias via `advanced-metrics.middleware.ts`

**Cor:** Info (Cyan) - `bg-info-lighter text-info-main`

```typescript
// Exemplo de valores
{
  latency: {
    p50: 45,   // 45ms
    p95: 120,  // 120ms
    p99: 250   // 250ms
  }
}
```

---

### 2. Traffic (Volume de Requisi√ß√µes)

Mede a demanda no sistema.

**M√©tricas:**

- **Requests/sec:** Taxa atual de requisi√ß√µes por segundo
- **Total Requests:** Contador acumulado desde o in√≠cio

**Fonte:** Counter via `prom-client`

**Cor:** Success (Green) - `bg-success-lighter text-success-main`

```typescript
{
  traffic: {
    requestsPerSecond: 12.5,
    totalRequests: 45678
  }
}
```

---

### 3. Errors (Taxa de Falhas)

Mede a confiabilidade do sistema.

**M√©tricas:**

- **Error Requests:** Contagem de requisi√ß√µes com status 5xx
- **Error Rate (%):** Percentual de falhas sobre o total

**Fonte:** Counter de status 5xx via middleware

**Cor:** Error (Red) - `bg-error-lighter text-error-main`

```typescript
{
  errors: {
    errorRequests: 23,
    errorRate: 0.5  // 0.5%
  }
}
```

> [!WARNING]
> Error Rate > 1% indica problema cr√≠tico que requer investiga√ß√£o imediata.

---

### 4. Saturation (Utiliza√ß√£o de Recursos)

Mede o quanto o sistema est√° sendo utilizado.

**M√©tricas:**

- **CPU Usage (%):** Percentual de uso de CPU
- **Memory Usage (%):** Heap usado / Heap total

**Fonte:** `process.cpuUsage()` e `process.memoryUsage()`

**Cor:** Secondary (Purple) - `bg-secondary-lighter text-secondary-main`

```typescript
{
  saturation: {
    cpuUsagePercent: 45,
    memoryUsagePercent: 67
  }
}
```

---

## M√©tricas Node.js

M√©tricas espec√≠ficas do runtime Node.js para diagn√≥stico avan√ßado.

### 1. Event Loop Lag ‚≠ê

**Cr√≠tico para Node.js!** Mede o atraso entre quando uma tarefa deveria executar vs quando realmente executa.

**Thresholds:**

- **< 10ms:** ‚úÖ Saud√°vel (status: good)
- **10-50ms:** ‚ö†Ô∏è Aten√ß√£o (status: warning)
- **> 50ms:** üî¥ Cr√≠tico - Event loop bloqueado (status: critical)

**Fonte:** `perf_hooks` com monitoramento cont√≠nuo

```typescript
{
  eventLoopLag: 8.5; // ms
}
```

> [!IMPORTANT]
> Event Loop Lag alto indica c√≥digo bloqueante (opera√ß√µes s√≠ncronas pesadas, loops infinitos, etc).

---

### 2. Memory Heap

Detalhamento da mem√≥ria heap do processo.

**M√©tricas:**

- **Used MB:** Mem√≥ria heap atualmente em uso
- **Total MB:** Mem√≥ria heap total alocada
- **External:** Mem√≥ria C++ vinculada a objetos JavaScript

**Thresholds:**

- **< 70%:** ‚úÖ Saud√°vel
- **70-85%:** ‚ö†Ô∏è Aten√ß√£o
- **> 85%:** üî¥ Cr√≠tico - Risco de memory leak

```typescript
{
  memoryHeap: {
    used: 245,      // MB
    total: 512,     // MB
    external: 12,   // MB
    usedMB: 245,
    totalMB: 512
  }
}
```

---

### 3. Active Handles

N√∫mero de handles ativos (file descriptors, sockets, timers).

**Thresholds:**

- **< 100:** ‚úÖ Saud√°vel
- **100-200:** ‚ö†Ô∏è Aten√ß√£o
- **> 200:** üî¥ Cr√≠tico - Poss√≠vel leak de recursos

```typescript
{
  activeHandles: 45;
}
```

---

### 4. Active Requests

N√∫mero de requisi√ß√µes HTTP em andamento.

**Thresholds:**

- **< 10:** ‚úÖ Saud√°vel
- **10-50:** ‚ö†Ô∏è Aten√ß√£o
- **> 50:** üî¥ Cr√≠tico - Sistema sobrecarregado

```typescript
{
  activeRequests: 3;
}
```

---

## API Reference

### `GET /api/observability/advanced`

Retorna todas as m√©tricas avan√ßadas (Golden Signals + Node.js).

**Response:**

```typescript
interface AdvancedMetrics {
  goldenSignals: {
    latency: { p50: number; p95: number; p99: number };
    traffic: { requestsPerSecond: number; totalRequests: number };
    errors: { errorRequests: number; errorRate: number };
    saturation: { cpuUsagePercent: number; memoryUsagePercent: number };
  };
  nodejs: {
    eventLoopLag: number;
    memoryHeap: {
      used: number;
      total: number;
      external: number;
      usedMB: number;
      totalMB: number;
    };
    activeHandles: number;
    activeRequests: number;
  };
  httpDetails: {
    statusDistribution: Record<string, number>;
    uptime: number;
  };
}
```

**Exemplo:**

```bash
curl http://localhost:8000/api/observability/advanced
```

---

## Implementa√ß√£o Frontend

### Componentes

**`GoldenSignals.tsx`:**

- 4 cards com m√©tricas principais
- Cores sem√¢nticas do Design System
- Atualiza√ß√£o autom√°tica a cada 5 segundos
- Skeleton loading durante carregamento

**`NodeJsMetrics.tsx`:**

- 4 cards com m√©tricas espec√≠ficas de Node.js
- Status visual baseado em thresholds
- Cores din√¢micas (good/warning/critical)

### Uso

```typescript
import { GoldenSignals } from './golden-signals';
import { NodeJsMetrics } from './nodejs-metrics';

export default function ObservabilityPage() {
  return (
    <div className="space-y-8">
      <GoldenSignals />
      <NodeJsMetrics />
    </div>
  );
}
```

---

## Internacionaliza√ß√£o

Todas as m√©tricas s√£o traduzidas automaticamente:

**pt-BR:**

```json
{
  "Observability": {
    "goldenSignals": {
      "latency": "Latency (p95)",
      "totalRequests": "total requests"
    },
    "nodejsMetrics": {
      "eventLoopLag": "Event Loop Lag",
      "memoryHeapDesc": "de {total}MB total"
    }
  }
}
```

**EN:**

```json
{
  "Observability": {
    "goldenSignals": {
      "latency": "Latency (p95)",
      "totalRequests": "total requests"
    },
    "nodejsMetrics": {
      "eventLoopLag": "Event Loop Lag",
      "memoryHeapDesc": "of {total}MB total"
    }
  }
}
```

---

## Integra√ß√£o com Prometheus/Grafana

O sistema exp√µe m√©tricas no formato Prometheus:

### Endpoint Prometheus

```bash
# M√©tricas no formato Prometheus
GET /metrics
```

### Exemplo de Configura√ß√£o Grafana

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'kaven-api'
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

---

## Troubleshooting

### Event Loop Lag Alto

**Sintomas:**

- Lag > 50ms consistentemente
- Aplica√ß√£o lenta/travando

**Causas Comuns:**

- Opera√ß√µes s√≠ncronas pesadas (crypto, JSON.parse de arquivos grandes)
- Loops infinitos ou recurs√£o profunda
- Blocking I/O

**Solu√ß√£o:**

```typescript
// ‚ùå ERRADO - Bloqueante
const data = fs.readFileSync('large-file.json');
const parsed = JSON.parse(data);

// ‚úÖ CORRETO - Ass√≠ncrono
const data = await fs.promises.readFile('large-file.json');
const parsed = JSON.parse(data);
```

---

### Memory Leak

**Sintomas:**

- Memory usage crescendo constantemente
- Heap > 85% por longos per√≠odos

**Causas Comuns:**

- Event listeners n√£o removidos
- Timers/intervals n√£o limpos
- Cache sem limite de tamanho
- Closures retendo refer√™ncias

**Solu√ß√£o:**

```typescript
// ‚úÖ Sempre limpar event listeners
useEffect(() => {
  const handler = () => {
    /* ... */
  };
  window.addEventListener('resize', handler);

  return () => window.removeEventListener('resize', handler);
}, []);
```

---

## Relacionados

- [Audit Logs](/platform/guides/audit-logs) - Sistema de auditoria
- [Internationalization](/platform/architecture/INTERNATIONALIZATION) - Sistema de i18n
- [Design System - Colors](/design-system/foundation/colors) - Cores sem√¢nticas

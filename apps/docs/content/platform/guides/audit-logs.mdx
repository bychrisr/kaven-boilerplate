---
title: Audit Logs
description: Sistema completo de auditoria com rastreamento de a√ß√µes cr√≠ticas, isolamento multi-tenant e visualiza√ß√£o em tempo real
date: 2026-01-06
author: Chris + Claude Sonnet 4.5
version: 1.0.0
tags: [audit, logs, security, compliance, multi-tenant, tracking]
---

# Audit Logs

> Sistema robusto de auditoria que rastreia todas as a√ß√µes cr√≠ticas do sistema com isolamento multi-tenant e visualiza√ß√£o em tempo real

## Vis√£o Geral

O sistema de Audit Logs √© a espinha dorsal de seguran√ßa e compliance do Kaven Boilerplate. Ele garante que **todas** as a√ß√µes cr√≠ticas sejam registradas de forma imut√°vel e contextualizada.

**Funcionalidades:**

- ‚úÖ **Rastreamento Completo** - Quem, O qu√™, Quando, Onde, Como
- ‚úÖ **Isolamento Multi-Tenant** - Logs segregados por tenant
- ‚úÖ **Imutabilidade** - Logs n√£o podem ser editados ou deletados via API
- ‚úÖ **Visualiza√ß√£o em Tempo Real** - Interface com pagina√ß√£o e filtros
- ‚úÖ **Cores Sem√¢nticas** - Badges coloridos para identifica√ß√£o visual
- ‚úÖ **Internacionaliza√ß√£o** - Suporte a pt-BR e EN

**Acesso:** `/audit-logs`

---

## Estrutura do Log

Cada entrada na tabela `AuditLog` responde √†s perguntas essenciais:

| Pergunta    | Campo                    | Descri√ß√£o                                 |
| ----------- | ------------------------ | ----------------------------------------- |
| **Quem?**   | `userId`                 | ID do usu√°rio que executou a a√ß√£o         |
| **Onde?**   | `tenantId`               | ID do tenant (null para a√ß√µes de sistema) |
| **O qu√™?**  | `action`                 | A√ß√£o executada (formato: `domain.event`)  |
| **Quando?** | `createdAt`              | Timestamp da a√ß√£o                         |
| **Como?**   | `ipAddress`, `userAgent` | Contexto da requisi√ß√£o                    |

### Schema Prisma

```prisma
model AuditLog {
  id        String   @id @default(uuid())
  action    String   // Ex: "auth.login.success"
  entity    String   // Ex: "User"
  entityId  String   // Ex: "user_123"
  userId    String   // Quem executou
  user      User?    @relation(fields: [userId], references: [id])
  tenantId  String?  // Isolamento multi-tenant
  metadata  Json     // Dados adicionais
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
}
```

---

## Taxonomia de A√ß√µes

Use esta refer√™ncia ao instrumentar novas funcionalidades. Mantenha o padr√£o `domain.event`.

### Autentica√ß√£o (`auth.*`)

| A√ß√£o                           | Descri√ß√£o                    | Metadata Sugerida                       |
| ------------------------------ | ---------------------------- | --------------------------------------- |
| `auth.login.success`           | Login bem-sucedido           | `{ method: 'email' \| 'google' }`       |
| `auth.login.failed`            | Falha de login               | `{ email, reason: 'invalid_password' }` |
| `auth.register`                | Novo usu√°rio registrado      | `{ method: 'email' \| 'google' }`       |
| `auth.logout`                  | Logout expl√≠cito             | `{}`                                    |
| `auth.password_reset.request`  | Solicita√ß√£o de reset enviada | `{ email }`                             |
| `auth.password_reset.complete` | Senha alterada com sucesso   | `{}`                                    |
| `auth.2fa.setup`               | 2FA configurado              | `{ method: 'totp' \| 'sms' }`           |
| `auth.2fa.disable`             | 2FA removido                 | `{}`                                    |

---

### Usu√°rios (`user.*`)

| A√ß√£o              | Descri√ß√£o                              | Metadata Sugerida                      |
| ----------------- | -------------------------------------- | -------------------------------------- |
| `user.create`     | Usu√°rio criado manualmente (por admin) | `{ role, email }`                      |
| `user.update`     | Perfil atualizado                      | `{ fields: ['name', 'role'] }`         |
| `user.delete`     | Usu√°rio removido/arquivado             | `{ reason }`                           |
| `user.promote`    | Mudan√ßa de Role                        | `{ from: 'USER', to: 'TENANT_ADMIN' }` |
| `user.suspend`    | Usu√°rio suspenso                       | `{ reason, duration }`                 |
| `user.reactivate` | Usu√°rio reativado                      | `{}`                                   |

---

### Tenants (`tenant.*`)

| A√ß√£o                         | Descri√ß√£o                         | Metadata Sugerida                  |
| ---------------------------- | --------------------------------- | ---------------------------------- |
| `tenant.create`              | Novo tenant criado                | `{ name, plan }`                   |
| `tenant.update`              | Configura√ß√µes de tenant alteradas | `{ fields: ['name', 'settings'] }` |
| `tenant.subscription.change` | Mudan√ßa de plano                  | `{ from: 'basic', to: 'premium' }` |
| `tenant.delete`              | Tenant removido                   | `{ reason }`                       |

---

### Financeiro (`invoice.*`, `payment.*`)

| A√ß√£o                | Descri√ß√£o            | Metadata Sugerida                     |
| ------------------- | -------------------- | ------------------------------------- |
| `invoice.create`    | Fatura gerada        | `{ amount, currency }`                |
| `invoice.pay`       | Pagamento registrado | `{ amount, method: 'pix' \| 'card' }` |
| `invoice.void`      | Fatura cancelada     | `{ reason }`                          |
| `payment.create`    | Pagamento PIX criado | `{ amount, qrCode }`                  |
| `payment.confirmed` | Pagamento confirmado | `{ transactionId }`                   |
| `payment.failed`    | Pagamento falhou     | `{ reason, errorCode }`               |

---

## Visualiza√ß√£o Frontend

### Cores Sem√¢nticas

A tabela de auditoria utiliza **badges coloridos** do Design System para facilitar identifica√ß√£o visual:

| Tipo de A√ß√£o   | Cor                | Classes Tailwind                                            |
| -------------- | ------------------ | ----------------------------------------------------------- |
| Delete/Failed  | üî¥ Error (Red)     | `bg-error-lighter text-error-main border-error-light`       |
| Create/Success | üü¢ Success (Green) | `bg-success-lighter text-success-main border-success-light` |
| Update         | üîµ Info (Blue)     | `bg-info-lighter text-info-main border-info-light`          |
| Outras         | ‚ö™ Muted (Gray)    | `bg-muted text-muted-foreground border-border`              |

### Componente `AuditLogTable`

```typescript
'use client';
import { useTranslations } from 'next-intl';
import { useQuery } from '@tanstack/react-query';

export function AuditLogTable() {
  const t = useTranslations('AuditLogs');
  const [page, setPage] = useState(1);

  const { data, isLoading } = useQuery({
    queryKey: ['audit-logs', page],
    queryFn: () => observabilityApi.getAuditLogs({ page, limit: 10 }),
    refetchInterval: 10000, // 10 segundos
  });

  return (
    <table>
      <thead>
        <tr>
          <th>{t('table.columns.dateTime')}</th>
          <th>{t('table.columns.action')}</th>
          <th>{t('table.columns.actor')}</th>
          <th>{t('table.columns.entity')}</th>
          <th>{t('table.columns.details')}</th>
        </tr>
      </thead>
      <tbody>
        {data?.logs.map(log => (
          <tr key={log.id}>
            <td>{format(new Date(log.createdAt), 'dd/MM/yyyy HH:mm:ss')}</td>
            <td>
              <span className={getActionBadgeClasses(log.action)}>
                {log.action}
              </span>
            </td>
            <td>{log.user?.name || log.userId}</td>
            <td>{log.entity}</td>
            <td>
              <Dialog>
                <DialogTrigger>
                  <Eye className="h-4 w-4" />
                </DialogTrigger>
                <DialogContent>
                  <pre>{JSON.stringify(log.metadata, null, 2)}</pre>
                </DialogContent>
              </Dialog>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  );
}
```

---

## API Reference

### `GET /api/audit-logs`

Retorna logs de auditoria com pagina√ß√£o e filtros.

**Query Parameters:**

- `page` (number, opcional) - P√°gina atual (default: 1)
- `limit` (number, opcional) - Itens por p√°gina (default: 10, max: 100)
- `action` (string, opcional) - Filtrar por a√ß√£o espec√≠fica
- `userId` (string, opcional) - Filtrar por usu√°rio
- `startDate` (ISO string, opcional) - Data inicial
- `endDate` (ISO string, opcional) - Data final

**Response:**

```typescript
interface AuditLogsResponse {
  logs: AuditLog[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

**Exemplo:**

```bash
# Buscar logs de login falhado
curl "http://localhost:8000/api/audit-logs?action=auth.login.failed&page=1&limit=20"

# Buscar logs de um usu√°rio espec√≠fico
curl "http://localhost:8000/api/audit-logs?userId=user_123"

# Buscar logs em um per√≠odo
curl "http://localhost:8000/api/audit-logs?startDate=2026-01-01&endDate=2026-01-31"
```

---

## Guia de Implementa√ß√£o

### Como Registrar um Evento

Injete o `AuditService` no seu servi√ßo ou controller e chame o m√©todo `create`.

**Exemplo B√°sico:**

```typescript
import { AuditService } from '@/audit/services/audit.service';

export class UserService {
  constructor(private audit: AuditService) {}

  async updateUser(userId: string, data: UpdateUserDto, actor: User) {
    // 1. Executar a l√≥gica
    const user = await this.db.user.update({
      where: { id: userId },
      data,
    });

    // 2. Registrar auditoria
    await this.audit.create({
      action: 'user.update',
      entity: 'User',
      entityId: userId,
      actorId: actor.id,
      tenantId: actor.tenantId,
      metadata: {
        fields: Object.keys(data),
        previousValues: {
          /* ... */
        },
        newValues: data,
      },
    });

    return user;
  }
}
```

**Exemplo com Request Context:**

```typescript
async login(email: string, password: string, req: Request) {
  try {
    const user = await this.validateCredentials(email, password);

    // Login bem-sucedido
    await this.audit.create({
      action: 'auth.login.success',
      entity: 'User',
      entityId: user.id,
      actorId: user.id,
      tenantId: user.tenantId,
      metadata: { method: 'email' },
      req, // Extrai IP e UserAgent automaticamente
    });

    return user;
  } catch (error) {
    // Login falhado
    await this.audit.create({
      action: 'auth.login.failed',
      entity: 'User',
      entityId: null,
      actorId: null,
      tenantId: null,
      metadata: {
        email,
        reason: error.message
      },
      req,
    });

    throw error;
  }
}
```

---

## Seguran√ßa e Compliance

### Isolamento Multi-Tenant

Logs pertencentes a um tenant **S√ì** podem ser vistos por:

- Admins desse tenant (`TENANT_ADMIN`)
- Super admins (`SUPER_ADMIN`)

**Implementa√ß√£o (RLS - Row Level Security):**

```typescript
// Middleware de autoriza√ß√£o
async getAuditLogs(user: User, filters: AuditLogFilters) {
  const where: Prisma.AuditLogWhereInput = {};

  // RLS: Filtrar por tenant se n√£o for SUPER_ADMIN
  if (user.role !== 'SUPER_ADMIN') {
    where.tenantId = user.tenantId;
  }

  // Aplicar filtros adicionais
  if (filters.action) where.action = filters.action;
  if (filters.userId) where.userId = filters.userId;

  return await prisma.auditLog.findMany({ where });
}
```

---

### Imutabilidade

**N√£o existem endpoints de API para `UPDATE` ou `DELETE` de logs.**

A remo√ß√£o s√≥ deve ocorrer via:

- Scripts de reten√ß√£o (ex: limpeza ap√≥s 1 ano)
- Acesso direto ao banco de dados
- Pol√≠ticas de compliance (LGPD/GDPR)

**Exemplo de Script de Reten√ß√£o:**

```typescript
// scripts/cleanup-old-audit-logs.ts
async function cleanupOldLogs() {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

  const deleted = await prisma.auditLog.deleteMany({
    where: {
      createdAt: { lt: oneYearAgo },
    },
  });

  console.log(`Deleted ${deleted.count} logs older than 1 year`);
}
```

---

### Dados Sens√≠veis

> [!CAUTION]
> **NUNCA grave no campo `metadata`:**
>
> - Senhas (mesmo hasheadas)
> - Tokens completos (JWT, API keys)
> - PII sens√≠vel (CPF, Cart√£o de Cr√©dito, SSN)
> - Dados m√©dicos ou financeiros completos

**‚úÖ Permitido:**

```json
{
  "metadata": {
    "email": "user@example.com",
    "cardLast4": "1234",
    "amount": 10000,
    "reason": "User request"
  }
}
```

**‚ùå Proibido:**

```json
{
  "metadata": {
    "password": "hash123",
    "token": "eyJhbGciOiJIUzI1...",
    "cpf": "123.456.789-00",
    "cardNumber": "1234 5678 9012 3456"
  }
}
```

---

## Internacionaliza√ß√£o

Todas as labels da tabela s√£o traduzidas automaticamente:

**pt-BR:**

```json
{
  "AuditLogs": {
    "title": "Logs de Auditoria",
    "table": {
      "columns": {
        "dateTime": "Data/Hora",
        "action": "A√ß√£o",
        "actor": "Ator",
        "entity": "Entidade",
        "details": "Detalhes"
      },
      "empty": "Nenhum log encontrado"
    },
    "pagination": {
      "previous": "Anterior",
      "next": "Pr√≥xima",
      "pageOf": "P√°gina {page} de {total}"
    }
  }
}
```

---

## Troubleshooting

### Logs N√£o Aparecem na Interface

**Causa:** Filtro de tenant incorreto ou permiss√µes insuficientes

**Solu√ß√£o:**

1. Verificar role do usu√°rio (`TENANT_ADMIN` ou `SUPER_ADMIN`)
2. Verificar se `tenantId` est√° correto no log
3. Verificar console do navegador para erros de API

---

### Performance Degradada

**Causa:** Muitos logs sem √≠ndices ou queries n√£o otimizadas

**Solu√ß√£o:**

```sql
-- Criar √≠ndices no banco
CREATE INDEX idx_audit_logs_tenant_created ON "AuditLog"("tenantId", "createdAt" DESC);
CREATE INDEX idx_audit_logs_action ON "AuditLog"("action");
CREATE INDEX idx_audit_logs_user ON "AuditLog"("userId");
```

---

### Erro CORS ao Buscar Logs

**Causa:** API n√£o est√° aceitando requisi√ß√µes do frontend

**Solu√ß√£o:**

```typescript
// apps/api/src/server.ts
fastify.register(cors, {
  origin: [
    'http://localhost:3000', // ‚Üê Adicionar origem do admin
    'http://localhost:3002',
  ],
  credentials: true,
});
```

---

## Melhores Pr√°ticas

### ‚úÖ Fazer

- **Registre todas as a√ß√µes cr√≠ticas** - Cria√ß√£o, atualiza√ß√£o, dele√ß√£o
- **Use metadata estruturada** - JSON bem formatado
- **Inclua contexto** - IP, UserAgent quando poss√≠vel
- **Respeite RLS** - Sempre filtrar por tenant
- **Teste isolamento** - Verificar que tenants n√£o veem logs de outros

### ‚ùå N√£o Fazer

- **Grave dados sens√≠veis** - Senhas, tokens, PII completo
- **Permita edi√ß√£o/dele√ß√£o via API** - Logs devem ser imut√°veis
- **Ignore performance** - Sempre use √≠ndices
- **Esque√ßa de traduzir** - Adicionar em pt.json E en.json
- **Misture logs de sistema com tenant** - Use `tenantId: null` para sistema

---

## Relacionados

- [Observability](/platform/guides/observability) - M√©tricas e monitoramento
- [Internationalization](/platform/architecture/INTERNATIONALIZATION) - Sistema de i18n
- [Design System - Colors](/design-system/foundation/colors) - Cores sem√¢nticas
- [Multi-Tenancy](/platform/architecture/multi-tenancy) - Isolamento de dados

---
title: PAGUEBIT INTEGRATION
description: Auto-migrated documentation
---

# PagueBit Integration - DocumentaÃ§Ã£o TÃ©cnica

**Data:** 05 de janeiro de 2026  
**Status:** âœ… IMPLEMENTADO  
**VersÃ£o:** 1.0.0

---

## ğŸ“‹ VisÃ£o Geral

IntegraÃ§Ã£o completa com PagueBit para processamento de pagamentos PIX no sistema Kaven. Implementa QR Code DinÃ¢mico, validaÃ§Ã£o de webhooks com HMAC-SHA256 v2, retry automÃ¡tico em rate limit e integraÃ§Ã£o com sistema de Plans & Products.

---

## ğŸ—ï¸ Arquitetura

### Estrutura de Arquivos

```
apps/api/src/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ validation-payments.ts          # Schemas Zod
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ payments/
â”‚       â”œâ”€â”€ providers/
â”‚       â”‚   â”œâ”€â”€ pix.interface.ts        # Interface agnÃ³stica
â”‚       â”‚   â””â”€â”€ paguebit/
â”‚       â”‚       â”œâ”€â”€ paguebit.client.ts  # HTTP client com retry
â”‚       â”‚       â”œâ”€â”€ paguebit.service.ts # Service principal
â”‚       â”‚       â”œâ”€â”€ paguebit.types.ts   # DTOs e interfaces
â”‚       â”‚       â””â”€â”€ paguebit.webhook.ts # Webhook handler
â”‚       â”œâ”€â”€ controllers/
â”‚       â”‚   â””â”€â”€ payment.controller.ts   # Controller (atualizado)
â”‚       â””â”€â”€ routes/
â”‚           â””â”€â”€ payment.routes.ts       # Routes (atualizado)

prisma/
â””â”€â”€ schema.prisma                       # WebhookEvent model
```

### Componentes Principais

#### 1. IPixProvider (Interface AgnÃ³stica)

Interface que abstrai providers de pagamento PIX, permitindo trocar de provider sem alterar cÃ³digo.

```typescript
export interface IPixProvider {
  createDynamicQRCode(params: CreateQRCodeParams): Promise<QRCodeResponse>;
  getPaymentStatus(paymentId: string): Promise<PaymentStatus>;
  validateWebhook(signature: string, body: string, timestamp: string): boolean;
  processWebhook(payload: WebhookPayload): Promise<void>;
}
```

#### 2. PagueBitClient (HTTP Client)

Cliente HTTP com retry automÃ¡tico em rate limit (429).

**CaracterÃ­sticas:**

- Retry com backoff exponencial (2s, 4s, 8s)
- Rate limit: 300 req/min por IP
- Timeout: 30 segundos
- Base URL: `https://api.paguebit.com/v1`

**Exemplo:**

```typescript
const client = new PagueBitClient();
const response = await client.post('/qrcode/dynamic', data, (retries = 3));
```

#### 3. PagueBitService

Service principal que implementa `IPixProvider`.

**MÃ©todos:**

- `createDynamicQRCode()` - Criar QR Code com expiraÃ§Ã£o de 10 minutos
- `getPaymentStatus()` - Buscar status de pagamento
- `validateWebhook()` - Validar assinatura HMAC-SHA256 v2

**ValidaÃ§Ã£o HMAC v2:**

```typescript
// VersÃ£o 2: HMAC-SHA256(timestamp + body, secret)
const payload = timestamp + body;
const expectedSignature = crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');
```

#### 4. PagueBitWebhook (Handler)

Handler de webhooks com idempotÃªncia e processamento de status.

**Fluxo:**

1. Validar assinatura HMAC
2. Verificar idempotÃªncia (WebhookEvent)
3. Salvar evento no banco
4. Processar payload
5. Marcar como processado

**Status de Pagamento:**

- `pending` - Aguardando pagamento (nÃ£o fazer nada)
- `review` - Em anÃ¡lise (NÃƒO confirmar ainda)
- `approved` - âœ… ÃšNICO que confirma recebimento
- `not_approved` - Rejeitado/expirado/estornado

---

## ğŸ”Œ API Endpoints

### POST /api/payments/paguebit/create

Criar pagamento PIX (produto ou plano).

**Request:**

```json
{
  "userId": "uuid",
  "tenantId": "uuid",
  "productId": "uuid", // OU planId
  "planId": "uuid" // OU productId
}
```

**Response:**

```json
{
  "purchaseId": "uuid",
  "paymentId": "paguebit-payment-id",
  "qrCode": "base64-image",
  "qrCodeText": "00020126...codigo-pix",
  "expiresAt": "2026-01-05T12:46:00Z",
  "amount": 29.99
}
```

### GET /api/payments/paguebit/:id/status

Verificar status de pagamento.

**Response:**

```json
{
  "id": "purchase-uuid",
  "status": "PENDING|COMPLETED|FAILED",
  "amount": 29.99,
  "externalPaymentId": "paguebit-payment-id"
}
```

### POST /api/webhooks/paguebit

Webhook do PagueBit (chamado automaticamente).

**Headers:**

```
X-Paguebit-Signature: hmac-sha256-hex
X-Paguebit-Timestamp: unix-timestamp
X-Paguebit-Event-Id: unique-event-id
```

**Payload:**

```json
{
  "id": "payment-id",
  "external_id": "purchase-uuid",
  "value": 29.99,
  "status": "approved",
  "paid_at": "2026-01-05T12:45:00Z"
}
```

---

## ğŸ—„ï¸ Database Schema

### WebhookEvent Model

```prisma
model WebhookEvent {
  id String @id @default(uuid())

  /// ID externo do evento (para idempotÃªncia)
  externalId String @unique @map("external_id")

  /// Provider (PAGUEBIT, STRIPE, etc)
  provider String

  /// Tipo de evento
  event String

  /// Payload completo
  payload Json

  /// Quando foi processado
  processedAt DateTime? @map("processed_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([provider])
  @@index([event])
  @@map("webhook_events")
}
```

---

## âš™ï¸ ConfiguraÃ§Ã£o

### VariÃ¡veis de Ambiente

```bash
# .env
PAGUEBIT_API_TOKEN=seu-token-aqui
PAGUEBIT_WEBHOOK_SECRET=seu-secret-aqui
```

### Obter Credenciais

1. Acesse [PagueBit Dashboard](https://dashboard.paguebit.com)
2. VÃ¡ em **ConfiguraÃ§Ãµes** â†’ **API**
3. Copie o **API Token**
4. Copie o **Webhook Secret**

---

## ğŸ”’ SeguranÃ§a

### ValidaÃ§Ã£o de Webhook

**SEMPRE** validar assinatura HMAC antes de processar:

```typescript
const isValid = pagueBitService.validateWebhook(signature, body, timestamp);
if (!isValid) {
  return reply.status(401).send({ error: 'Invalid signature' });
}
```

### IdempotÃªncia

Webhooks podem ser enviados mÃºltiplas vezes. Use `X-Paguebit-Event-Id` para evitar processamento duplicado:

```typescript
const existingEvent = await prisma.webhookEvent.findUnique({
  where: { externalId: eventId },
});

if (existingEvent) {
  return reply.status(200).send({ received: true, duplicate: true });
}
```

---

## ğŸ“Š Fluxo de Pagamento

```mermaid
sequenceDiagram
    participant U as UsuÃ¡rio
    participant F as Frontend
    participant A as API Kaven
    participant P as PagueBit
    participant W as Webhook

    U->>F: Seleciona plano/produto
    F->>A: POST /api/payments/paguebit/create
    A->>A: Cria Purchase (PENDING)
    A->>P: POST /qrcode/dynamic
    P-->>A: QR Code + paymentId
    A->>A: Atualiza Purchase com externalPaymentId
    A-->>F: QR Code + expiresAt (10min)
    F-->>U: Exibe QR Code

    U->>P: Paga via PIX
    P->>P: Processa pagamento
    P->>W: POST /webhooks/paguebit (status: approved)
    W->>W: Valida HMAC
    W->>W: Verifica idempotÃªncia
    W->>W: Salva WebhookEvent
    W->>W: Atualiza Purchase (COMPLETED)
    W->>W: Aplica efeitos do produto
    W-->>P: 200 OK

    F->>A: GET /api/payments/paguebit/:id/status
    A-->>F: status: COMPLETED
    F-->>U: Pagamento confirmado!
```

---

## ğŸ§ª Testes

### Teste Manual (Desenvolvimento)

```bash
# 1. Criar pagamento
curl -X POST http://localhost:8000/api/payments/paguebit/create \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user-uuid",
    "tenantId": "tenant-uuid",
    "planId": "plan-uuid"
  }'

# 2. Verificar status
curl http://localhost:8000/api/payments/paguebit/{purchaseId}/status

# 3. Simular webhook (use ngrok para expor localhost)
curl -X POST https://your-domain.com/api/webhooks/paguebit \
  -H "X-Paguebit-Signature: hmac-signature" \
  -H "X-Paguebit-Timestamp: 1704470400" \
  -H "X-Paguebit-Event-Id: unique-id" \
  -d '{
    "id": "payment-id",
    "external_id": "purchase-uuid",
    "value": 29.99,
    "status": "approved"
  }'
```

---

## âš ï¸ Tratamento de Erros

### Rate Limit (429)

Retry automÃ¡tico com backoff exponencial:

- 1Âª tentativa: imediata
- 2Âª tentativa: 2 segundos
- 3Âª tentativa: 4 segundos
- 4Âª tentativa: 8 segundos

### QR Code Expirado

- **ExpiraÃ§Ã£o:** 10 minutos
- **Status final:** `not_approved`
- **Pagamento apÃ³s expiraÃ§Ã£o:** Estornado automaticamente

### Webhook Duplicado

IdempotÃªncia garante que mesmo evento nÃ£o seja processado 2x.

---

## ğŸ“ˆ Monitoramento

### Logs Importantes

```typescript
// Webhook recebido
console.log(
  `ğŸ“¥ Processando webhook: ${payload.id} | Status: ${payload.status}`,
);

// Pagamento aprovado
console.log(`âœ… Pagamento ${externalId} aprovado!`);

// Webhook duplicado
console.log(`âœ… Webhook ${eventId} jÃ¡ processado anteriormente`);

// Erro de validaÃ§Ã£o
console.error('âŒ Webhook signature invÃ¡lida');
```

### MÃ©tricas Recomendadas

- Taxa de sucesso de webhooks
- Tempo mÃ©dio de processamento
- Taxa de retry em rate limit
- QR Codes expirados vs pagos

---

## ğŸ”„ PrÃ³ximos Passos

### PendÃªncias (Aguardando Resposta PagueBit)

1. **Loja Virtual API**
   - CRUD de produtos via API
   - SincronizaÃ§Ã£o automÃ¡tica

2. **QR Code EstÃ¡tico**
   - Endpoint para buscar via API
   - Webhook para pagamentos

### Melhorias Futuras

- [ ] Implementar aplicaÃ§Ã£o de efeitos de produtos
- [ ] Adicionar testes unitÃ¡rios
- [ ] Adicionar testes de integraÃ§Ã£o
- [ ] Implementar dashboard de pagamentos
- [ ] Adicionar relatÃ³rios de transaÃ§Ãµes

---

## ğŸ“š ReferÃªncias

- [PagueBit API Docs](https://docs.paguebit.com)
- [Respostas TÃ©cnicas Confirmadas](./PAGUEBIT_RESPONSES.md)
- [Plans & Products System](./PLANS_PRODUCTS.md)

---

**Ãšltima AtualizaÃ§Ã£o:** 05/01/2026 12:40  
**Autor:** Antigravity AI  
**VersÃ£o:** 1.0.0

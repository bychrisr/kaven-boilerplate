---
title: RBAC Middleware
description: Auto-migrated documentation
---

# RBAC Middleware - Guia de Uso

## üìã Vis√£o Geral

O **RBAC Middleware** (Role-Based Access Control) implementa controle de acesso baseado em roles com hierarquia de permiss√µes.

---

## üé≠ Roles Dispon√≠veis

### SUPER_ADMIN (N√≠vel 3)

- **Acesso total** a todos os tenants
- Pode gerenciar tenants (criar, atualizar, deletar)
- Pode gerenciar usu√°rios de qualquer tenant
- Bypass de restri√ß√µes de tenant

### TENANT_ADMIN (N√≠vel 2)

- **Acesso total** ao seu pr√≥prio tenant
- Pode gerenciar usu√°rios do seu tenant
- Pode visualizar e gerenciar recursos do tenant
- N√£o pode acessar outros tenants

### USER (N√≠vel 1)

- **Acesso limitado**
- Pode visualizar e atualizar apenas seus pr√≥prios dados
- N√£o pode gerenciar outros usu√°rios
- Acesso read-only a recursos compartilhados

---

## üîí Middlewares Dispon√≠veis

### 1. `authMiddleware`

Verifica JWT e injeta `request.user`

```typescript
import { authMiddleware } from '../middleware/auth.middleware';

fastify.get('/api/users/me', {
  preHandler: [authMiddleware],
  handler: userController.getCurrent,
});
```

### 2. `requireRole(allowedRoles)`

Requer uma das roles especificadas

```typescript
import { requireRole } from '../middleware/rbac.middleware';

fastify.get('/api/users', {
  preHandler: [authMiddleware, requireRole(['TENANT_ADMIN', 'SUPER_ADMIN'])],
  handler: userController.list,
});
```

### 3. `requireSuperAdmin`

Atalho para `requireRole(['SUPER_ADMIN'])`

```typescript
import { requireSuperAdmin } from '../middleware/rbac.middleware';

fastify.post('/api/tenants', {
  preHandler: [authMiddleware, requireSuperAdmin],
  handler: tenantController.create,
});
```

### 4. `requireTenantAdmin`

Atalho para `requireRole(['TENANT_ADMIN', 'SUPER_ADMIN'])`

```typescript
import { requireTenantAdmin } from '../middleware/rbac.middleware';

fastify.delete('/api/users/:id', {
  preHandler: [authMiddleware, requireTenantAdmin],
  handler: userController.delete,
});
```

### 5. `requireResourceOwnership(paramName)`

Verifica se usu√°rio pode acessar recurso espec√≠fico

```typescript
import { requireResourceOwnership } from '../middleware/rbac.middleware';

fastify.put('/api/users/:id', {
  preHandler: [authMiddleware, requireResourceOwnership('id')],
  handler: userController.update,
});
```

**Regras:**

- `SUPER_ADMIN`: pode acessar qualquer recurso
- `TENANT_ADMIN`: pode acessar recursos do seu tenant
- `USER`: s√≥ pode acessar seus pr√≥prios recursos

### 6. `requireTenantAccess`

Verifica se usu√°rio pode acessar tenant solicitado

```typescript
import { requireTenantAccess } from '../middleware/rbac.middleware';

fastify.get('/api/data', {
  preHandler: [authMiddleware, requireTenantAccess],
  handler: dataController.list,
});
```

---

## üìä Endpoints Protegidos

### Users (`/api/users`)

| Endpoint | M√©todo | Permiss√£o Requerida         |
| -------- | ------ | --------------------------- |
| `/`      | GET    | TENANT_ADMIN ou SUPER_ADMIN |
| `/me`    | GET    | Autenticado                 |
| `/:id`   | GET    | Owner ou TENANT_ADMIN       |
| `/`      | POST   | TENANT_ADMIN                |
| `/:id`   | PUT    | Owner ou TENANT_ADMIN       |
| `/:id`   | DELETE | TENANT_ADMIN                |

### Tenants (`/api/tenants`)

| Endpoint | M√©todo | Permiss√£o Requerida         |
| -------- | ------ | --------------------------- |
| `/`      | GET    | TENANT_ADMIN ou SUPER_ADMIN |
| `/:id`   | GET    | TENANT_ADMIN                |
| `/`      | POST   | SUPER_ADMIN                 |
| `/:id`   | PUT    | SUPER_ADMIN                 |
| `/:id`   | DELETE | SUPER_ADMIN                 |

### Observability & Audit (`/api`)

| Endpoint               | M√©todo | Permiss√£o Requerida         |
| ---------------------- | ------ | --------------------------- |
| `/observability/stats` | GET    | SUPER_ADMIN                 |
| `/audit-logs`          | GET    | SUPER_ADMIN ou TENANT_ADMIN |

---

## üß™ Testes

### 1. Login e Obter Token

```bash
# Login como USER
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'

# Resposta:
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "1234567890.abc123",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "role": "USER"
  }
}
```

### 2. Testar Acesso Negado (USER tentando listar usu√°rios)

```bash
curl -H "Authorization: Bearer <user-token>" \
  http://localhost:8000/api/users

# Resposta esperada: 403 Forbidden
{
  "error": "Acesso negado",
  "message": "Requer uma das roles: TENANT_ADMIN, SUPER_ADMIN",
  "userRole": "USER"
}
```

### 3. Testar Acesso Permitido (TENANT_ADMIN listando usu√°rios)

```bash
curl -H "Authorization: Bearer <admin-token>" \
  http://localhost:8000/api/users

# Resposta esperada: 200 OK
{
  "users": [...],
  "pagination": {...}
}
```

### 4. Testar Resource Ownership (USER acessando pr√≥prio perfil)

```bash
# Permitido: pr√≥prio ID
curl -H "Authorization: Bearer <user-token>" \
  http://localhost:8000/api/users/<own-user-id>

# Negado: ID de outro usu√°rio
curl -H "Authorization: Bearer <user-token>" \
  http://localhost:8000/api/users/<other-user-id>

# Resposta: 403 Forbidden
{
  "error": "Acesso negado",
  "message": "Voc√™ s√≥ pode acessar seus pr√≥prios dados"
}
```

---

## üîß Helpers Dispon√≠veis

```typescript
import {
  isSuperAdmin,
  isTenantAdmin,
  canManageUsers,
  canManageTenants,
} from '../middleware/rbac.middleware';

// Verificar role
if (isSuperAdmin(request.user)) {
  // L√≥gica para super admin
}

// Verificar permiss√£o
if (canManageUsers(request.user)) {
  // Pode gerenciar usu√°rios
}
```

---

## üìù Exemplo Completo

```typescript
import { FastifyInstance } from 'fastify';
import { authMiddleware } from '../middleware/auth.middleware';
import {
  requireSuperAdmin,
  requireTenantAdmin,
  requireResourceOwnership,
} from '../middleware/rbac.middleware';

export async function myRoutes(fastify: FastifyInstance) {
  // P√∫blico (sem auth)
  fastify.get('/public', publicHandler);

  // Autenticado (qualquer role)
  fastify.get('/me', {
    preHandler: [authMiddleware],
    handler: meHandler,
  });

  // Apenas TENANT_ADMIN ou superior
  fastify.get('/admin', {
    preHandler: [authMiddleware, requireTenantAdmin],
    handler: adminHandler,
  });

  // Apenas SUPER_ADMIN
  fastify.post('/super', {
    preHandler: [authMiddleware, requireSuperAdmin],
    handler: superHandler,
  });

  // Owner ou TENANT_ADMIN
  fastify.put('/:id', {
    preHandler: [authMiddleware, requireResourceOwnership('id')],
    handler: updateHandler,
  });
}
```

---

## ‚ö†Ô∏è Erros Comuns

### 401 Unauthorized

```json
{
  "error": "Token n√£o fornecido",
  "message": "Header Authorization com Bearer token √© obrigat√≥rio"
}
```

**Solu√ß√£o:** Adicionar header `Authorization: Bearer <token>`

### 403 Forbidden

```json
{
  "error": "Acesso negado",
  "message": "Requer uma das roles: TENANT_ADMIN, SUPER_ADMIN",
  "userRole": "USER"
}
```

**Solu√ß√£o:** Usu√°rio n√£o tem permiss√£o suficiente

### 401 Token Inv√°lido

```json
{
  "error": "Token inv√°lido",
  "message": "Token JWT inv√°lido ou expirado"
}
```

**Solu√ß√£o:** Fazer login novamente ou usar refresh token

---

## üöÄ Boas Pr√°ticas

1. **Sempre use `authMiddleware` primeiro** antes de RBAC middlewares
2. **Combine middlewares** para controle granular
3. **Use helpers** para l√≥gica condicional no c√≥digo
4. **Documente permiss√µes** de cada endpoint
5. **Teste com diferentes roles** durante desenvolvimento

---

**Vers√£o:** 1.0.0  
**√öltima atualiza√ß√£o:** 2025-12-19

---
title: Email Service
description: Auto-migrated documentation
---

# Email Service - Guia de Uso

## üìã Vis√£o Geral

O **Email Service** gerencia envio de emails transacionais usando Nodemailer com suporte a SMTP e modo desenvolvimento.

---

## ‚úâÔ∏è Emails Implementados

### 1. Welcome Email

Enviado automaticamente ap√≥s registro de novo usu√°rio.

**Trigger:** `POST /api/auth/register`

**Template:** Design responsivo com gradiente roxo, bot√£o CTA para dashboard.

### 2. Email Verification

Enviado para verificar endere√ßo de email do usu√°rio.

**Trigger:** `POST /api/auth/register` (planejado)

**Template:** Design responsivo com link de verifica√ß√£o, expira em 24h.

### 3. Password Reset

Enviado quando usu√°rio solicita reset de senha.

**Trigger:** `POST /api/auth/forgot-password`

**Template:** Design responsivo com gradiente rosa, link expira em 1h.

### 4. Invoice Notification

Enviado quando nova invoice √© gerada.

**Trigger:** Webhook Stripe ou cria√ß√£o manual

**Template:** Design responsivo com detalhes da invoice (n√∫mero, valor, vencimento).

---

## üîß Configura√ß√£o

### Vari√°veis de Ambiente

```env
# SMTP Configuration
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_SECURE="false"  # true para porta 465
SMTP_USER="your-email@gmail.com"
SMTP_PASS="your-app-password"
EMAIL_FROM="Kaven <noreply@kaven.com>"
FRONTEND_URL="http://localhost:3000"
```

### Gmail App Password

1. Ativar 2FA na conta Google
2. Ir em **Conta Google** ‚Üí **Seguran√ßa** ‚Üí **Senhas de app**
3. Gerar senha de app para "Mail"
4. Usar senha gerada em `SMTP_PASS`

### SendGrid (Alternativa)

```env
SMTP_HOST="smtp.sendgrid.net"
SMTP_PORT="587"
SMTP_USER="apikey"
SMTP_PASS="SG.your-api-key"
```

---

## üíª Uso no C√≥digo

### Importar Service

```typescript
import { emailService } from '../lib/email.service';
```

### Enviar Welcome Email

```typescript
await emailService.sendWelcomeEmail({
  email: 'user@example.com',
  name: 'John Doe',
});
```

### Enviar Verification Email

```typescript
const token = generateVerificationToken();
await emailService.sendVerificationEmail(
  { email: 'user@example.com', name: 'John Doe' },
  token,
);
```

### Enviar Password Reset

```typescript
const resetToken = generateResetToken();
await emailService.sendPasswordResetEmail(
  { email: 'user@example.com', name: 'John Doe' },
  resetToken,
);
```

### Enviar Invoice

```typescript
await emailService.sendInvoiceEmail(
  { email: 'user@example.com', name: 'John Doe' },
  {
    invoiceNumber: 'INV-001',
    amountDue: 99.9,
    dueDate: new Date('2025-01-15'),
  },
);
```

---

## üß™ Modo Desenvolvimento

Quando vari√°veis SMTP n√£o est√£o configuradas, o service entra em **modo desenvolvimento**:

- ‚úÖ N√£o envia emails reais
- ‚úÖ Loga informa√ß√µes no console
- ‚úÖ Usa `jsonTransport` do Nodemailer
- ‚úÖ Permite testar fluxo sem SMTP

**Exemplo de log:**

```
‚ö†Ô∏è  Email service n√£o configurado. Emails n√£o ser√£o enviados.
üìß [DEV] Email que seria enviado: {
  to: 'user@example.com',
  subject: 'Bem-vindo ao Kaven!',
  messageId: '<abc123@nodemailer.com>'
}
```

---

## üé® Templates HTML

Todos os templates s√£o:

- ‚úÖ **Responsivos** (mobile-first)
- ‚úÖ **Inline CSS** (compatibilidade com email clients)
- ‚úÖ **Gradientes modernos**
- ‚úÖ **Bot√µes CTA destacados**
- ‚úÖ **Footer com branding**

### Estrutura Padr√£o

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body style="background-color: #f4f4f4;">
    <table width="600" style="background-color: #ffffff;">
      <!-- Header com gradiente -->
      <tr>
        <td style="background: linear-gradient(...)">...</td>
      </tr>

      <!-- Body com conte√∫do -->
      <tr>
        <td style="padding: 40px;">...</td>
      </tr>

      <!-- Footer -->
      <tr>
        <td style="background-color: #f8f9fa;">...</td>
      </tr>
    </table>
  </body>
</html>
```

---

## üß™ Testes

### 1. Testar Registro (Welcome Email)

```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test123!",
    "name": "Test User"
  }'

# Verificar logs do servidor para email
```

### 2. Testar Password Reset

```bash
curl -X POST http://localhost:8000/api/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'

# Verificar logs do servidor
```

### 3. Testar com SMTP Real

1. Configurar vari√°veis SMTP no `.env`
2. Reiniciar servidor
3. Fazer requisi√ß√£o de registro
4. Verificar inbox do email

---

## üìä Integra√ß√£o Atual

| Endpoint                         | Email Enviado  | Status          |
| -------------------------------- | -------------- | --------------- |
| `POST /api/auth/register`        | Welcome Email  | ‚úÖ Implementado |
| `POST /api/auth/forgot-password` | Password Reset | ‚úÖ Implementado |
| `POST /api/auth/verify-email`    | Verification   | üöß Planejado    |
| Webhook Stripe                   | Invoice        | üöß Planejado    |

---

## üöÄ Pr√≥ximas Melhorias

- [ ] Queue system (BullMQ) para emails ass√≠ncronos
- [ ] Retry autom√°tico em caso de falha
- [ ] Templates customiz√°veis por tenant
- [ ] Tracking de emails (open rate, click rate)
- [ ] Suporte a anexos
- [ ] Emails em m√∫ltiplos idiomas
- [ ] Preview de emails antes de enviar

---

## ‚ö†Ô∏è Troubleshooting

### Email n√£o est√° sendo enviado

1. Verificar vari√°veis SMTP no `.env`
2. Verificar logs do servidor
3. Testar credenciais SMTP manualmente
4. Verificar firewall/porta bloqueada

### Gmail bloqueando emails

1. Usar senha de app (n√£o senha normal)
2. Ativar "Acesso a apps menos seguros" (n√£o recomendado)
3. Usar SendGrid ou outro provedor

### Templates n√£o renderizando

1. Verificar HTML inline CSS
2. Testar em https://litmus.com ou https://emailonacid.com
3. Usar tabelas ao inv√©s de divs

---

## üìù Exemplo Completo

```typescript
import { emailService } from './lib/email.service';

// Ap√≥s criar usu√°rio
const user = await prisma.user.create({
  data: { email, password, name },
});

// Enviar welcome email
await emailService.sendWelcomeEmail(user);

// Gerar token de verifica√ß√£o
const verificationToken = crypto.randomBytes(32).toString('hex');

// Salvar token no banco
await prisma.emailVerificationToken.create({
  data: {
    token: verificationToken,
    userId: user.id,
    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24h
  },
});

// Enviar email de verifica√ß√£o
await emailService.sendVerificationEmail(user, verificationToken);
```

---

**Vers√£o:** 1.0.0  
**√öltima atualiza√ß√£o:** 2025-12-19

---
updated: 2026-01-22T04:05:00
version: 1.0.0
status: Unified Spec + Implementation Guide
priority: CRITICAL (DX + Modularidade)
---

# üîß KAVEN CLI ‚Äî SISTEMA DE M√ìDULOS
## Especifica√ß√£o T√©cnica + Guia Completo de Implementa√ß√£o (Unificado)

**Vers√£o:** 1.0.0  
**Data:** Janeiro 2026  
**Status:** Documento unificado e ‚Äúsource-of-truth‚Äù do sistema de m√≥dulos  
**Escopo:** CLI + Boilerplate (monorepo) + M√≥dulos opcionais + Split-Schema Prisma  

**Este documento √© um merge e ‚Äúfinaliza√ß√£o‚Äù de:**
- `1. Claude CLI Modules System - Techinical Specifications.md` (incompleto)
- `2. CLI Module System - Implementation Guide.md` (incompleto no final)

**E foi corrigido/alinhado com o projeto real (contexto analisado):**
- `/home/bychrisr/projects/kaven-boilerplate/` (estrutura, anchors e implementa√ß√£o atual do CLI)

> [!IMPORTANT]
> Este documento tem **2 camadas**:
>
> 1) **‚ÄúComo est√° hoje‚Äù (AS-IS)**: descreve o que existe no boilerplate atual (arquivos/anchors/classes/fluxos).  
> 2) **‚ÄúComo deve ficar‚Äù (TO-BE)**: especifica uma arquitetura mais robusta (manifest por m√≥dulo, idempot√™ncia forte, registry, deps, schema por m√≥dulo, update etc), **sem pedir para implementar agora**.

---

## üìå TL;DR (O que √© o Module System do Kaven)

O **Sistema de M√≥dulos do Kaven CLI** √© um mecanismo de **automa√ß√£o de scaffolding + inje√ß√£o de c√≥digo-fonte (compile-time)** que:

1) Copia arquivos do m√≥dulo (backend e/ou frontend) de um **cat√°logo/store** para o projeto.  
2) Faz ‚Äúwiring‚Äù automaticamente (imports/registrations/hooks/startup) em **anchors** pr√©-definidos.  
3) Atualiza `kaven.config.json` para rastrear o estado do m√≥dulo (instalado/removido).  
4) Integra com o banco via **Split-Schema Prisma**: `schema.base.prisma` + `schema.extended.prisma` ‚Üí `schema.prisma` (gerado).

**N√£o √©** plugin runtime, n√£o √© feature flag, n√£o √© package manager.

---

## üìö Como usar este documento

- Se voc√™ quer **entender o sistema**: leia a Parte I e a Parte II.  
- Se voc√™ quer **especificar m√≥dulos/infra de m√≥dulos**: foque na Parte III (TO-BE).  
- Se voc√™ quer **criar um novo m√≥dulo**: v√° direto para a Parte IV (workflows + checklist).  
- Se voc√™ quer **debug/troubleshooting**: Parte V.
- Se voc√™ quer **ver o invent√°rio real de m√≥dulos (engenharia + add-ons)**: `feat-modules/index-modules.pt.md`.
- Se voc√™ quer **ver a vis√£o de vendas/roadmap (feature matrix)**: `feat-modules/feature-matrix.en.md` (inclui ‚ÄúRepository Reality Check‚Äù).
- Se voc√™ quer **Auth + Marketplace (Paddle/licen√ßas/downloads)**: `4. Kaven CLI Auth + Marketplace - Unified Spec + Implementation Guide.md`.

---

## üìã √çNDICE (alto n√≠vel)

**Parte I ‚Äî Vis√£o e Princ√≠pios**
1. [O que √© (e o que n√£o √©)](#1-o-que-√©-e-o-que-n√£o-√©)
2. [Objetivos, n√£o-objetivos e invariantes](#2-objetivos-n√£o-objetivos-e-invariantes)
3. [Padr√µes arquiteturais do sistema](#3-padr√µes-arquiteturais-do-sistema)
4. [Gloss√°rio e terminologia](#4-gloss√°rio-e-terminologia)

**Parte II ‚Äî AS-IS (boilerplate real)**
5. [Arquitetura do monorepo (boilerplate)](#5-arquitetura-do-monorepo-boilerplate)
6. [Estado e configura√ß√£o (kaven.config.json)](#6-estado-e-configura√ß√£o-kavenconfigjson)
7. [CLI (entrypoints, comandos e UX)](#7-cli-entrypoints-comandos-e-ux)
8. [Cat√°logo/Store de m√≥dulos (AS-IS)](#8-cat√°logostore-de-m√≥dulos-as-is)
9. [Anchors oficiais e injection points](#9-anchors-oficiais-e-injection-points)
10. [ModuleManager (AS-IS): add/remove/list e injection](#10-modulemanager-as-is-addremovelist-e-injection)
11. [SchemaManager (AS-IS): split-schema merge](#11-schemamanager-as-is-split-schema-merge)
12. [Limita√ß√µes conhecidas do AS-IS](#12-limita√ß√µes-conhecidas-do-as-is)

**Parte III ‚Äî TO-BE (spec robusta)**
13. [Modelo de m√≥dulo (manifest) ‚Äî m√≥dulo.json](#13-modelo-de-m√≥dulo-manifest--m√≥dulojson)
14. [Engine de inje√ß√£o (spec): idempot√™ncia, revers√£o, markers](#14-engine-de-inje√ß√£o-spec-idempot√™ncia-revers√£o-markers)
15. [Schema por m√≥dulo + migrations (spec)](#15-schema-por-m√≥dulo--migrations-spec)
16. [Dependencies (spec): core + npm/pnpm + peer deps](#16-dependencies-spec-core--npmpnpm--peer-deps)
17. [Update/upgrade de m√≥dulos (spec)](#17-updateupgrade-de-m√≥dulos-spec)
18. [Seguran√ßa e rollback (spec)](#18-seguran√ßa-e-rollback-spec)

**Parte IV ‚Äî Workflows**
19. [Fluxos do desenvolvedor (instalar/remover/atualizar)](#19-fluxos-do-desenvolvedor-instalarremoveratualizar)
20. [Como criar um m√≥dulo novo (guia completo)](#20-como-criar-um-m√≥dulo-novo-guia-completo)
21. [Como adicionar um novo anchor ao core (guia)](#21-como-adicionar-um-novo-anchor-ao-core-guia)

**Parte V ‚Äî Testes, Troubleshooting e Ap√™ndices**
22. [Estrat√©gia de testes (unit/integration/e2e)](#22-estrat√©gia-de-testes-unitintegratione2e)
23. [Troubleshooting e playbook de debug](#23-troubleshooting-e-playbook-de-debug)
24. [Ap√™ndices (tabelas, templates, checklists)](#24-ap√™ndices-tabelas-templates-checklists)

---

# Parte I ‚Äî Vis√£o e Princ√≠pios

# 1. O QUE √â (E O QUE N√ÉO √â)

## 1.1 ‚úÖ O que √©

### Sistema de scaffolding + wiring

O m√≥dulo √© uma **fatia vertical** (feature) que pode incluir:
- backend (rotas, controllers, services, jobs, queues),
- frontend (p√°ginas, componentes, hooks),
- banco (schema extension + migrations),
- integra√ß√µes e env vars (Stripe, Sentry, etc),
- wiring no core (imports, register routes, hooks).

O CLI executa o wiring **automaticamente**, sempre via um contrato est√°vel (anchors + manifest).

### Compile-time (n√£o runtime)

O sistema funciona como **gerador/transformador de c√≥digo fonte**:

1) copia arquivos ‚Üí 2) injeta trechos em arquivos core ‚Üí 3) atualiza config ‚Üí 4) roda ‚Äútasks‚Äù p√≥s-instala√ß√£o.

N√£o existe ‚Äúcarregar m√≥dulo dinamicamente‚Äù em runtime como plugin.

## 1.2 ‚ùå O que n√£o √©

### N√£o √© plugin runtime

Voc√™ **n√£o** habilita com algo assim:

```ts
// N√ÉO √â ASSIM
if (isModuleEnabled('payments')) {
  loadModule('payments')
}
```

### N√£o √© feature flag

Voc√™ **n√£o** alterna comportamento em runtime:

```ts
// N√ÉO √â ASSIM
if (featureFlags.get('crm')) {
  renderCRM()
}
```

### N√£o √© um package manager

Voc√™ **n√£o** resolve o ecossistema via:

```bash
npm install @kaven/module-payments
```

> Nota: No TO-BE pode haver integra√ß√£o com um registry, mas a UX principal continua sendo `kaven module add`.

---

# 2. OBJETIVOS, N√ÉO-OBJETIVOS E INVARIANTES

## 2.1 Objetivos (goals)

1) **Velocidade:** instalar/remover em segundos, sem ‚Äúcolagem manual‚Äù.  
2) **Consist√™ncia:** m√≥dulos seguem um padr√£o (estrutura/rotas/env/schema).  
3) **Reversibilidade:** `remove` volta o projeto ao estado anterior (ou ao menos ‚Äúlean + compil√°vel‚Äù).  
4) **Seguran√ßa de dados:** remo√ß√£o **n√£o apaga dados** automaticamente.  
5) **Atualiza√ß√£o segura do core:** Split-Schema para evitar conflitos em updates do boilerplate.  
6) **Idempot√™ncia pr√°tica:** reexecutar `add`/`remove` n√£o deve quebrar o projeto.

## 2.2 N√£o-objetivos (non-goals)

- N√£o √© um sistema de ‚Äútoggle em runtime‚Äù (isso √© feature flag).  
- N√£o √© um marketplace completo (a spec de Auth + Marketplace est√° separada em `4. Kaven CLI Auth + Marketplace - Unified Spec + Implementation Guide.md`).  
- N√£o garante ‚Äúzero conflitos‚Äù se o dev editar manualmente os trechos injetados (podemos mitigar, mas n√£o d√° para prometer).  
- N√£o ‚Äúresolve tudo‚Äù de DB automaticamente (migrations destrutivas continuam manuais).

## 2.3 Invariantes (contratos que n√£o podem quebrar)

### Invariantes do Core

- Anchors devem existir e ser est√°veis nos arquivos core.  
- O core deve continuar compil√°vel mesmo sem m√≥dulos opcionais.

### Invariantes do CLI

- `add` deve ser transacional (ou ter rollback/backup claro).  
- `remove` deve ser safety-first (sem deletar dados).  
- Opera√ß√µes devem ser determin√≠sticas e reprodut√≠veis.

### Invariantes de Schema

- `schema.base.prisma` √© ‚Äúread-only‚Äù para o dev.  
- `schema.extended.prisma` √© o ‚Äúplayground‚Äù do dev.  
- `schema.prisma` √© gerado e n√£o edit√°vel.

---

# 3. PADR√ïES ARQUITETURAIS DO SISTEMA

## 3.1 Padr√£o: ‚ÄúSource Injection via Anchors‚Äù

O core exp√µe ‚Äúslots‚Äù (anchors) e o CLI injeta c√≥digo nesses slots.

Por que isso funciona:
- anchors mudam pouco,
- injection √© determin√≠stica,
- remove pode ser sim√©trico (eject).

## 3.2 Padr√£o: ‚ÄúScaffold-first, then wire‚Äù

Ordem segura:
1) valida√ß√µes  
2) copy files  
3) injection  
4) config update  
5) schema tasks (generate/migrate)  
6) p√≥s-instala√ß√£o

## 3.3 Padr√£o: Split-Schema Prisma

O core do DB evolui via `schema.base.prisma` (Kaven) sem sobrescrever customiza√ß√µes do dev (`schema.extended.prisma`).

O merge gera `schema.prisma` para o Prisma Client.

## 3.4 Padr√£o: ‚ÄúNever delete data automatically‚Äù

Remover m√≥dulo:
- remove c√≥digo + rotas + UI,
- atualiza config,
- **n√£o** remove tabelas automaticamente.

Se quiser apagar tabelas/dados: o dev cria migration manual explicitamente.

## 3.5 Padr√£o: ‚ÄúIdempot√™ncia por markers‚Äù (TO-BE)

O TO-BE recomenda que toda inje√ß√£o seja envolvida por markers por m√≥dulo, ex:

```ts
// [KAVEN_MODULE:observability:START]
// ... injected ...
// [KAVEN_MODULE:observability:END]
```

Isso torna `remove` muito mais confi√°vel do que ‚Äúregex em linhas soltas‚Äù.

---

# 4. GLOSS√ÅRIO E TERMINOLOGIA

- **Module**: feature opcional (vertical slice) gerenciada via CLI.  
- **Core Module**: parte do boilerplate, sempre presente, n√£o remov√≠vel.  
- **Store/Catalog**: fonte de arquivos dos m√≥dulos (local ou remoto).  
- **Anchor**: coment√°rio ‚Äúslot‚Äù no core onde o CLI injeta c√≥digo.  
- **Injection**: inserir c√≥digo nos anchors/targets.  
- **Ejection**: remover o c√≥digo injetado (reverse operation).  
- **Idempot√™ncia**: rodar `add` duas vezes n√£o duplica/estraga; rodar `remove` duas vezes n√£o quebra.  
- **Split-Schema**: base + extended ‚Üí schema gerado para uso pelo Prisma.  
- **Manifest**: metadados do m√≥dulo (TO-BE), descreve c√≥pias, injections, deps, env, schema etc.

---

# Parte II ‚Äî AS-IS (boilerplate real)

# 5. ARQUITETURA DO MONOREPO (BOILERPLATE)

Esta se√ß√£o descreve a estrutura **como ela existe hoje** no boilerplate em:

`/home/bychrisr/projects/kaven-boilerplate/`

## 5.1 Estrutura (vis√£o geral)

```
kaven-boilerplate/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api/                          # Backend (Fastify)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ app.ts                # Injection point (imports/hooks/routes)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ server.ts             # Injection point (startup)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ modules/              # M√≥dulos do backend (core + opcionais)
‚îÇ   ‚îî‚îÄ‚îÄ admin/                        # Frontend (Next.js)
‚îÇ       ‚îî‚îÄ‚îÄ app/[locale]/(dashboard)/ # UI ‚Äúdashboard routes‚Äù
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ       ‚îî‚îÄ‚îÄ prisma/
‚îÇ           ‚îú‚îÄ‚îÄ schema.base.prisma
‚îÇ           ‚îú‚îÄ‚îÄ schema.extended.prisma
‚îÇ           ‚îî‚îÄ‚îÄ schema.prisma         # gerado
‚îú‚îÄ‚îÄ kaven-cli/                        # CLI (TypeScript ESM)
‚îÇ   ‚îú‚îÄ‚îÄ modules/                      # store local de m√≥dulos (AS-IS)
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ core/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ module-manager.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ schema-manager.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ project-initializer.ts
‚îÇ       ‚îú‚îÄ‚îÄ commands/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ module.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ db.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ update.ts
‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îî‚îÄ‚îÄ kaven.config.json                 # estado/telemetria de m√≥dulos e features
```

## 5.2 Package manager e scripts

O root `package.json` define `packageManager: pnpm@9.15.4` e scripts relevantes:

- `pnpm db:generate` ‚Üí roda `kaven db generate` e depois `prisma generate` apontando para `packages/database/prisma/schema.prisma`.
- `pnpm db:migrate` ‚Üí `prisma migrate dev` (manual e expl√≠cito).

> [!NOTE]
> O CLI, quando rodado via source, costuma ser executado como:
> `npx tsx kaven-cli/src/index.ts ...`

## 5.3 Invent√°rio r√°pido (AS-IS)

Esta se√ß√£o existe para alinhar a documenta√ß√£o com a realidade do boilerplate atual.

> Para um cat√°logo completo (engineering + add-ons), veja: `feat-modules/index-modules.pt.md`.  
> Para vis√£o de vendas (feature matrix + tiers + roadmap), veja: `feat-modules/feature-matrix.en.md` (com notas de realidade do c√≥digo).

### Backend (m√≥dulos presentes em `apps/api/src/modules`)

```
app, audit, auth, currencies, dashboard, export, files, grants, invoices, notifications,
observability, orders, plans, platform, policies, products, roles, security, spaces,
subscriptions, tenants, users, webhooks
```

### UI ‚Äî Admin (m√≥dulos/p√°ginas em `apps/admin/app/[locale]/(dashboard)`)

```
access-requests, approvals, audit-logs, currencies, dashboard/*, features, invites, observability,
plans, policies, pricing, products, roles, saas-settings, security, settings, spaces, tenants, users
```

### UI ‚Äî Tenant (m√≥dulos/p√°ginas em `apps/tenant/app/[locale]/(dashboard)`)

```
dashboard/*, features, invites, plans, pricing, products, projects, settings, team
```

### Banco (Split-Schema)

- `schema.base.prisma`: cont√©m a plataforma core (multi-tenancy, spaces, RBAC/policies, billing, email, notifications, etc).  
- `schema.extended.prisma`: cont√©m **demo features** (`Project`/`Task`) ‚Äî exemplo de customiza√ß√£o do app do cliente.

### Store de m√≥dulos (CLI)

Store local no boilerplate atual:

```
kaven-cli/modules/observability
kaven-cli/modules/payments
```

> Observa√ß√£o: no repo atual, `observability` est√° instalado no core, enquanto `payments` existe no store mas est√° marcado como `false` no `kaven.config.json`.
>
> Nota: o comando `kaven module list` tamb√©m menciona `ai-assistant` e `analytics` como ‚Äúcoming soon‚Äù, mas eles **n√£o** existem como diret√≥rios em `kaven-cli/modules/` no repo atual (placeholders).

---

# 6. ESTADO E CONFIGURA√á√ÉO (kaven.config.json)

## 6.1 O papel do kaven.config.json

`kaven.config.json` √© o ‚Äúsingle source of truth‚Äù do estado do projeto:
- vers√£o do Kaven
- features de instala√ß√£o (database, multiTenant, payment)
- m√≥dulos core vs opcionais
- hist√≥rico de customiza√ß√µes (addedModules / removedModules)

## 6.2 Estrutura (AS-IS)

Exemplo real (abreviado):

```json
{
  "name": "kaven-boilerplate",
  "version": "1.0.0",
  "kaven": {
    "version": "2.0.0",
    "features": {
      "multiTenant": true,
      "database": "postgresql",
      "payment": "pix"
    },
    "modules": {
      "core": {
        "auth": true,
        "users": true,
        "tenants": true
      },
      "optional": {
        "payments": false,
        "observability": true,
        "analytics": false,
        "ai-assistant": false,
        "notifications": false
      }
    },
    "customizations": {
      "addedModules": ["observability"],
      "removedModules": ["payments"]
    }
  }
}
```

## 6.3 Observa√ß√£o importante: drift de nomes

O c√≥digo do `ProjectInitializer` (create-kaven-app) usa nomes como:
- `payments-stripe`, `payments-mercadopago`, `ai-assistant`, etc.

J√° o `ModuleManager` no boilerplate atual trabalha com:
- `payments` e `observability` (e placeholders para `ai-assistant`/`analytics`).

Ou seja: existe **drift de nomenclatura** no AS-IS.

Este documento define o TO-BE para normalizar isso via manifest + cat√°logo.

## 6.4 Drift de config vs ‚Äúrealidade do c√≥digo‚Äù

Al√©m do drift de nomes, existe drift entre:

- **Template de config do CLI**: `kaven-cli/templates/kaven.config.json`
  - traz chaves como `payments-stripe` e `payments-mercadopago`.
- **Config do repo atual**: `kaven.config.json`
  - usa chaves como `payments` e `observability`.

E existe tamb√©m um ponto importante de modelagem:

- O fato de um m√≥dulo estar listado como `optional: false` **n√£o implica** que ele n√£o exista no c√≥digo.  
  Exemplo: o repo atual possui o m√≥dulo `notifications` em `apps/api/src/modules/notifications` e ele est√° registrado em `apps/api/src/app.ts`, mesmo que o config possa marcar `notifications: false`.

**Conclus√£o (AS-IS):** hoje o `kaven.config.json` funciona mais como ‚Äúestado/telemetria‚Äù do que como a fonte definitiva para *gating f√≠sico* (copiar/remover arquivos) do monorepo.

---

# 7. CLI (entrypoints, comandos e UX)

## 7.1 Entrypoint e registro de comandos (AS-IS)

No boilerplate, a CLI em TypeScript registra comandos em:
- `kaven-cli/src/index.ts`

Comandos registrados:
- `kaven update` (placeholder)
- `kaven module add/remove/list`
- `kaven db generate`

> [!NOTE]
> O bin execut√°vel `kaven-cli/bin/kaven.js` aponta para `kaven-cli/dist/index.js` (build).

## 7.2 UX (logging/spinner)

O CLI usa:
- `ora` para spinner
- `chalk` para cores
- um helper `Logger` (`kaven-cli/src/lib/logger.ts`) com:
  - `startSpinner`, `succeedSpinner`, `failSpinner`
  - `box(title, lines)` para output em ‚Äúcaixa‚Äù

---

# 8. CAT√ÅLOGO/STORE DE M√ìDULOS (AS-IS)

## 8.1 O que √© o store local hoje

No boilerplate atual, os m√≥dulos ‚Äúinstal√°veis‚Äù vivem dentro do pr√≥prio repo em:

`kaven-cli/modules/<moduleName>/`

Exemplos presentes:
- `kaven-cli/modules/observability/`
- `kaven-cli/modules/payments/` (apesar de n√£o estar instalado no projeto-alvo)

## 8.2 Estrutura de pastas do store (AS-IS)

Cada m√≥dulo hoje tem, no m√≠nimo:

```
kaven-cli/modules/<moduleName>/
‚îú‚îÄ‚îÄ api/      # backend (Fastify)
‚îî‚îÄ‚îÄ admin/    # frontend (Next.js App Router)
```

> [!IMPORTANT]
> No AS-IS **n√£o existe** `module.json` no store.  
> A configura√ß√£o de injection est√° hardcoded em `kaven-cli/src/core/module-manager.ts`.

## 8.3 C√≥pia para o projeto (targets AS-IS)

O `ModuleManager` copia:

- API:
  - src: `kaven-cli/modules/<name>/api`
  - dst: `apps/api/src/modules/<name>`

- Admin:
  - src: `kaven-cli/modules/<name>/admin`
  - dst: `apps/admin/app/[locale]/(dashboard)/<name>`

> [!NOTE]
> A estrutura do admin no store deve ser compat√≠vel com o destino.  
> Exemplo: `observability/admin/page.tsx` ao copiar vira `.../(dashboard)/observability/page.tsx` e funciona.  
> J√° `payments/admin/orders/page.tsx` vira `.../(dashboard)/payments/orders/page.tsx` (rotas sob `/payments/...`).

## 8.4 ‚ÄúM√≥dulo instal√°vel‚Äù vs ‚Äúm√≥dulo de plataforma‚Äù

No monorepo, existem dois conceitos que hoje se misturam por nomenclatura:

1) **M√≥dulos de plataforma (core do app)**  
   - vivem em `apps/api/src/modules/*` e fazem parte do backend do boilerplate.  
   - muitos deles s√£o ‚ÄúCORE‚Äù (sempre presentes) e **n√£o** s√£o gerenciados por `kaven module add/remove` no AS-IS.

2) **M√≥dulos instal√°veis via CLI (store)**  
   - vivem em `kaven-cli/modules/*` e s√£o ‚Äútemplates‚Äù que podem ser copiados/injetados no projeto.

No AS-IS, o store cont√©m:

- `observability` (ADD-ON, instalado no repo atual)
  - API: m√©tricas/diagn√≥sticos/monitoramento
  - Admin UI: `/observability`

- `payments` (ADD-ON, existe no store mas **n√£o** est√° instalado no repo atual)
  - inclui endpoints de Stripe (subscriptions/portal/webhook) e flows PIX/PagueBit (QR code + webhook validation)
  - env vars no c√≥digo do store: `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `PAGUEBIT_API_TOKEN`, `PAGUEBIT_WEBHOOK_SECRET`
  - nota de realidade: `PixService` √© simulado; a integra√ß√£o ‚Äúreal‚Äù de PIX no store √© via provider PagueBit (QR code din√¢mico + HMAC webhooks)
  - Admin UI no store existe (p√°ginas sob `/payments/...`)
  - recomenda√ß√£o TO-BE (marketplace): separar providers em m√≥dulos (`payments-stripe`, `payments-paguebit`, etc) e manter o ‚ÄúBilling Core‚Äù (plans/products/subscriptions/invoices/orders) como CORE ‚Äî ver `feat-modules/index-modules.pt.md`

Para ‚Äúcatalogar‚Äù e empacotar (vendas/add-ons), use o cat√°logo em:

- `feat-modules/index-modules.pt.md`

---

# 9. ANCHORS OFICIAIS E INJECTION POINTS

## 9.1 Conceito (AS-IS)

O core do backend exp√µe anchors em coment√°rios. O CLI injeta conte√∫do substituindo o anchor por:

`<snippet>\n<anchor>`

Isso preserva o anchor para futuras inje√ß√µes.

## 9.2 Anchors em `apps/api/src/app.ts`

Anchors encontrados no arquivo real:

```ts
// [KAVEN_MODULE_IMPORTS]
// [KAVEN_MODULE_HOOKS]
// [KAVEN_MODULE_REGISTRATION]
```

Tamb√©m existem ‚Äúwrappers‚Äù (start/end) no arquivo, √∫teis como contrato humano:

```ts
// [KAVEN_MODULE_IMPORTS_START]
// [KAVEN_MODULE_IMPORTS_END]

// [KAVEN_MODULE_REGISTRATION_START]
// [KAVEN_MODULE_REGISTRATION_END]

// [KAVEN_MODULE_HOOKS_END]
```

> [!IMPORTANT]
> O `ModuleManager` atual usa apenas os anchors ‚Äúcentrais‚Äù (`IMPORTS`, `HOOKS`, `REGISTRATION`) ‚Äî n√£o usa START/END.

## 9.3 Anchors em `apps/api/src/server.ts`

Anchors encontrados no arquivo real:

```ts
// [KAVEN_SERVER_IMPORTS]
// [KAVEN_SERVER_STARTUP]
```

E tamb√©m wrappers:

```ts
// [KAVEN_SERVER_IMPORTS_END]
// [KAVEN_SERVER_STARTUP_END]
```

## 9.4 Cross-file injection (caso especial AS-IS)

O `ModuleManager` atual injeta (observability) em:

`apps/api/src/modules/auth/controllers/auth.controller.ts`

Sem anchor dedicado ‚Äî via string replace em trechos espec√≠ficos.

> [!CAUTION]
> Isso √© funcional, mas fr√°gil: se o AuthController mudar, a inje√ß√£o pode falhar silenciosamente ou inserir em lugar errado.

---

# 10. ModuleManager (AS-IS): add/remove/list e injection

## 10.1 Onde est√° e qual a responsabilidade

Arquivo: `kaven-cli/src/core/module-manager.ts`

Responsabilidades:
- valida√ß√£o de m√≥dulo (`isValidModule`)
- copy files (api/admin)
- injection/ejection em core files (`app.ts`, `server.ts`, e auth controller)
- update do `kaven.config.json`
- listagem de m√≥dulos

## 10.2 Fonte de verdade do injection (AS-IS)

No AS-IS, o ‚Äúmanifest‚Äù est√° hardcoded num objeto `injections`:

- `payments`
  - `appImports`
  - `appRegistration`
- `observability`
  - `appImports`, `appHooks`, `appRegistration`
  - `serverImports`, `serverStartup`
  - `authControllerInjections` (import + tracking)

### Exemplo (observability) ‚Äî tipos de inje√ß√£o

O m√≥dulo observability injeta:
- imports + hooks + registration no `app.ts`
- imports + startup no `server.ts`
- tracking no `auth.controller.ts`

Isso explica por que ele √© o m√≥dulo mais ‚Äúcomplexo‚Äù hoje.

## 10.3 Fluxo `kaven module add <name>` (AS-IS)

### Passo 0: contexto

O `ModuleManager` usa `projectRoot = process.cwd()` ‚Äî voc√™ deve rodar o comando na raiz do monorepo.

### Passo 1: validar

- `isValidModule(name)` retorna true para: `payments`, `observability`, `ai-assistant`, `analytics`.
- Se inv√°lido: erro.

> [!NOTE]
> No AS-IS, apenas `payments` e `observability` possuem m√≥dulo no store (`kaven-cli/modules/*`) e wiring (`this.injections[...]`).  
> `ai-assistant` e `analytics` s√£o placeholders (‚Äúcoming soon‚Äù): `module add` tende a **apenas** atualizar o `kaven.config.json` (sem copiar/injetar arquivos).

### Passo 2: ler config

- l√™ `kaven.config.json` via `fsUtils.readKavenConfig(projectRoot)`.

### Passo 3: copiar arquivos

- se existir `kaven-cli/modules/<name>/api`: copia para `apps/api/src/modules/<name>`
- se existir `kaven-cli/modules/<name>/admin`: copia para `apps/admin/app/[locale]/(dashboard)/<name>`

### Passo 4: injectRoutes(name)

O m√©todo injeta em:
- `apps/api/src/app.ts`
- `apps/api/src/server.ts`
- e possivelmente em `auth.controller.ts`

O mecanismo de ‚Äún√£o duplicar‚Äù √© baseado em `content.includes(snippet)`.

### Passo 5: updateConfig

- `config.kaven.modules.optional[name] = true`
- adiciona em `kaven.customizations.addedModules`
- remove de `removedModules` se existir

## 10.4 Fluxo `kaven module remove <name>` (AS-IS)

### Passo 1: validar se est√° instalado

- confere `kaven.modules.optional[name]`
- se n√£o instalado: warning e return

### Passo 2: remover diret√≥rios

- remove `apps/api/src/modules/<name>`
- remove `apps/admin/app/[locale]/(dashboard)/<name>`

### Passo 3: ejectRoutes(name)

- remove strings conhecidas via regex global
- no caso observability, tem tratamento especial no AuthController

### Passo 4: updateConfig

- `config.kaven.modules.optional[name] = false`
- adiciona em `removedModules`
- remove de `addedModules`

## 10.5 Fluxo `kaven module list` (AS-IS)

O `listModules()` imprime:
- m√≥dulos instalados (lendo o config)
- m√≥dulos dispon√≠veis (hardcoded)

## 10.6 Exemplo real: como a inje√ß√£o acontece em `app.ts` (AS-IS)

### O ‚Äúslot‚Äù no core

O backend exp√µe slots como:

```ts
// [KAVEN_MODULE_IMPORTS]
// [KAVEN_MODULE_HOOKS]
// [KAVEN_MODULE_REGISTRATION]
```

### A regra de inje√ß√£o (padr√£o atual)

O `ModuleManager` injeta usando o padr√£o:

```ts
content = content.replace(
  '// [KAVEN_MODULE_IMPORTS]',
  `${importsToInject}\n// [KAVEN_MODULE_IMPORTS]`
);
```

Isso significa:
- o snippet entra **antes** do anchor,
- o anchor continua existindo para pr√≥ximas inje√ß√µes,
- a engine assume que o anchor existe exatamente com essa string.

### Implica√ß√£o pr√°tica

Se algu√©m renomear o anchor (ex: trocar `KAVEN_MODULE_IMPORTS` por `KAVEN_IMPORTS`), o CLI vai:
- falhar em injetar (ou pior: n√£o alterar nada sem erro claro, dependendo da implementa√ß√£o).

## 10.7 Pseudo-c√≥digo do `injectRoutes()` (AS-IS)

> Objetivo: documentar o algoritmo sem depender da leitura do TypeScript inteiro.

```ts
function injectRoutes(moduleName):
  appTsPath = <projectRoot>/apps/api/src/app.ts
  serverTsPath = <projectRoot>/apps/api/src/server.ts
  authControllerPath = <projectRoot>/apps/api/src/modules/auth/controllers/auth.controller.ts

  appContent = read(appTsPath)
  serverContent = read(serverTsPath)

  injection = injections[moduleName]
  if (!injection) return

  // 1) app.ts
  if (injection.appImports && !appContent.includes(injection.appImports)):
    appContent = replace(appContent, '// [KAVEN_MODULE_IMPORTS]', injection.appImports + '\n' + '// [KAVEN_MODULE_IMPORTS]')

  if (injection.appHooks && !appContent.includes(injection.appHooks)):
    appContent = replace(appContent, '// [KAVEN_MODULE_HOOKS]', injection.appHooks + '\n' + '// [KAVEN_MODULE_HOOKS]')

  if (injection.appRegistration && !appContent.includes(injection.appRegistration)):
    appContent = replace(appContent, '// [KAVEN_MODULE_REGISTRATION]', injection.appRegistration + '\n' + '// [KAVEN_MODULE_REGISTRATION]')

  // 2) server.ts
  if (injection.serverImports && !serverContent.includes(injection.serverImports)):
    serverContent = replace(serverContent, '// [KAVEN_SERVER_IMPORTS]', injection.serverImports + '\n' + '// [KAVEN_SERVER_IMPORTS]')

  if (injection.serverStartup && !serverContent.includes(injection.serverStartup)):
    serverContent = replace(serverContent, '// [KAVEN_SERVER_STARTUP]', injection.serverStartup + '\n' + '// [KAVEN_SERVER_STARTUP]')

  // 3) cross-file injection (special case)
  if (injection.authControllerInjections && exists(authControllerPath)):
    authContent = read(authControllerPath)
    if (!authContent.includes(injection.authControllerInjections.import)):
      // faz replace em linhas-alvo espec√≠ficas
      authContent = replace(authContent, "<target import>", injection.import + "\n" + "<target import>")
      authContent = replace(authContent, "<target register line>", "<target register line>" + "\n\n" + injection.registerTrack)
      authContent = replace(authContent, "<target login line>", "<target login line>" + "\n\n" + injection.loginSuccessTrack)
      authContent = replace(authContent, "<target catch>", "<target catch>" + "\n" + injection.loginFailTrack)
      write(authControllerPath, authContent)

  write(appTsPath, appContent)
  write(serverTsPath, serverContent)
```

### Observa√ß√µes (risco/idempot√™ncia)

- O ‚Äúj√° injetei?‚Äù √© verificado por `includes(<bloco inteiro>)`, n√£o por markers.  
- Se o c√≥digo j√° cont√©m parte do bloco, mas n√£o o bloco exato, pode duplicar.

## 10.8 Pseudo-c√≥digo do `ejectRoutes()` (AS-IS)

O `remove` usa uma tabela `routesToRemove[name]` com uma lista de strings para remover.

```ts
function ejectRoutes(moduleName):
  appContent = read(app.ts)
  serverContent = read(server.ts)

  targets = routesToRemove[moduleName]
  for each target in targets:
    if moduleName == 'observability' and target startsWith('businessMetricsService.track'):
      continue // tratado separadamente no AuthController

    appContent = regexReplaceGlobal(appContent, escapeRegex(target), '')
    serverContent = regexReplaceGlobal(serverContent, escapeRegex(target), '')

  if moduleName == 'observability':
    // limpa AuthController removendo blocos espec√≠ficos e fallback regex

  // limpa linhas em branco extras
  appContent = collapseBlankLines(appContent)
  serverContent = collapseBlankLines(serverContent)

  write(app.ts, appContent)
  write(server.ts, serverContent)
```

### Observa√ß√µes (seguran√ßa)

- Esse modo √© √∫til quando n√£o existem markers por m√≥dulo.  
- Por√©m pode ‚Äúexagerar‚Äù e remover c√≥digo se a string-alvo coincidir com c√≥digo manual.

## 10.9 Caso especial: observability no AuthController (AS-IS)

O observability injeta tracking em:
- `register()` ‚Üí track user registration
- `login()` ‚Üí track success
- `catch` do register ‚Üí track fail (observa√ß√£o: no AS-IS h√° um track ‚Äúfailed login‚Äù dentro do register; isso √© um bug sem√¢ntico poss√≠vel)

Al√©m disso injeta um import:

```ts
import { businessMetricsService } from '../../observability/services/business-metrics.service';
```

> [!CAUTION]
> Este tipo de inje√ß√£o √© o mais fr√°gil do sistema: depende de strings exatas no controller.
> O TO-BE recomenda criar anchors dedicados dentro do AuthController ou usar AST.

## 10.10 Recomenda√ß√£o pr√°tica (sem reescrever tudo)

Se voc√™ continuar usando o AS-IS por um tempo:
- evite rearranjar imports em `app.ts`/`server.ts` manualmente ap√≥s instalar m√≥dulos
- evite editar trechos ‚Äúinjetados‚Äù manualmente
- se precisar alterar o core, prefira adicionar anchors novos e migrar para markers

---

# 11. SchemaManager (AS-IS): split-schema merge

## 11.1 Onde est√° e qual a responsabilidade

Arquivo: `kaven-cli/src/core/schema-manager.ts`

Responsabilidade:
- ler `schema.base.prisma` e `schema.extended.prisma`
- remover `datasource`/`generator` do extended (naive)
- concatenar com header e escrever `schema.prisma`

Paths usados (AS-IS):
- base: `packages/database/prisma/schema.base.prisma`
- extended: `packages/database/prisma/schema.extended.prisma`
- output: `packages/database/prisma/schema.prisma`

## 11.2 Comando CLI

O comando `kaven db generate` chama `SchemaManager.mergeSchemas()`.

O boilerplate integra isso no root script `pnpm db:generate`.

## 11.3 Limita√ß√µes do merge atual

O merge atual √© ‚Äúnaive‚Äù:
- strip regex de `datasource` e `generator` no extended
- concatena√ß√£o simples

Isso funciona na maioria dos casos, mas pode falhar em:
- blocos com chaves aninhadas complexas
- coment√°rios/formatting inesperados
- duplica√ß√£o de `enum`/`model` sem detec√ß√£o

## 11.4 Pseudo-c√≥digo do merge (AS-IS)

```ts
function mergeSchemas():
  base = read(schema.base.prisma)
  extended = read(schema.extended.prisma) // ou '' se n√£o existir

  // remove blocos do extended para evitar duplicidade
  extendedClean = extended
    .replace(/datasource\\s+\\w+\\s+\\{[^}]+\\}/g, '')
    .replace(/generator\\s+\\w+\\s+\\{[^}]+\\}/g, '')

  header = "// ‚ö†Ô∏è AUTOGENERATED FILE - DO NOT EDIT ‚ö†Ô∏è\\n..."
  output = header + base + "\\n\\n// --- USER EXTENSIONS ---\\n\\n" + extendedClean
  write(schema.prisma, output)
```

## 11.5 Regras de uso recomendadas (AS-IS)

- Nunca edite `schema.prisma` manualmente.  
- Edite `schema.extended.prisma` para suas tabelas.  
- Rode `pnpm db:generate` sempre que mudar schemas.  
- Se houver erro de ‚Äúduplicate model/enum‚Äù, procure duplica√ß√µes entre base e extended.

## 11.6 Evolu√ß√£o recomendada (TO-BE)

Para um merge realmente robusto:
- parsear schema com parser (AST) em vez de regex ing√™nua
- detectar duplica√ß√µes e explicar o erro (model/enum/field)
- suportar remo√ß√£o segura de blocos (datasource/generator) mesmo com braces complexos

---

# 12. LIMITA√á√ïES CONHECIDAS DO AS-IS

Esta se√ß√£o existe para evitar ‚Äúsurpresas‚Äù e para guiar o TO-BE.

## 12.1 Drift de nomenclatura e cat√°logo

- `ProjectInitializer` fala em `payments-stripe` etc.
- `ModuleManager` trabalha com `payments`.
- docs em `kaven-docs-v2.0` citam `payments-stripe`.
- `kaven-cli/templates/kaven.config.json` usa `payments-stripe`/`payments-mercadopago`, mas o repo atual usa `payments` em `kaven.config.json`.
- alguns m√≥dulos existem no c√≥digo mesmo quando o config marca `optional: false` (ex: `notifications` est√° presente e registrado no backend).

Sem padroniza√ß√£o, o ecossistema fica inconsistente.

## 12.2 Idempot√™ncia fr√°gil (string blocks)

O `add` evita duplica√ß√£o via `includes(block)` ‚Äî mas se o arquivo j√° tiver parte do bloco (em outra ordem), ele injeta duplicado.

Exemplos t√≠picos:
- imports existentes em ordem diferente
- ‚Äúrefactors‚Äù manuais no core
- linters/formatters rearranjando imports
- exemplo real (repo atual): o bloco de inje√ß√£o do `payments` inclui `invoiceRoutes`/`orderRoutes`, mas o `apps/api/src/app.ts` j√° possui esses imports/registrations. Ao instalar `payments`, o CLI pode duplicar linhas e quebrar build.

## 12.3 Ejection por regex de linhas soltas

O `remove` remove linhas por strings/regex:
- pode remover linhas que foram movidas/alteradas
- pode deixar ‚Äúlixo‚Äù (linhas em branco, imports √≥rf√£os)
- pode ser perigoso se strings coincidirem com c√≥digo ‚Äún√£o injetado‚Äù

## 12.4 Admin wiring incompleto

No AS-IS n√£o existe:
- inje√ß√£o de navega√ß√£o (sidebar)
- valida√ß√£o de rotas/p√°ginas no Next
- capabilities/grants automatizados

## 12.5 Schema per-module e deps per-module ausentes

No AS-IS, `module add`:
- n√£o edita `schema.extended.prisma`
- n√£o roda `db:generate`
- n√£o gerencia deps (pnpm)

---

# Parte III ‚Äî TO-BE (spec robusta)

# 13. MODELO DE M√ìDULO (manifest) ‚Äî m√≥dulo.json

> Objetivo: remover hardcode do CLI e permitir que o cat√°logo defina comportamento.

## 13.1 Estrutura do manifest (proposta)

Cada m√≥dulo deve possuir:

`kaven-cli/modules/<name>/module.json`

### Campos recomendados

```jsonc
{
  "name": "observability",
  "version": "1.0.0",
  "displayName": "Observability",
  "description": "Metrics, tracing helpers and dashboards",
  "category": "devops",
  "author": "Kaven",
  "license": "Proprietary",

  "compat": {
    "kaven": "^2.0.0",
    "node": ">=18.0.0"
  },

  "dependencies": {
    "core": ["auth", "tenants"],
    "npm": [
      { "name": "systeminformation", "version": "^5.30.0" }
    ]
  },

  "files": {
    "api": {
      "from": "api",
      "to": "apps/api/src/modules/observability"
    },
    "admin": {
      "from": "admin",
      "to": "apps/admin/app/[locale]/(dashboard)/observability"
    }
  },

  "injections": {
    "api": {
      "apps/api/src/app.ts": [
        {
          "anchor": "// [KAVEN_MODULE_IMPORTS]",
          "mode": "insert_before",
          "id": "imports",
          "content": "import { observabilityRoutes } from './modules/observability/routes/observability.routes';"
        },
        {
          "anchor": "// [KAVEN_MODULE_HOOKS]",
          "mode": "insert_before",
          "id": "hooks",
          "content": "app.addHook('onRequest', advancedMetricsMiddleware);"
        }
      ],
      "apps/api/src/server.ts": [
        {
          "anchor": "// [KAVEN_SERVER_STARTUP]",
          "mode": "insert_before",
          "id": "startup",
          "content": "metricsUpdaterService.start();"
        }
      ]
    }
  },

  "schema": {
    "fragments": [
      { "from": "prisma/observability.prisma", "to": "packages/database/prisma/schema.extended.prisma" }
    ],
    "runGenerate": true
  },

  "env": {
    "required": [],
    "optional": ["SENTRY_DSN"]
  },

  "routes": {
    "api": ["/api/observability", "/api/diagnostics"],
    "admin": ["/observability"]
  },

  "postInstall": [
    { "type": "command", "run": "pnpm db:generate" }
  ]
}
```

> [!NOTE]
> O TO-BE aqui √© propositalmente ‚Äúverbose‚Äù: a inten√ß√£o √© que o CLI consiga operar sem hardcode.
>
> `files.api` e `files.admin` s√£o **opcionais** (m√≥dulo pode ser API-only ou Admin-only), mas o manifest deve ter **ao menos um** deles.

## 13.2 JSON Schema (contrato formal) ‚Äî (resumo)

Recomenda√ß√£o: manter um `module.schema.json` (JSON Schema) no reposit√≥rio do CLI.

No Ap√™ndice h√° um template de JSON Schema completo.

## 13.3 Versionamento (SemVer)

Regras recomendadas:
- `MAJOR`: mudan√ßa breaking no wiring, schema, ou UX
- `MINOR`: novas features compat√≠veis
- `PATCH`: bugfix, docs, melhorias internas

## 13.4 Categorias e taxonomia

Exemplos:
- `commerce` (payments, billing)
- `devops` (observability, diagnostics)
- `crm`, `communication`, `files`, `hr`, `booking` etc

## 13.5 Nomenclatura (TO-BE) ‚Äî cat√°logo √∫nico e marketplace

Objetivo: eliminar drift (`payments` vs `payments-stripe`) e permitir empacotamento claro para **engenharia** e **vendas**.

Regras recomendadas:
- `name` do `module.json` deve ser a **chave can√¥nica √∫nica** (cat√°logo + `kaven.config.json` + CLI).
- O cat√°logo deve distinguir explicitamente:
  - **M√≥dulos de plataforma** (CORE do monorepo; n√£o instal√°veis via store)
  - **M√≥dulos instal√°veis** (ADD-ON via store/CLI)

Conven√ß√£o sugerida (marketplace/add-ons):
- Providers de pagamentos:
  - `payments-stripe`
  - `payments-paguebit`
  - `payments-mercadopago` (üîÆ planned)
  - `payments-paddle` (üîÆ planned)
- Observability:
  - `observability`

Nota (realidade AS-IS): hoje existe um m√≥dulo √∫nico `payments` no store que √© um ‚Äúbundle‚Äù (Stripe + Pix + PagueBit).  
Recomenda√ß√£o: no TO-BE, evoluir para providers separados e (se necess√°rio) um ‚Äúmeta-m√≥dulo‚Äù `payments` que dependa de providers espec√≠ficos.

> Para a estrat√©gia de empacotamento CORE vs ADD-ON (vis√£o de vendas), veja: `feat-modules/index-modules.pt.md`.

---

# 14. ENGINE DE INJE√á√ÉO (spec): idempot√™ncia, revers√£o, markers

## 14.1 Problema: string replace n√£o escala

`content.replace(anchor, injected + anchor)` funciona, mas:
- quebra com reformatters/linters
- √© dif√≠cil de reverter com seguran√ßa sem markers

## 14.2 Solu√ß√£o TO-BE: markers por m√≥dulo + ids

Toda inje√ß√£o deve ser encapsulada:

```ts
// [KAVEN_MODULE:observability:imports:START]
import { observabilityRoutes } from './modules/observability/routes/observability.routes';
// [KAVEN_MODULE:observability:imports:END]
// [KAVEN_MODULE_IMPORTS]
```

### Benef√≠cios

- ejection √© simples e segura (remove bloco START..END)
- idempot√™ncia forte (se START existe, n√£o reinjeta)
- reduz risco de remover c√≥digo de terceiros

## 14.3 Modos de inje√ß√£o (TO-BE)

Cada injection entry define:
- `anchor`: string de busca
- `mode`: `insert_before | insert_after | replace_between`
- `content`: snippet
- `id`: identificador est√°vel do snippet (para markers)

## 14.4 Regras de formata√ß√£o/indenta√ß√£o

Recomenda√ß√£o:
- o manifest pode definir `indent: 2` ou `indentFromAnchor: true`
- o engine calcula indent a partir da linha do anchor
- o engine preserva EOL e encoding (UTF-8)

## 14.5 Detec√ß√£o e valida√ß√£o de anchors

Antes de injetar:
- verificar que o arquivo existe
- verificar que o anchor existe **exatamente uma vez**
  - se 0: erro com instru√ß√µes
  - se >1: erro (ambiguidade)

## 14.6 Estrat√©gias para cross-file injection

Evitar string replace ‚Äúno escuro‚Äù.

Op√ß√µes:
1) adicionar anchors nos arquivos core (prefer√≠vel)  
2) usar AST (ts-morph / babel) para inserir com seguran√ßa  
3) usar ‚Äúmarkers‚Äù por padr√£o mesmo em cross-file injection

---

# 15. SCHEMA POR M√ìDULO + MIGRATIONS (spec)

## 15.1 Objetivo

Permitir que m√≥dulos adicionem modelos/tabelas sem tocar no base.

## 15.2 Modelo recomendado

Cada m√≥dulo pode conter:

```
kaven-cli/modules/<name>/
‚îî‚îÄ‚îÄ prisma/
    ‚îú‚îÄ‚îÄ schema.prisma.fragment   # opcional (model/enums)
    ‚îî‚îÄ‚îÄ migrations/              # opcional (SQL/Prisma migrations)
```

O CLI:
- copia/append o fragment em `schema.extended.prisma`
- roda `kaven db generate`
- (opcional) roda `prisma migrate dev` se o dev confirmar

## 15.3 Pol√≠tica de migrations (safety-first)

- migrations autom√°ticas devem ser **aditivas** por padr√£o
- qualquer opera√ß√£o destrutiva exige confirma√ß√£o expl√≠cita

## 15.4 Conflitos de schema

O CLI deve detectar:
- `model` duplicado
- `enum` duplicado
- `datasource/generator` duplicados

No TO-BE, a valida√ß√£o ideal √© usar `prisma validate` (quando dispon√≠vel) no schema final gerado.

---

# 16. DEPENDENCIES (spec): core + npm/pnpm + peer deps

## 16.1 Tipos de depend√™ncias

- **Core dependencies**: m√≥dulos que precisam estar instalados antes (ex: payments depende de auth + tenants).
- **NPM dependencies**: pacotes a instalar (ex: stripe, systeminformation).
- **Peer dependencies**: pacotes que o projeto j√° deve ter (ex: prisma/client).

## 16.2 Resolu√ß√£o e instala√ß√£o (pnpm)

Recomenda√ß√£o:
- detectar workspace (pnpm) e executar installs no root
- registrar no config um lock de vers√µes do m√≥dulo instalado (para update)

## 16.3 Remo√ß√£o de deps

Por seguran√ßa:
- n√£o remover automaticamente deps no `remove` (pode estar em uso por outro m√≥dulo)
- ou remover apenas se:
  - o pacote foi instalado exclusivamente pelo m√≥dulo
  - nenhum outro m√≥dulo declara o pacote

---

# 17. UPDATE/UPGRADE DE M√ìDULOS (spec)

## 17.1 Objetivo

Permitir ‚Äúupgrade in place‚Äù:
- sem perder customiza√ß√µes
- aplicando migrations necess√°rias

## 17.2 Estrat√©gia recomendada

1) comparar vers√µes (`current` vs `target`)
2) diff de arquivos (store vs installed)
3) re-aplicar injection se necess√°rio (com markers)
4) executar migrations compat√≠veis
5) rodar `db:generate` e `prisma generate`

## 17.3 Rollback

O CLI deve:
- criar backup antes de update (ou branch git)
- permitir reverter no caso de falha

---

# 18. SEGURAN√áA E ROLLBACK (spec)

## 18.1 Seguran√ßa de dados

Princ√≠pio: **data loss > inconvenience**

Remover m√≥dulo:
- remove c√≥digo e wiring
- mant√©m tabelas e dados

## 18.2 Seguran√ßa operacional

Recomenda√ß√£o:
- criar branch e commit autom√°tico antes de mudan√ßas grandes (quando git dispon√≠vel)
- oferecer `--dry-run` para mostrar diffs sem aplicar

## 18.3 Opera√ß√£o transacional (best-effort)

Pelo menos:
- backup de `app.ts`, `server.ts`, `kaven.config.json` antes de alterar
- se qualquer passo falhar: restaurar arquivos

---

# Parte IV ‚Äî Workflows

# 19. FLUXOS DO DESENVOLVEDOR (instalar/remover/atualizar)

## 19.1 Listar m√≥dulos

```bash
node kaven-cli/bin/kaven.js module list
```

Ou via source:

```bash
npx tsx kaven-cli/src/index.ts module list
```

## 19.2 Instalar m√≥dulo

```bash
npx tsx kaven-cli/src/index.ts module add observability
```

Checklist p√≥s-instala√ß√£o (TO-BE completo):
- verificar pastas copiadas (api/admin)
- verificar anchors atualizados (app.ts/server.ts)
- verificar `kaven.config.json`
- se o m√≥dulo altera schema:
  - `pnpm db:generate`
  - `pnpm db:migrate`
- reiniciar dev server

## 19.3 Remover m√≥dulo

```bash
npx tsx kaven-cli/src/index.ts module remove observability
```

Checklist p√≥s-remo√ß√£o:
- pastas removidas
- anchors limpos
- config atualizado
- (opcional) migrations manuais se quiser remover tabelas

## 19.4 Atualizar m√≥dulo (TO-BE)

```bash
kaven module update observability
```

No AS-IS n√£o existe, mas a spec define como deve ser.

---

# 20. COMO CRIAR UM M√ìDULO NOVO (guia completo)

Esta se√ß√£o descreve o fluxo recomendado para autoria de m√≥dulo, com AS-IS e TO-BE.

## 20.1 Decide o ‚Äúshape‚Äù do m√≥dulo

Perguntas:
- √© apenas API?
- √© apenas Admin?
- √© full-stack?
- precisa de schema/migrations?
- precisa de hooks/startup?
- precisa de cross-module injection?

## 20.2 Estrutura m√≠nima (TO-BE)

```
kaven-cli/modules/<name>/
‚îú‚îÄ‚îÄ module.json
‚îú‚îÄ‚îÄ api/            # opcional
‚îú‚îÄ‚îÄ admin/          # opcional
‚îú‚îÄ‚îÄ prisma/         # opcional
‚îî‚îÄ‚îÄ docs/README.md  # recomendado
```

## 20.3 Definir manifest (m√≥dulo.json)

- nome e vers√£o
- deps core e npm
- arquivos a copiar (api/admin)
- injections (anchors)
- schema fragments
- env vars necess√°rias
- rotas expostas
- postInstall tasks

## 20.4 Garantir anchors no core

Sem anchors est√°veis, o m√≥dulo n√£o ‚Äúencaixa‚Äù com seguran√ßa.

Se precisar inserir em um arquivo sem anchor (ex: AuthController):
- crie um anchor no core (prefer√≠vel)
- ou use AST/markers

## 20.5 Testar m√≥dulo em um projeto fixture

Checklist:
- `add` deixa projeto compil√°vel
- `remove` deixa projeto compil√°vel
- `add` depois de `remove` funciona
- schema merge continua v√°lido
- rotas funcionam (API e Admin)

---

# 21. COMO ADICIONAR UM NOVO ANCHOR AO CORE (guia)

## 21.1 Princ√≠pios

- Anchors devem ser est√°veis, √∫nicos e bem documentados.
- N√£o use anchors gen√©ricos demais (risco de colis√£o).
- Prefira `// [KAVEN_<SCOPE>_<PURPOSE>]`.

## 21.2 Exemplo: criar anchor de ‚ÄúAdmin Navigation‚Äù

Hoje a navega√ß√£o do admin √© centralizada em `apps/admin/config/navigation.ts`.

Op√ß√µes TO-BE:
1) adicionar anchor em `MASTER_NAVIGATION` para injection, ou  
2) tornar navigation ‚Äúdata-driven‚Äù lendo m√≥dulos instalados do config.

Se optar por anchor:

```ts
// [KAVEN_ADMIN_NAVIGATION]
```

E a engine injeta um bloco markerado.

## 21.3 Checklist de um bom anchor

- [ ] string √∫nica no arquivo
- [ ] coment√°rio n√£o conflita com lint/format
- [ ] anchor tem docs e exemplo
- [ ] engine valida presen√ßa do anchor

---

# Parte V ‚Äî Testes, Troubleshooting e Ap√™ndices

# 22. ESTRAT√âGIA DE TESTES (unit/integration/e2e)

## 22.1 Unit tests

Foco:
- Schema merge (fixtures de base/extended)
- injection engine (transforma√ß√£o de arquivo por anchor)

## 22.2 Integration tests

Rodar `add/remove` em um projeto fixture e comparar:
- diffs esperados nos arquivos core
- pastas copiadas/removidas
- config alterado corretamente

## 22.3 E2E tests por m√≥dulo

M√≥dulos podem incluir testes pr√≥prios (ex: observability tem `__tests__` no store).

---

# 23. TROUBLESHOOTING E PLAYBOOK DE DEBUG

## 23.1 ‚ÄúAnchor not found‚Äù

Sintoma:
- CLI n√£o consegue injetar.

Checklist:
- voc√™ est√° rodando na raiz do projeto?
- o arquivo-alvo existe?
- o anchor foi renomeado/removido?

## 23.2 Duplica√ß√£o de imports/registrations

Causa comum:
- idempot√™ncia fraca por bloco
- reorder de imports

Corre√ß√£o (TO-BE):
- usar markers por m√≥dulo
- validar ‚Äúj√° instalado‚Äù pelo marker, n√£o por bloco

## 23.3 `schema.prisma` inv√°lido

Checklist:
- base tem datasource/generator
- extended n√£o deve repetir datasource/generator
- models/enums n√£o podem duplicar
- rodar `pnpm db:generate` e depois `prisma validate` (quando aplic√°vel)

## 23.4 `kaven.config.json` fora de sincronia

Sinais:
- config diz que m√≥dulo est√° instalado, mas arquivos n√£o existem (ou vice-versa)

Causa:
- opera√ß√£o interrompida no meio

Mitiga√ß√£o TO-BE:
- opera√ß√µes transacionais + backup/rollback

---

# 24. AP√äNDICES (tabelas, templates, checklists)

## 24.1 Tabela de anchors (AS-IS)

| Arquivo | Anchor | Uso |
|---|---|---|
| `apps/api/src/app.ts` | `// [KAVEN_MODULE_IMPORTS]` | Inject de imports de m√≥dulos |
| `apps/api/src/app.ts` | `// [KAVEN_MODULE_HOOKS]` | Inject de hooks (onRequest/onResponse etc) |
| `apps/api/src/app.ts` | `// [KAVEN_MODULE_REGISTRATION]` | Inject de `app.register(...)` |
| `apps/api/src/server.ts` | `// [KAVEN_SERVER_IMPORTS]` | Imports necess√°rios no bootstrap |
| `apps/api/src/server.ts` | `// [KAVEN_SERVER_STARTUP]` | C√≥digo de startup (ex: `.start()`) |

## 24.2 Template: module.json (TO-BE)

```jsonc
{
  "name": "my-module",
  "version": "1.0.0",
  "displayName": "My Module",
  "description": "What it does",
  "category": "custom",
  "author": "You",
  "license": "Proprietary",
  "compat": { "kaven": "^2.0.0", "node": ">=18.0.0" },
  "dependencies": { "core": [], "npm": [] },
  "files": { "api": { "from": "api", "to": "apps/api/src/modules/my-module" } },
  "injections": {},
  "schema": { "fragments": [], "runGenerate": true },
  "env": { "required": [], "optional": [] },
  "routes": { "api": [], "admin": [] },
  "postInstall": []
}
```

## 24.3 Checklist de qualidade de m√≥dulo

- [ ] `module.json` v√°lido
- [ ] `add` funciona em projeto limpo
- [ ] `remove` limpa o wiring e mant√©m projeto compil√°vel
- [ ] `add` ap√≥s `remove` n√£o duplica c√≥digo
- [ ] docs do m√≥dulo explicam env vars e rotas
- [ ] schema fragment n√£o repete datasource/generator
- [ ] sem migrations destrutivas autom√°ticas

## 24.4 Refer√™ncia de comandos (AS-IS vs TO-BE)

### Comandos existentes (AS-IS)

| Comando | Argumentos | Efeito | Arquivos alterados |
|---|---|---|---|
| `kaven module list` | ‚Äî | lista m√≥dulos instalados/ dispon√≠veis | nenhum |
| `kaven module add <name>` | `name` | copia arquivos + injeta em core + atualiza config | `apps/api/src/app.ts`, `apps/api/src/server.ts`, `apps/admin/...`, `apps/api/src/modules/...`, `kaven.config.json` |
| `kaven module remove <name>` | `name` | remove arquivos + eject + atualiza config | mesmos arquivos (remo√ß√£o + limpeza) |
| `kaven db generate` | ‚Äî | merge de schemas | `packages/database/prisma/schema.prisma` |
| `kaven update` | flags | placeholder | nenhum (hoje) |

### Comandos recomendados (TO-BE)

| Comando | Motivo | Notas |
|---|---|---|
| `kaven module installed` | ver estado real | l√™ config + valida presen√ßa de arquivos |
| `kaven module info <name>` | mostrar rotas/env/deps | baseado em `module.json` |
| `kaven module add <name> --dry-run` | seguran√ßa | mostra diffs e opera√ß√µes planejadas |
| `kaven module add <name> --force` | recupera√ß√£o | repara instala√ß√µes quebradas |
| `kaven module remove <name> --keep-files` | debug | remove wiring mas preserva arquivos (opcional) |
| `kaven module update <name>` | upgrades | semver + migrations + rewire |
| `kaven module diff <name>` | audit | diff entre store vs instalado |
| `kaven module doctor` | diagn√≥stico | anchors, config drift, schema drift |

### Exit codes (recomenda√ß√£o)

- `0`: sucesso
- `1`: erro de valida√ß√£o/execu√ß√£o
- `2`: erro de ambiente (node/pnpm/prisma ausente)

## 24.5 Exemplo completo de `module.json` ‚Äî observability (TO-BE)

```jsonc
{
  "name": "observability",
  "version": "1.0.0",
  "displayName": "Observability",
  "description": "Prometheus metrics, diagnostics endpoints and dashboards",
  "category": "devops",
  "author": "Kaven",
  "license": "Proprietary",
  "compat": {
    "kaven": "^2.0.0",
    "node": ">=18.0.0"
  },
  "dependencies": {
    "core": ["auth", "tenants"],
    "npm": [
      { "name": "systeminformation", "version": "^5.30.0" }
    ]
  },
  "files": {
    "api": { "from": "api", "to": "apps/api/src/modules/observability" },
    "admin": { "from": "admin", "to": "apps/admin/app/[locale]/(dashboard)/observability" }
  },
  "injections": {
    "api": {
      "apps/api/src/app.ts": [
        {
          "id": "imports",
          "anchor": "// [KAVEN_MODULE_IMPORTS]",
          "mode": "insert_before",
          "content": [
            "import { observabilityRoutes } from './modules/observability/routes/observability.routes';",
            "import { diagnosticsRoutes } from './modules/observability/routes/diagnostics.routes';",
            "import { advancedMetricsMiddleware, onResponseMetricsHook } from './modules/observability/middleware/advanced-metrics.middleware';"
          ]
        },
        {
          "id": "hooks",
          "anchor": "// [KAVEN_MODULE_HOOKS]",
          "mode": "insert_before",
          "content": [
            "app.addHook('onRequest', advancedMetricsMiddleware);",
            "app.addHook('onResponse', onResponseMetricsHook);"
          ]
        },
        {
          "id": "registration",
          "anchor": "// [KAVEN_MODULE_REGISTRATION]",
          "mode": "insert_before",
          "content": [
            "app.register(observabilityRoutes, { prefix: '/api/observability' });",
            "app.register(diagnosticsRoutes, { prefix: '/api/diagnostics' });"
          ]
        }
      ],
      "apps/api/src/server.ts": [
        {
          "id": "server_imports",
          "anchor": "// [KAVEN_SERVER_IMPORTS]",
          "mode": "insert_before",
          "content": [
            "import { metricsUpdaterService } from './modules/observability/services/metrics-updater.service';"
          ]
        },
        {
          "id": "server_startup",
          "anchor": "// [KAVEN_SERVER_STARTUP]",
          "mode": "insert_before",
          "content": [
            "metricsUpdaterService.start();"
          ]
        }
      ],
      "apps/api/src/modules/auth/controllers/auth.controller.ts": [
        {
          "id": "auth_tracking",
          "mode": "ast_or_markers",
          "description": "Inject tracking calls for login/register",
          "content": []
        }
      ]
    }
  },
  "schema": {
    "fragments": [],
    "runGenerate": false
  },
  "env": {
    "required": [],
    "optional": ["SENTRY_DSN"]
  },
  "routes": {
    "api": ["/api/observability", "/api/diagnostics"],
    "admin": ["/observability"]
  },
  "postInstall": [
    { "type": "message", "text": "Observability installed. Verify /api/metrics and /observability." }
  ]
}
```

## 24.6 Exemplo completo de `module.json` ‚Äî payments (TO-BE)

> Este exemplo √© propositalmente mais ‚Äúestrito‚Äù em env vars.

```jsonc
{
  "name": "payments",
  "version": "1.0.0",
  "displayName": "Payments",
  "description": "Stripe subscriptions + PIX (PagueBit) + webhooks",
  "category": "commerce",
  "author": "Kaven",
  "license": "Proprietary",
  "compat": { "kaven": "^2.0.0", "node": ">=18.0.0" },
  "dependencies": {
    "core": ["auth", "tenants", "plans", "products", "subscriptions", "invoices", "orders"],
    "npm": [
      { "name": "stripe", "version": "^14.0.0" },
      { "name": "axios", "version": "^1.6.0" }
    ]
  },
  "files": {
    "api": { "from": "api", "to": "apps/api/src/modules/payments" },
    "admin": { "from": "admin", "to": "apps/admin/app/[locale]/(dashboard)/payments" }
  },
  "injections": {
    "api": {
      "apps/api/src/app.ts": [
        {
          "id": "imports",
          "anchor": "// [KAVEN_MODULE_IMPORTS]",
          "mode": "insert_before",
          "content": [
            "import { paymentRoutes, webhookRoutes } from './modules/payments/routes/payment.routes';"
          ]
        },
        {
          "id": "registration",
          "anchor": "// [KAVEN_MODULE_REGISTRATION]",
          "mode": "insert_before",
          "content": [
            "app.register(paymentRoutes, { prefix: '/api/payments' });",
            "app.register(webhookRoutes, { prefix: '/api/webhooks' });"
          ]
        }
      ]
    }
  },
  "schema": {
    "fragments": [],
    "runGenerate": false
  },
  "env": {
    "required": ["STRIPE_SECRET_KEY", "STRIPE_WEBHOOK_SECRET"],
    "optional": ["PAGUEBIT_API_TOKEN", "PAGUEBIT_WEBHOOK_SECRET"]
  },
  "routes": {
    "api": ["/api/payments", "/api/webhooks"],
    "admin": ["/payments"]
  },
  "postInstall": [
    { "type": "message", "text": "Add STRIPE_SECRET_KEY + STRIPE_WEBHOOK_SECRET (and optionally PAGUEBIT_API_TOKEN + PAGUEBIT_WEBHOOK_SECRET) to .env" },
    { "type": "message", "text": "Stripe webhook validation requires raw body (ensure a rawBody strategy/plugin exists in Fastify)." }
  ]
}
```

## 24.7 Markers (TO-BE): padr√£o recomendado de bloco injetado

### Formato recomendado

```ts
// [KAVEN_MODULE:<moduleName>:<id>:START]
// ... injected content ...
// [KAVEN_MODULE:<moduleName>:<id>:END]
```

### Exemplo (imports)

```ts
// [KAVEN_MODULE:payments:imports:START]
import { paymentRoutes, webhookRoutes } from './modules/payments/routes/payment.routes';
// [KAVEN_MODULE:payments:imports:END]
// [KAVEN_MODULE_IMPORTS]
```

### Regra de ejection

- remover tudo entre `START` e `END` (inclusive)
- preservar o anchor ‚Äúslot‚Äù do core

## 24.8 JSON Schema completo (TO-BE) ‚Äî `module.json`

> Este schema √© um contrato sugerido (pode ser refinado conforme o engine evolui).

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kaven.dev/schemas/module.json",
  "title": "Kaven Module Manifest",
  "type": "object",
  "additionalProperties": false,
  "required": ["name", "version", "displayName", "description", "category", "author", "license", "files"],
  "properties": {
    "name": {
      "type": "string",
      "pattern": "^[a-z0-9][a-z0-9-]*[a-z0-9]$",
      "minLength": 2,
      "maxLength": 64
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+(-[0-9A-Za-z.-]+)?$"
    },
    "displayName": { "type": "string", "minLength": 2, "maxLength": 80 },
    "description": { "type": "string", "minLength": 10, "maxLength": 400 },
    "category": { "type": "string", "minLength": 2, "maxLength": 40 },
    "author": { "type": "string", "minLength": 2, "maxLength": 80 },
    "license": { "type": "string", "minLength": 2, "maxLength": 40 },
    "compat": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "kaven": { "type": "string" },
        "node": { "type": "string" }
      }
    },
    "dependencies": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "core": { "type": "array", "items": { "type": "string" }, "default": [] },
        "npm": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "version"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "version": { "type": "string", "minLength": 1 }
            }
          },
          "default": []
        }
      }
    },
    "files": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "api": { "$ref": "#/$defs/fileMapping" },
        "admin": { "$ref": "#/$defs/fileMapping" }
      },
      "minProperties": 1,
      "anyOf": [
        { "required": ["api"] },
        { "required": ["admin"] }
      ]
    },
    "injections": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "api": { "$ref": "#/$defs/injectionScope" },
        "admin": { "$ref": "#/$defs/injectionScope" }
      }
    },
    "schema": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "fragments": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["from", "to"],
            "properties": {
              "from": { "type": "string", "minLength": 1 },
              "to": { "type": "string", "minLength": 1 }
            }
          },
          "default": []
        },
        "runGenerate": { "type": "boolean", "default": false }
      }
    },
    "env": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "required": { "type": "array", "items": { "type": "string" }, "default": [] },
        "optional": { "type": "array", "items": { "type": "string" }, "default": [] }
      }
    },
    "routes": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "api": { "type": "array", "items": { "type": "string" }, "default": [] },
        "admin": { "type": "array", "items": { "type": "string" }, "default": [] }
      }
    },
    "postInstall": {
      "type": "array",
      "items": { "$ref": "#/$defs/postInstallStep" },
      "default": []
    }
  },
  "$defs": {
    "fileMapping": {
      "type": "object",
      "additionalProperties": false,
      "required": ["from", "to"],
      "properties": {
        "from": { "type": "string", "minLength": 1 },
        "to": { "type": "string", "minLength": 1 }
      }
    },
    "injectionScope": {
      "type": "object",
      "additionalProperties": {
        "type": "array",
        "items": { "$ref": "#/$defs/injectionEntry" }
      }
    },
    "injectionEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "mode"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "anchor": { "type": "string" },
        "mode": {
          "type": "string",
          "enum": ["insert_before", "insert_after", "replace_between", "ast_or_markers"]
        },
        "content": {
          "oneOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" } }
          ]
        },
        "description": { "type": "string" }
      }
    },
    "postInstallStep": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": { "type": "string", "enum": ["command", "message"] },
        "run": { "type": "string" },
        "text": { "type": "string" }
      }
    }
  }
}
```

## 24.9 Matriz m√≠nima de testes (TO-BE)

| Caso | Setup | A√ß√£o | Expectativa |
|---|---|---|---|
| add m√≥dulo simples | projeto limpo | `module add x` | copia arquivos + injeta + compila |
| remove m√≥dulo simples | m√≥dulo instalado | `module remove x` | remove wiring + remove arquivos + compila |
| add idempotente | m√≥dulo j√° instalado | `module add x` | n√£o duplica imports/registrations |
| remove idempotente | m√≥dulo j√° removido | `module remove x` | n√£o falha |
| anchor ausente | core modificado | `module add x` | erro claro + nenhuma altera√ß√£o |
| schema conflict | model duplicado | `db generate` | erro claro + instru√ß√µes |
| crash no meio | simular exce√ß√£o | `module add x` | rollback restaura arquivos |

## 24.10 Matriz de riscos e mitiga√ß√£o

| Risco | Impacto | Mitiga√ß√£o |
|---|---|---|
| drift de nomes | m√≥dulos ‚Äún√£o batem‚Äù | manifest + cat√°logo √∫nico |
| string replace fr√°gil | duplica√ß√£o/remo√ß√£o errada | markers + AST |
| remo√ß√£o destrutiva | data loss | safety-first + migrations manuais |
| opera√ß√£o parcial | estado inconsistente | backup/rollback + doctor command |
| schema merge ing√™nuo | prisma inv√°lido | parser + valida√ß√£o + melhores erros |

---

---
updated: 2026-01-22T04:00:00
version: 1.0.0
status: Unified Spec + Implementation Guide (TO-BE)
priority: CRITICAL (Auth + Marketplace + Monetization)
---

# üîê KAVEN CLI ‚Äî AUTH + MARKETPLACE
## Especifica√ß√£o T√©cnica + Guia Completo de Implementa√ß√£o (Unificado)

**Vers√£o:** 1.0.0  
**Data:** Janeiro 2026  
**Status:** Documento de implementa√ß√£o (TO-BE) ‚Äî **n√£o implementado ainda no repo**  
**Escopo:** Autentica√ß√£o do CLI + Marketplace/Loja de m√≥dulos + Licen√ßas (license keys) + Checkout (Paddle) + Distribui√ß√£o segura de m√≥dulos  

**Este documento complementa:**
- `3. Kaven CLI Module System - Unified Spec + Implementation Guide.md` (m√≥dulos: copy + injection + split-schema)
- `feat-modules/index-modules.pt.md` (cat√°logo real de m√≥dulos, core vs add-ons)
- `feat-modules/feature-matrix.en.md` (vis√£o de vendas + roadmap com ‚Äúreality check‚Äù)

> [!IMPORTANT]
> **AS-IS (hoje no repo):**
> - N√£o existe `kaven login`, n√£o existe marketplace remoto, n√£o existe licensing/purchases no CLI.
> - O CLI atual gerencia apenas m√≥dulos ‚Äúlocais‚Äù (`kaven-cli/modules/*`) e faz wiring por anchors.
>
> **TO-BE (este documento):**
> - Descreve um sistema **h√≠brido** de autentica√ß√£o (license key + account login).
> - Descreve um marketplace Q2 (cat√°logo remoto + checkout + download seguro + instala√ß√£o via engine de m√≥dulos).
> - Serve como guia implementation-ready para voc√™ passar ao Antigravity/Claude Code.

---

## üìå TL;DR (o que vamos construir)

O **Kaven CLI Auth + Marketplace** adiciona 4 capacidades ao ecossistema:

1) **Auth (h√≠brido):**  
   - **License Key flow** (usu√°rio compra ‚Üí recebe key ‚Üí instala via CLI).  
   - **Account login flow** (usu√°rio faz login ‚Üí compra/instala sem key; ‚Äú1-click purchase‚Äù opcional).

2) **Marketplace remoto de m√≥dulos:**  
   - Listagem e descoberta (`search`, `info`, `categories`).  
   - Compra via Paddle (checkout).  
   - Emiss√£o de licen√ßa/entitlement por m√≥dulo.

3) **Distribui√ß√£o segura de m√≥dulos:**  
   - M√≥dulos empacotados (tar/zip) + **checksum** + **assinatura** (Ed25519).  
   - CLI baixa, valida assinatura e instala (usando o Module System do doc 3).

4) **Ponte com o Module System (doc 3):**  
   - Marketplace n√£o ‚Äúinstala do zero‚Äù; ele **baixa** um m√≥dulo e chama a mesma engine de `add/remove` (copy + injection + schema merge).

---

## üìã √çNDICE (alto n√≠vel)

**Parte I ‚Äî Produto, Princ√≠pios e Modelo de Seguran√ßa**
1. [O que √© (e o que n√£o √©)](#1-o-que-√©-e-o-que-n√£o-√©)
2. [Objetivos, n√£o-objetivos e invariantes](#2-objetivos-n√£o-objetivos-e-invariantes)
3. [Atores, pap√©is e jornadas](#3-atores-pap√©is-e-jornadas)
4. [Threat model (seguran√ßa)](#4-threat-model-seguran√ßa)

**Parte II ‚Äî AS-IS (estado real do repo)**
5. [Invent√°rio do CLI hoje (AS-IS)](#5-invent√°rio-do-cli-hoje-as-is)
6. [Lacunas e ‚Äúdrifts‚Äù relevantes](#6-lacunas-e-drifts-relevantes)

**Parte III ‚Äî TO-BE (spec detalhada)**
7. [Arquitetura do sistema (vis√£o macro)](#7-arquitetura-do-sistema-vis√£o-macro)
8. [Autentica√ß√£o do CLI (h√≠brida)](#8-autentica√ß√£o-do-cli-h√≠brida)
9. [Licen√ßas, entitlements e ownership](#9-licen√ßas-entitlements-e-ownership)
10. [Marketplace: cat√°logo, compra e downloads](#10-marketplace-cat√°logo-compra-e-downloads)
11. [Empacotamento e assinatura de m√≥dulos](#11-empacotamento-e-assinatura-de-m√≥dulos)
12. [API do Marketplace (endpoints)](#12-api-do-marketplace-endpoints)
13. [Banco de dados do Marketplace (schema)](#13-banco-de-dados-do-marketplace-schema)
14. [Integra√ß√£o com Paddle (checkout + webhooks)](#14-integra√ß√£o-com-paddle-checkout--webhooks)
15. [Integra√ß√£o com o Module System (doc 3)](#15-integra√ß√£o-com-o-module-system-doc-3)
16. [Pipeline de publica√ß√£o de m√≥dulos (authors)](#16-pipeline-de-publica√ß√£o-de-m√≥dulos-authors)

**Parte IV ‚Äî Plano de Implementa√ß√£o**
17. [Roadmap t√©cnico (MVP ‚Üí evolu√ß√£o)](#17-roadmap-t√©cnico-mvp--evolu√ß√£o)
18. [Checklist de aceita√ß√£o (Definition of Done)](#18-checklist-de-aceita√ß√£o-definition-of-done)
19. [Estrat√©gia de testes](#19-estrat√©gia-de-testes)
20. [Observabilidade, logs e telemetria (privacy-first)](#20-observabilidade-logs-e-telemetria-privacy-first)

**Parte V ‚Äî Ap√™ndices**
21. [Especifica√ß√£o de comandos (UX)](#21-especifica√ß√£o-de-comandos-ux)
22. [Arquivos locais do CLI (paths)](#22-arquivos-locais-do-cli-paths)
23. [Formatos de tokens e arquivos](#23-formatos-de-tokens-e-arquivos)
24. [Exemplos (responses, manifests, outputs)](#24-exemplos-responses-manifests-outputs)

---

# Parte I ‚Äî Produto, Princ√≠pios e Modelo de Seguran√ßa

# 1. O QUE √â (E O QUE N√ÉO √â)

## 1.1 ‚úÖ O que √©

### Marketplace como ‚Äúdistribui√ß√£o + licenciamento + download‚Äù

O Marketplace do Kaven √© um sistema que:
- exp√µe um **cat√°logo remoto** de m√≥dulos (metadados, vers√µes, compatibilidade),
- processa **compras** (via Paddle),
- emite **licen√ßas/entitlements** (por m√≥dulo, por vers√£o, por usu√°rio/conta),
- entrega o m√≥dulo via **download seguro** (assinatura + checksum),
- e deixa a instala√ß√£o f√≠sica no projeto para o Module System (doc 3).

### Auth do CLI (h√≠brido)

O CLI ter√° 2 formas de autentica√ß√£o:

1) **License Key (anon / baixa fric√ß√£o):**  
   - comprado no site ‚Üí key ‚Üí CLI valida key ‚Üí baixa m√≥dulo.

2) **Account Login (robusto / escal√°vel):**  
   - CLI obt√©m tokens (device code ou PKCE) ‚Üí lista compras ‚Üí instala/atualiza m√≥dulos.

> O modo h√≠brido permite come√ßar simples (key) e evoluir (account + 1-click).

## 1.2 ‚ùå O que n√£o √©

- N√£o √© ‚ÄúDRM perfeito‚Äù. Dev que baixou o c√≥digo consegue modificar/remover checks. O objetivo √©:
  - proteger o canal oficial de distribui√ß√£o,
  - dificultar abuso em larga escala,
  - manter experi√™ncia profissional e audit√°vel.
- N√£o √© ‚Äúplugin runtime‚Äù. A instala√ß√£o continua sendo **compile-time** (copy + injection + schema merge).
- N√£o √© um package manager (npm). O m√≥dulo √© um artefato do Kaven (com manifest e wiring pr√≥prio).

---

# 2. OBJETIVOS, N√ÉO-OBJETIVOS E INVARIANTES

## 2.1 Objetivos

1) **DX de compra/instala√ß√£o**: `kaven marketplace install X` em minutos, sem bricolagem.  
2) **Seguran√ßa pragm√°tica**: assinatura de artefatos + valida√ß√£o de entitlement.  
3) **Modelo h√≠brido**: key + login (sem travar evolu√ß√£o).  
4) **Offline-friendly**: cache local; instala√ß√£o pode funcionar offline se artefato estiver em cache e licen√ßa ainda v√°lida.  
5) **Compatibilidade**: m√≥dulos versionados e compat√≠veis por faixa de `kaven.version`.  
6) **Auditoria**: downloads/purchases registr√°veis; trilha para suporte e disputa.

## 2.2 N√£o-objetivos

- N√£o vamos tentar impedir c√≥pia manual ‚Äúpara sempre‚Äù.  
- N√£o vamos exigir login para tudo (key flow deve existir).  
- N√£o vamos acoplar marketplace ao banco do cliente (separar ‚ÄúCloud DB‚Äù do ‚ÄúCustomer DB‚Äù).  
- N√£o vamos implementar ‚Äúapp store‚Äù com 100 features no MVP. MVP = cat√°logo + checkout + download + install.

## 2.3 Invariantes (contratos)

- CLI **nunca** deve gravar secrets em `kaven.config.json`.  
- Tokens e refresh tokens devem ficar em storage do usu√°rio (`~/.kaven`) ou keychain.  
- Downloads devem ser verific√°veis (checksum + assinatura).  
- Instala√ß√£o e remo√ß√£o devem ser **idempotentes** e ‚Äúsafety-first‚Äù (doc 3).  
- O cliente deve conseguir:
  - instalar m√≥dulo comprado,
  - atualizar m√≥dulo,
  - reinstalar depois,
  - remover m√≥dulo sem perder dados automaticamente.

---

# 3. ATORES, PAP√âIS E JORNADAS

## 3.1 Atores

- **Dev/Buyer (usu√°rio do CLI)**: compra e instala m√≥dulos no pr√≥prio projeto.
- **Team/Admin (conta)**: gerencia compras e assentos (opcional no MVP).
- **Author (community)**: publica m√≥dulos (submiss√£o + review + release).
- **Kaven Admin**: aprova, revoga, responde incidentes, faz payout.
- **Payment Provider (Paddle)**: processa pagamentos, impostos, chargebacks (MoR).

## 3.2 Jornadas principais (MVP)

### A) Buyer com license key (sem login)

1) Compra no site ‚Üí recebe `LICENSE_KEY`.  
2) Executa: `kaven marketplace install <slug> --key <LICENSE_KEY>`  
3) CLI valida key e baixa o artefato.  
4) CLI verifica assinatura, instala m√≥dulo via engine de m√≥dulos.  

### B) Buyer com conta (login)

1) Executa `kaven login` ‚Üí autentica no browser ‚Üí CLI recebe tokens.  
2) Executa `kaven marketplace install <slug>` (sem key).  
3) API verifica entitlement e libera download.  
4) CLI instala via engine de m√≥dulos.  

### C) Buyer ‚Äúclaim‚Äù de key para conta

1) Usu√°rio compra via key, depois faz login.  
2) Executa `kaven marketplace claim --key <LICENSE_KEY>`  
3) Key vira entitlement permanente na conta.

---

# 4. THREAT MODEL (SEGURAN√áA)

## 4.1 O que queremos impedir (realista)

- **MITM/tampering** no download (alterar pacote): mitigado por assinatura.  
- **Reupload malicioso** por terceiros: mitigado por ‚Äúartifact signing‚Äù + downloads s√≥ do host oficial.  
- **Uso indevido de license key** em larga escala: mitigado por:
  - limita√ß√£o de downloads por key,
  - binding opcional (key ‚Üî conta),
  - rate limiting,
  - revoga√ß√£o.
- **Supply chain** (m√≥dulo community com backdoor): mitigado por:
  - CI com checks,
  - code review,
  - scanning,
  - assinatura e publisher identity.

## 4.2 O que N√ÉO d√° para impedir (aceitamos)

- Dev com acesso ao c√≥digo pode remover checks e redistribuir.  
  O objetivo √© reduzir incentivo/escala, n√£o ‚ÄúDRM inviol√°vel‚Äù.

## 4.3 Controles m√≠nimos (MVP)

- TLS obrigat√≥rio (HTTPS).  
- Artefatos assinados (Ed25519) + checksum SHA-256.  
- Entitlement token de download com expira√ß√£o curta (ex: 5 min).  
- Audit log de downloads + webhooks de pagamento.  
- Revoga√ß√£o de m√≥dulo/vers√£o (kill switch no marketplace, n√£o no projeto do cliente).

---

# Parte II ‚Äî AS-IS (estado real do repo)

# 5. INVENT√ÅRIO DO CLI HOJE (AS-IS)

## 5.1 Comandos existentes (repo atual)

No boilerplate atual (`/home/bychrisr/projects/kaven-boilerplate/kaven-cli/src/index.ts`), existem:
- `kaven update` (placeholder; `--check` n√£o implementado)
- `kaven module add/remove/list` (store local + injection hardcoded)
- `kaven db generate` (merge split-schema base+extended)

N√£o existe:
- `kaven login/logout/whoami`
- `kaven marketplace ...`
- `kaven install ...`
- `kaven create-module/test-module`

## 5.2 Store local (repo atual)

Existe store local dentro do repo:
- `kaven-cli/modules/observability`
- `kaven-cli/modules/payments`

E o engine atual instala copiando para:
- `apps/api/src/modules/<name>`
- `apps/admin/app/[locale]/(dashboard)/<name>`

## 5.3 Drift importante (repo atual)

- `ProjectInitializer` escreve `payments-stripe`/`payments-mercadopago` em `kaven.config.json`.
- `ModuleManager` trabalha com `payments`/`observability` e valida placeholders (`ai-assistant`, `analytics`).

> Este drift precisa ser resolvido no TO-BE (ver doc 3, se√ß√£o de nomenclatura).

---

# 6. LACUNAS E DRIFTS RELEVANTES

## 6.1 N√£o existe backend ‚ÄúKaven Cloud‚Äù

Para marketplace/auth funcionar, precisamos de um backend separado (ou um app dedicado), com:
- contas/usu√°rios
- purchases via Paddle
- entitlements/licen√ßas
- cat√°logo de m√≥dulos e vers√µes
- downloads assinados

## 6.2 N√£o existe ‚Äúmanifest + assinatura‚Äù no store

No AS-IS:
- m√≥dulos do store s√£o pastas com arquivos, sem `module.json`
- o wiring √© hardcoded no `ModuleManager`

No TO-BE:
- cada m√≥dulo ter√° `module.json`
- cada release ter√° artefato empacotado + assinado

---

# Parte III ‚Äî TO-BE (spec detalhada)

# 7. ARQUITETURA DO SISTEMA (VIS√ÉO MACRO)

## 7.1 Componentes (recomendado)

1) **CLI (local):** `@kaven/cli`  
   - AuthManager (tokens)
   - MarketplaceClient (API)
   - DownloadManager (cache + verify)
   - ModuleInstaller (ponte para engine do doc 3)

2) **Kaven Cloud API (remoto):**
   - Auth (OIDC/OAuth2.1)
   - Marketplace (modules, versions, pricing)
   - Licensing (entitlements, keys)
   - Billing integration (Paddle + webhooks)
   - Downloads (signed URLs / streaming)

3) **Storage de artefatos (remoto):**
   - S3/R2/GCS com objetos imut√°veis por hash
   - URLs pr√©-assinadas para download

4) **CI/CD de publica√ß√£o (authors):**
   - valida√ß√µes autom√°ticas
   - build do artefato
   - assinatura
   - publica√ß√£o no cat√°logo

## 7.2 ‚ÄúSingle source of truth‚Äù

- **Cat√°logo remoto** √© o source-of-truth do marketplace (m√≥dulos vend√°veis).  
- **`kaven.config.json`** √© o source-of-truth do estado do projeto (m√≥dulos instalados/removidos, vers√µes, lock).  
- **`~/.kaven/*`** √© o source-of-truth do estado do usu√°rio local (tokens, cache, prefer√™ncias).

---

# 8. AUTENTICA√á√ÉO DO CLI (H√çBRIDA)

## 8.1 Requisitos

- Login deve funcionar sem ‚Äúcopiar token manualmente‚Äù.  
- Suportar CI (headless) via `KAVEN_TOKEN`/`KAVEN_LICENSE_KEY` (opcional).  
- Tokens devem ser rotacion√°veis e revog√°veis.  
- CLI deve funcionar mesmo sem login usando `--key` (para casos simples).

## 8.2 Op√ß√µes de implementa√ß√£o (OAuth)

### Op√ß√£o A (recomendada): Device Code Flow

Pr√≥s:
- simples, cross-platform
- n√£o depende de loopback server local
- UX boa em terminal

Fluxo:
1) CLI pede `device_code` ao backend.
2) CLI mostra URL + c√≥digo e tenta abrir browser.
3) CLI faz polling at√© o usu√°rio autenticar.
4) Backend retorna `access_token` + `refresh_token`.

### Op√ß√£o B: Authorization Code + PKCE (loopback)

Pr√≥s:
- padr√£o web
Contras:
- precisa abrir porta local (firewalls)
- mais fric√ß√£o em alguns ambientes

**Recomenda√ß√£o:** comece com Device Code; PKCE pode ser ‚Äúnice-to-have‚Äù.

## 8.3 Tokens e escopos

Recomenda√ß√£o:
- `access_token` (JWT) curto: 10‚Äì15 min
- `refresh_token` longo: 30‚Äì90 dias (rotating refresh tokens)
- scopes:
  - `marketplace:read`
  - `marketplace:purchase`
  - `marketplace:download`
  - `author:publish` (para authors)
  - `admin:*` (interno)

## 8.4 Storage local de credenciais

**Regra:** n√£o salvar tokens em arquivos do projeto.

Paths sugeridos (ver ap√™ndice):
- Linux/macOS: `~/.kaven/credentials.json` (0600)
- Windows: `%USERPROFILE%\\.kaven\\credentials.json`

Recomenda√ß√£o forte:
- usar **keychain** quando poss√≠vel (`keytar`)
- fallback para arquivo com permiss√µes restritas

## 8.5 Comandos de auth (UX)

- `kaven login`
- `kaven logout`
- `kaven whoami`
- `kaven auth status` (opcional; alias)

---

# 9. LICEN√áAS, ENTITLEMENTS E OWNERSHIP

## 9.1 Defini√ß√µes

- **Purchase**: evento de compra (pago/refund/chargeback).  
- **Entitlement**: permiss√£o ativa de baixar/usar um m√≥dulo (geralmente derivada de purchase).  
- **License Key**: token ‚Äútransport√°vel‚Äù que pode ser:
  - usado sem login, ou
  - ‚Äúclaimado‚Äù para uma conta.

## 9.2 Tipos de licen√ßa (recomendado)

MVP:
- **Perpetual (one-time)**: compra √∫nica, acesso a vers√µes dentro de uma faixa (ex: 1.x) ou por tempo (12 meses de updates).

Evolu√ß√£o:
- **Subscription**: acesso enquanto assinatura ativa.
- **Team seats**: X assentos, pol√≠ticas por org.

## 9.3 ‚ÄúVoc√™ n√£o √© dono do m√≥dulo‚Äù

No marketplace, m√≥dulos podem ser:
- **Kaven-owned** (first-party)
- **Author-owned** (community)

O CLI deve comunicar:
- ‚ÄúYou don‚Äôt own this module; license grants usage + updates per policy.‚Äù

## 9.4 Pol√≠ticas de update (importante para DX)

Definir por m√≥dulo:
- `updatePolicy`:
  - `lifetime` (somente first-party tiers)
  - `12_months_updates`
  - `subscription`
- `supportPolicy`:
  - ‚Äúbest-effort community‚Äù
  - ‚ÄúKaven supported‚Äù

> O CLI deve conseguir responder: ‚Äúposso atualizar este m√≥dulo?‚Äù sem ambiguidade.

---

# 10. MARKETPLACE: CAT√ÅLOGO, COMPRA E DOWNLOADS

## 10.1 Modelo de cat√°logo (m√≠nimo)

Um m√≥dulo no marketplace deve ter:
- `id` (uuid)
- `slug` (ex: `payments-mercadopago`)
- `displayName`
- `description`
- `category`
- `pricing` (one-time/subscription, currency, priceId do Paddle)
- `compat`:
  - `kaven: "^2.0.0"`
  - `node: ">=18"`
- `publisher` (Kaven ou author)
- `versions[]` (SemVer)

## 10.2 Fluxos de compra (MVP)

### A) Compra fora do CLI (site) ‚Üí license key

- Paddle checkout no site
- email/portal entrega a license key
- CLI s√≥ precisa validar e instalar

### B) Compra via CLI (abre browser)

1) `kaven marketplace buy <slug>` abre URL do checkout.
2) CLI entra em ‚Äúwaiting mode‚Äù:
   - polling `GET /purchases/:id`
   - ou ‚Äúpress enter after payment‚Äù
3) Compra confirmada via webhook ‚Üí entitlement criado.
4) CLI instala.

### C) 1-click purchase (evolu√ß√£o)

Somente quando:
- usu√°rio logado
- payment method salvo no Paddle
- backend consegue criar purchase via API

> Recomenda√ß√£o: deixar como fase 2. MVP pode ser ‚Äúabre checkout‚Äù.

## 10.3 Downloads (MVP)

**Requisito:** download deve ser ‚Äúcapable de ser auditado + revogado‚Äù.

Proposta:
- CLI chama `POST /modules/:slug/download-token`
- Backend valida entitlement e retorna:
  - `downloadUrl` (pre-signed; expira r√°pido)
  - `sha256`
  - `signature` (Ed25519) do artefato
  - `module.json` (metadados)
- CLI baixa, valida, cacheia e instala.

## 10.4 Cache local

Estrutura sugerida:

```
~/.kaven/
‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îî‚îÄ‚îÄ modules/
‚îÇ       ‚îî‚îÄ‚îÄ <slug>/
‚îÇ           ‚îî‚îÄ‚îÄ <version>/
‚îÇ               ‚îú‚îÄ‚îÄ module.tgz
‚îÇ               ‚îú‚îÄ‚îÄ module.tgz.sha256
‚îÇ               ‚îî‚îÄ‚îÄ module.tgz.sig
‚îî‚îÄ‚îÄ credentials.json
```

Cache rules:
- n√£o baixar novamente se hash igual
- permitir `--no-cache` e `cache clean`

---

# 11. EMPACOTAMENTO E ASSINATURA DE M√ìDULOS

## 11.1 Formato do m√≥dulo (source)

No reposit√≥rio do m√≥dulo (ou no registry), o layout segue o doc 3:

```
<module>/
‚îú‚îÄ‚îÄ module.json
‚îú‚îÄ‚îÄ api/          # opcional
‚îú‚îÄ‚îÄ admin/        # opcional
‚îú‚îÄ‚îÄ prisma/       # opcional
‚îî‚îÄ‚îÄ docs/         # recomendado
```

## 11.2 Artefato public√°vel (build output)

Cada release gera um artefato imut√°vel:
- `module.tgz` (ou `.zip`)
- `sha256` do arquivo
- `signature` Ed25519 do `sha256` (ou do conte√∫do completo)

## 11.3 Assinatura (recomendado)

- Algoritmo: Ed25519
- Chave privada: somente Kaven Publish Pipeline (HSM/Secret Manager)
- Chave p√∫blica: embutida no CLI (pode ter rota√ß√£o)

Verifica√ß√£o no CLI:
1) calcular `sha256` do arquivo baixado
2) verificar assinatura do hash com `publicKey`
3) comparar com `sha256` retornado pela API

> Se falhar: abortar instala√ß√£o e alertar ‚Äúartifact integrity failed‚Äù.

---

# 12. API DO MARKETPLACE (ENDPOINTS)

## 12.1 Conven√ß√µes

- Base URL: `https://api.kaven.dev` (exemplo)
- JSON por padr√£o
- Auth: `Authorization: Bearer <access_token>`
- Rate limiting em endpoints sens√≠veis

## 12.2 Auth (device code)

### `POST /oauth/device/code`

Response:
```json
{
  "device_code": "abc",
  "user_code": "KAVEN-7H2K",
  "verification_uri": "https://kaven.dev/device",
  "verification_uri_complete": "https://kaven.dev/device?code=KAVEN-7H2K",
  "expires_in": 600,
  "interval": 5
}
```

### `POST /oauth/token`

Request (polling):
```json
{ "device_code": "abc", "grant_type": "urn:ietf:params:oauth:grant-type:device_code" }
```

Response:
```json
{
  "access_token": "jwt",
  "refresh_token": "rt",
  "expires_in": 900,
  "token_type": "Bearer",
  "scope": "marketplace:read marketplace:download"
}
```

## 12.3 Marketplace (read)

### `GET /modules?query=...&category=...`

Response:
```json
{
  "items": [
    {
      "slug": "payments-mercadopago",
      "displayName": "Mercado Pago",
      "category": "commerce",
      "publisher": { "type": "author", "name": "john" },
      "latestVersion": "1.2.0",
      "pricing": { "type": "one_time", "amount": 49, "currency": "USD" }
    }
  ]
}
```

### `GET /modules/:slug`

Inclui:
- descri√ß√£o completa
- compat
- changelog
- vers√µes
- requirements (env vars)

## 12.4 Licen√ßas / entitlements

### `POST /licenses/validate`

Request:
```json
{ "licenseKey": "KVN-XXXX-YYYY-ZZZZ", "moduleSlug": "payments-mercadopago" }
```

Response:
```json
{ "valid": true, "entitlementId": "uuid", "canDownload": true }
```

### `POST /licenses/claim`

Requer login:
```json
{ "licenseKey": "KVN-..." }
```

## 12.5 Downloads

### `POST /modules/:slug/download-token`

Request:
```json
{ "version": "1.2.0", "licenseKey": "KVN-..." }
```

Response:
```json
{
  "downloadUrl": "https://storage.../module.tgz?sig=...",
  "sha256": "hex",
  "signature": "base64",
  "publicKeyId": "kaven-2026-01",
  "module": { "slug": "payments-mercadopago", "version": "1.2.0" }
}
```

---

# 13. BANCO DE DADOS DO MARKETPLACE (SCHEMA)

> O banco do marketplace √© **separado** do banco do boilerplate do cliente.

## 13.1 Modelo (alto n√≠vel)

- `users` (contas Kaven)
- `device_auth_sessions` (device code)
- `modules` (cat√°logo)
- `module_versions`
- `module_artifacts` (hash, signature, storage key)
- `purchases` (status, paddle ids)
- `entitlements` (direito ativo de download)
- `license_keys` (tokens transport√°veis)
- `downloads` (audit)
- `revenue_shares` (para authors)

## 13.2 Exemplo (pseudo-Prisma)

```prisma
model MarketplaceUser {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  purchases Purchase[]
}

model MarketplaceModule {
  id          String   @id @default(uuid())
  slug        String   @unique
  displayName String
  category    String
  publisherId String?
  createdAt   DateTime @default(now())
  versions    ModuleVersion[]
}

model ModuleVersion {
  id        String @id @default(uuid())
  moduleId  String
  version   String
  kavenCompat String
  status    String // draft|published|revoked
  artifact  ModuleArtifact?
  createdAt DateTime @default(now())

  module MarketplaceModule @relation(fields: [moduleId], references: [id])

  @@unique([moduleId, version])
}

model ModuleArtifact {
  id        String @id @default(uuid())
  versionId String @unique
  storageKey String
  sha256    String
  signature String
  publicKeyId String
  createdAt DateTime @default(now())

  version ModuleVersion @relation(fields: [versionId], references: [id])
}

model Purchase {
  id        String @id @default(uuid())
  userId    String?
  moduleId  String
  moduleVersionId String?
  status    String // pending|paid|refunded|chargeback
  paddleTransactionId String?
  createdAt DateTime @default(now())

  module MarketplaceModule @relation(fields: [moduleId], references: [id])
  user   MarketplaceUser? @relation(fields: [userId], references: [id])
}

model Entitlement {
  id        String @id @default(uuid())
  moduleId  String
  userId    String?
  status    String // active|revoked|expired
  updatePolicy String // 12_months_updates|lifetime|subscription
  expiresAt DateTime?
  createdAt DateTime @default(now())

  module MarketplaceModule @relation(fields: [moduleId], references: [id])
  user   MarketplaceUser? @relation(fields: [userId], references: [id])
}

model LicenseKey {
  id           String @id @default(uuid())
  keyHash      String @unique
  moduleId     String
  entitlementId String?
  claimedByUserId String?
  createdAt    DateTime @default(now())
  revokedAt    DateTime?
}
```

---

# 14. INTEGRA√á√ÉO COM PADDLE (CHECKOUT + WEBHOOKS)

## 14.1 MVP recomendado

- Checkout via Paddle Hosted Checkout (browser)
- Webhook receiver no Kaven Cloud
- Purchase status atualizado por webhook (fonte de verdade)

## 14.2 Webhooks m√≠nimos

Processar eventos equivalentes a:
- pagamento aprovado
- pagamento recusado/expirado
- refund
- chargeback
- assinatura cancelada (se houver)

Regra:
- webhook cria/atualiza `Purchase`
- purchase cria/atualiza `Entitlement`
- entitlement habilita downloads

## 14.3 Seguran√ßa de webhooks

- validar assinatura do webhook (Paddle)
- idempot√™ncia por `event_id`
- audit log

> Existe documenta√ß√£o ‚Äúcrawler‚Äù no repo: `/home/bychrisr/projects/kaven-boilerplate/docs/external/paddle.md`.

---

# 15. INTEGRA√á√ÉO COM O MODULE SYSTEM (DOC 3)

## 15.1 Princ√≠pio

Marketplace n√£o reimplementa ‚Äúinstala√ß√£o‚Äù.
Ele apenas:
1) autentica/valida licen√ßa
2) baixa artefato
3) verifica assinatura
4) entrega para a engine de `add/remove` do doc 3

## 15.2 Interface sugerida (CLI)

- `MarketplaceInstaller.download(slug, version)`
- `ModuleManager.addModuleFromPath(slug, extractedPath)` (TO-BE)

Ou:
- CLI baixa para `~/.kaven/cache/...`
- copia para um ‚Äústore temp‚Äù
- chama `kaven module add <slug> --from-cache`

## 15.3 Regras de compatibilidade

Antes de instalar, validar:
- `compat.kaven` vs `kaven.config.json:kaven.version`
- `compat.node` vs `process.version`
- deps core (auth/tenants/etc) vs invent√°rio

---

# 16. PIPELINE DE PUBLICA√á√ÉO DE M√ìDULOS (AUTHORS)

## 16.1 MVP (governan√ßa)

Para evitar ‚Äúsupply chain horror‚Äù no primeiro ciclo:
- publica√ß√£o s√≥ via PR em repo oficial de m√≥dulos
- CI roda checks
- Kaven aprova manualmente
- pipeline assina e publica

## 16.2 Checks m√≠nimos (CI)

- lint / typecheck
- ‚Äúinstall/remove idempotency‚Äù em projeto fixture
- verifica√ß√£o de anchors (existem? 1x?)
- verifica√ß√£o de `module.json` (schema)
- detec√ß√£o de arquivos proibidos (ex: `.env`, secrets)

---

# Parte IV ‚Äî Plano de Implementa√ß√£o

# 17. ROADMAP T√âCNICO (MVP ‚Üí EVOLU√á√ÉO)

## 17.1 Fase 0 ‚Äî Fundamentos (pr√©-requisito)

- Normalizar naming do module system (doc 3): `payments` vs `payments-stripe` etc.
- Introduzir `module.json` no store local e remover hardcode do `ModuleManager` (TO-BE do doc 3).

## 17.2 Fase 1 ‚Äî Auth do CLI (MVP)

- `kaven login/logout/whoami`
- device code flow
- storage seguro de tokens
- `MarketplaceClient` com `GET /modules` (read-only)

## 17.3 Fase 2 ‚Äî Downloads assinados (MVP)

- endpoint `download-token`
- storage S3/R2
- assinatura Ed25519
- `DownloadManager` (cache + verify)

## 17.4 Fase 3 ‚Äî Purchases + license keys (MVP)

- checkout via browser
- webhook receiver
- emiss√£o de license keys
- `kaven marketplace install --key`

## 17.5 Fase 4 ‚Äî Evolu√ß√£o

- 1-click purchase
- team/org entitlements
- author self-service dashboard
- marketplace p√∫blico (submiss√µes)

---

# 18. CHECKLIST DE ACEITA√á√ÉO (DEFINITION OF DONE)

MVP ‚ÄúAuth + Marketplace‚Äù est√° pronto quando:

- `kaven login` funciona em macOS/Linux/Windows (device code).
- tokens s√£o persistidos com seguran√ßa (keychain quando poss√≠vel).
- `kaven marketplace search` lista m√≥dulos remotos.
- `kaven marketplace install <slug> --key <key>`:
  - valida key
  - baixa artefato
  - verifica assinatura
  - instala via engine de m√≥dulos
- downloads s√£o audit√°veis e podem ser revogados server-side (bloquear novas descargas).
- n√£o existe vazamento de secrets em `kaven.config.json`.

---

# 19. ESTRAT√âGIA DE TESTES

## 19.1 CLI

- unit tests:
  - AuthManager (storage)
  - MarketplaceClient (mock server)
  - DownloadManager (hash/signature)
- integration tests:
  - fluxo completo ‚Äúinstall by key‚Äù contra um mock API

## 19.2 Backend

- testes de webhook idempotente
- testes de emiss√£o de license keys
- testes de revoga√ß√£o

---

# 20. OBSERVABILIDADE, LOGS E TELEMETRIA (PRIVACY-FIRST)

Princ√≠pios:
- telemetria deve ser **opt-in** (ou no m√≠nimo f√°cil de desativar)
- nunca enviar paths, tokens, license keys
- enviar somente:
  - vers√£o do CLI
  - comandos (categoria)
  - sucesso/falha (classe de erro)

---

# Parte V ‚Äî Ap√™ndices

# 21. ESPECIFICA√á√ÉO DE COMANDOS (UX)

## 21.1 Auth

```bash
kaven login
kaven logout
kaven whoami
```

## 21.2 Marketplace

```bash
kaven marketplace search <query>
kaven marketplace info <slug>
kaven marketplace buy <slug>
kaven marketplace install <slug> [--version x.y.z] [--key KVN-...]
kaven marketplace claim --key KVN-...
kaven marketplace update <slug>
```

## 21.3 Utilit√°rios

```bash
kaven cache clean
kaven cache path
```

---

# 22. ARQUIVOS LOCAIS DO CLI (PATHS)

- Config global: `~/.kaven/config.json`
- Credenciais: `~/.kaven/credentials.json` (ou keychain)
- Cache: `~/.kaven/cache/modules/...`

---

# 23. FORMATOS DE TOKENS E ARQUIVOS

## 23.1 credentials.json (fallback)

```json
{
  "accessToken": "jwt",
  "refreshToken": "rt",
  "expiresAt": "2026-01-22T05:00:00Z",
  "scopes": ["marketplace:read", "marketplace:download"]
}
```

## 23.2 config.json (global)

```json
{
  "apiBaseUrl": "https://api.kaven.dev",
  "telemetry": { "enabled": false }
}
```

---

# 24. EXEMPLOS (RESPONSES, MANIFESTS, OUTPUTS)

## 24.1 Output ‚Äúinstall by key‚Äù

```
$ kaven marketplace install payments-mercadopago --key KVN-XXXX-YYYY-ZZZZ

üîë Validating license...
‚úÖ License valid (entitlement active)

‚¨áÔ∏è  Downloading module artifact...
‚úÖ Downloaded (sha256 ok, signature ok)

üì¶ Installing module (copy + injection)...
‚úÖ Installed: payments-mercadopago@1.2.0

Next steps:
- Add required env vars (see module docs)
- Run: pnpm db:generate
- Restart dev server
```

---

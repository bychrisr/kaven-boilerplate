# Planos, Entitlements & Gating — Modelo Robusto (Kaven)

**Versão:** 1.0  
**Objetivo:** Definir um pilar completo e seguro para **Planos**, **Products/Add-ons**, **Entitlements (direitos do tenant)**, **limites (quotas)**, **gating de funcionalidades**, e a integração correta com **Spaces/Roles/Grants** sem misturar monetização com segurança.  
**Escopo:** SaaS multi-tenant com monetização por tiers, add-ons, limites de uso, upgrades/downgrades, trial e acessos condicionais.

---

## 1. Visão Geral

No Kaven, existe uma separação intencional e obrigatória entre:

- **Autorização (Security / Access Control)**:  
  Decide **quem** (usuário) pode fazer **o quê** (ação) em **qual contexto** (Space/escopo).  
  Baseado em **Spaces + Roles + Grants + Policies**.

- **Entitlements (Produto / Monetização / Direitos do Tenant)**:  
  Decide **o que** um **tenant** tem direito a usar, baseado no **plano** e **produtos** contratados.

Princípio fundamental:

> Uma ação só é permitida se for **autorizada** para o usuário **E** estiver **habilitada** para o tenant.  
> **Allowed = Authorized(user, action, resource) AND Entitled(tenant, feature/capability)**

Isso evita o erro clássico de “esconder menu” no frontend e deixar o backend exposto.

---

## 2. Definições

### 2.1 Plan (Plano)

Um plano representa um conjunto de direitos base do tenant, geralmente por assinatura (mensal/anual), que inclui:

- features habilitadas,
- limites (quotas),
- políticas (ex.: export permitido),
- e, opcionalmente, benefícios de contrato (ex.: suporte, updates).

### 2.2 Product (Produto)

Um produto é um item comercializável que pode:

- habilitar uma feature,
- aumentar um limite,
- adicionar um módulo,
- ou conceder uma permissão específica do produto.

Produtos podem ser:

- **add-ons recorrentes** (ex.: “CRM Pro” mensal),
- **one-time** (ex.: “Setup Fee”),
- **consumables** (ex.: créditos).

### 2.3 Entitlement (Direito)

Entitlement é a **materialização** do que o tenant pode usar:

- flags booleanas (on/off),
- quotas numéricas,
- níveis de acesso (read-only vs full),
- e regras de expiração/reset.

### 2.4 Feature Flag vs Entitlement

- **Feature Flag** é tipicamente para rollout/experimento (time interno).
- **Entitlement** é direito de uso (contrato do cliente).

No Kaven, “feature gating por plano” deve ser tratado como **entitlement**, não como flag.

### 2.5 Quota / Limit

Quota é um limite mensurável que pode ser:

- máximo total (ex.: usuários máximos),
- por período (ex.: API calls por dia),
- acumulativo (ex.: storage total),
- por item (ex.: projetos por tenant).

### 2.6 Capability (Produto)

Para monetização, “capability” é tratada como:

- algo que o tenant **tem direito** de acessar,
- e que o usuário pode ou não acessar via autorização.

Ex.: `crm.enabled` (entitlement) e `crm.read`/`crm.write` (authorization).

---

## 3. Separação Estrutural: Entitlements ≠ Permissões

### 3.1 O que é do Plano (Entitlements)

Exemplos:

- CRM habilitado?
- Files habilitado?
- Chat habilitado?
- Limite de usuários
- Limite de storage
- Exportação de dados permitida?
- Quantidade de integrações disponíveis

### 3.2 O que é do Usuário (Spaces/Roles/Grants)

Exemplos:

- Usuário pode ver CRM?
- Pode editar contatos?
- Pode exportar?
- Pode acessar billing?
- Pode impersonar?

**Não existe “usuário PRO”.**  
Usuário tem **roles**, tenant tem **planos**.

---

## 4. Modelo de Entitlements (Catálogo)

O sistema deve manter um **Catálogo de Entitlements** (registry) com chaves estáveis.

### 4.1 Tipos de Entitlements

#### 4.1.1 Boolean

- `crm.enabled = true/false`
- `files.enabled = true/false`
- `chat.enabled = true/false`

#### 4.1.2 Numeric (Quota)

- `users.max = 5`
- `storage.gb = 50`
- `projects.max = 20`
- `api.calls.month = 100000`

#### 4.1.3 Tiered (Níveis)

- `exports.level = none | basic | full`
- `support.level = standard | priority | vip`
- `audit_logs.retention_days = 30 | 90 | 365`

#### 4.1.4 Rate/Window

- `api.calls.window = 1d`
- `exports.window = 1d`
- `invites.window = 1h`

---

## 5. Como Planos e Produtos Compõem Entitlements

### 5.1 Composição de Entitlements do Tenant

Entitlements finais do tenant são calculados a partir de:

1. **Plano base**
2. **Produtos/Add-ons ativos**
3. **Overrides administrativos (exceção)**
4. **Políticas e regras de faturamento (trial, grace period, cancelamento)**

Princípio:

- Plano define o baseline.
- Produtos podem **adicionar**, **aumentar** ou **habilitar**.
- Overrides são exceção e devem ser auditados.

### 5.2 Regras de Efeito do Produto (Product Effects)

Cada produto pode ter efeitos declarativos:

- **ENABLE**: liga uma feature
  - Ex.: `crm.enabled = true`

- **INCREASE**: soma quota
  - Ex.: `users.max += 10`

- **MULTIPLY**: multiplica quota (raro)
  - Ex.: `api.calls.month *= 2`

- **SET_MINIMUM**: garante mínimo, respeitando maior
  - Ex.: `storage.gb = max(storage.gb, 200)`

- **SET_LEVEL**: define nível (tiered)
  - Ex.: `exports.level = full`

---

## 6. Gating: Onde e Como Aplicar

Gating deve existir em três camadas, sempre:

### 6.1 Camada 1 — Navegação/UI

- Esconder/mostrar menus e páginas conforme entitlement
- Mostrar bloqueio/upgrade quando indisponível
- Importante: UI **nunca** é a única barreira.

### 6.2 Camada 2 — Backend (Obrigatório)

Todas as rotas e ações sensíveis devem validar:

- autorização do usuário (Spaces/Roles/Grants)
- entitlement do tenant (Plan/Products)

### 6.3 Camada 3 — Domínio/Dados (Obrigatório)

Mesmo que uma rota seja indevidamente exposta, o domínio deve proteger:

- criação de recursos além da quota
- execução de operações não contratadas
- exportações e ações restritas

---

## 7. Matriz de Decisão (Truth Table)

Uma ação só executa se:

- **Authorized = true**
- **Entitled = true**

Casos:

1. Authorized ✅ / Entitled ✅ → **Permitir**
2. Authorized ✅ / Entitled ❌ → **Bloquear com mensagem de upgrade**
3. Authorized ❌ / Entitled ✅ → **Bloquear por permissão**
4. Authorized ❌ / Entitled ❌ → **Bloquear (genérico)**

Mensagens devem ser distintas:

- Caso 2: “Disponível no plano X”
- Caso 3: “Você não tem permissão”

---

## 8. Quotas (Limites) — Modelo Completo

### 8.1 Tipos de Quota

#### 8.1.1 Hard Limit

Não permite ultrapassar.

- Ex.: `users.max`

#### 8.1.2 Soft Limit (com grace)

Permite ultrapassar temporariamente (configurável).

- Ex.: storage com “grace” de 7 dias

#### 8.1.3 Periodic Quota (reset)

Zera por período.

- Ex.: `api.calls.month`, reseta mensalmente

#### 8.1.4 Consumable Credits

Diminui conforme uso.

- Ex.: `ai_credits.remaining`

### 8.2 Rastreamento de Uso (Usage Tracking)

Para cada quota deve existir um modelo claro:

- unidade (count, bytes, minutes)
- período (lifetime, monthly, daily)
- reset policy
- fonte de verdade (domínio que incrementa)

### 8.3 Ações ao Atingir o Limite

Definir resposta padrão:

- **Block + Upgrade prompt** (default)
- **Allow + Notify** (somente se permitido)
- **Allow + Charge overage** (opcional; requer billing robusto)

---

## 9. Entitlements e Spaces: Integração Correta

### 9.1 Space só existe se tenant tiver direito?

Existem duas abordagens válidas:

**A) Space Condicional (recomendado para módulos grandes)**

- Space “Marketing” só aparece se `marketing.enabled = true`
- Evita UI poluída e reduz confusão

**B) Space sempre aparece, mas com páginas bloqueadas**

- Útil se “Marketing” existir como proposta, mas não contratado
- Pode aumentar conversão por exposição

Regra recomendada:

- Para planos inferiores: mostrar como “locked” com CTA de upgrade
- Para ambientes enterprise: pode ocultar completamente por compliance

### 9.2 Acesso do Usuário dentro do Space

Mesmo que o tenant tenha direito:

- usuário precisa estar **membro do space**
- com role e capabilities apropriadas

---

## 10. Overrides de Entitlement (Exceções Comerciais)

Assim como Grants de permissão, é comum precisar de exceções:

- liberar CRM por 7 dias (trial estendido)
- aumentar quota de usuários temporariamente
- conceder export “full” para um cliente específico

### 10.1 Regras de Governança

- Overrides devem ser:
  - time-bound por default
  - auditados
  - justificativa obrigatória
  - revisados periodicamente

### 10.2 Entitlement Override ≠ Permission Grant

- Override altera direitos do **tenant**
- Grant altera permissões do **usuário**

Os dois podem coexistir, mas não se substituem.

---

## 11. Trials, Grace Periods e Downgrades

### 11.1 Trial

Durante trial:

- entitlements podem refletir um plano superior
- ao finalizar, reverte automaticamente

### 11.2 Grace Period

Após falha de pagamento:

- manter entitlements por X dias
- ou degradar gradualmente (ex.: read-only)

### 11.3 Downgrade (redução de plano)

Problema clássico:

- o tenant pode ter recursos acima do novo limite

Estratégias:

1. **Enforce on write**: permite visualizar, mas bloqueia criação
2. **Archival/Lock**: bloqueia acesso a excedentes até ajustar
3. **Prune (não recomendado)**: deletar dados automaticamente é perigoso

Regra recomendada:

- nunca deletar automaticamente
- bloquear novas criações e sinalizar ação necessária

---

## 12. Exportação, PII e Recursos Sensíveis (Entitlements Especiais)

Algumas features devem ser tratadas como “high-risk entitlements”:

- exportação de dados
- acesso a PII completo
- logs detalhados
- integrações externas

Recomendações:

- `exports.level` (none/basic/full)
- `pii.visibility` (masked/full)
- `audit_logs.retention_days`

Mesmo com entitlement habilitado, a autorização do usuário ainda é obrigatória.

---

## 13. Mensageria de Upgrade (Quando Entitled = false)

O bloqueio por plano precisa ser:

- claro
- contextual
- acionável

### 13.1 Resposta ideal ao usuário

- qual limite atingiu ou qual feature falta
- qual plano resolve
- link para upgrade
- alternativa (reduzir uso, arquivar, etc.)

### 13.2 “Feature Limit Hits” como métrica

Registrar quando:

- usuário tenta ação e é bloqueado por plano
- qual feature/quota
- qual usuário e tenant
- isso alimenta Analytics e conversão

---

## 14. Padrões para Evitar Explosão de Planos

Perigo: criar planos demais para cobrir casos especiais.

Solução:

- manter poucos tiers
- usar produtos/add-ons para variações
- usar overrides temporários para exceções
- usar “feature bundles” (pacotes) quando fizer sentido

---

## 15. Estratégia de Implementação (Fases)

### Fase 1 — Fundacional

- Definir catálogo de entitlements
- Definir planos e seus entitlements
- Definir produtos e efeitos
- Implementar cálculo de entitlements do tenant

### Fase 2 — Enforcement

- Validar entitlements no backend (todas as ações sensíveis)
- Implementar tracking de uso (quotas)
- Implementar bloqueios e mensagens de upgrade

### Fase 3 — Governança & Comercial

- Overrides de entitlements (time-bound)
- Grace/trial/downgrade policies
- Auditoria e relatórios de exceções

---

## 16. Exemplos de Uso (Sem Código)

### 16.1 Tenant no plano Basic sem CRM

- `crm.enabled = false`
- Usuário em Marketing Space tenta abrir CRM
  - UI mostra “locked”
  - backend bloqueia qualquer chamada de CRM
  - CTA: upgrade para plano Complete

### 16.2 Tenant no plano Complete com CRM

- `crm.enabled = true`
- Usuário em Support Space não vê CRM (sem permissão)
- Admin concede grant temporário `crm.read` por 7 dias
  - usuário acessa CRM em read-only
  - auditado e expira automaticamente

### 16.3 Tenant downgraded e excedeu users.max

- Novo plano: `users.max = 5`
- Tenant tem 9 usuários
- Política: bloquear criação de novos usuários + banner de ação
- Mantém leitura e operação com usuários existentes até ajuste

---

## 17. Checklist de Robustez (Validação)

- [ ] Entitlements são por tenant, não por usuário
- [ ] Toda ação sensível valida autorização + entitlement
- [ ] Quotas possuem tracking, janela e reset definidos
- [ ] Exceções (overrides) são time-bound e auditadas
- [ ] Downgrades não deletam dados automaticamente
- [ ] Export/PII possuem entitlements e permissões separadas
- [ ] UI reflete entitlement, mas backend sempre reforça
- [ ] “Feature limit hits” é registrado para conversão/analytics

---

## 18. Glossário

- **Plan:** conjunto base de direitos do tenant
- **Product/Add-on:** item comercial que modifica direitos
- **Entitlement:** direito efetivo do tenant (feature/limite/nível)
- **Quota:** limite mensurável com política de uso
- **Gating:** bloqueio de feature por plano/entitlement
- **Authorization:** permissão do usuário (Spaces/Roles/Grants)
- **Override:** exceção de entitlement (tenant) ou grant (usuário)
- **Read-only:** modo de operação sem escrita, enforced no backend

---

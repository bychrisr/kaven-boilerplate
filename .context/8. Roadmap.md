## üìã Estrutura de Sa√≠da (Markdown)

### **Roadmap T√©cnico Faseado - Kaven Boilerplate**

#### **Fase 1: Funda√ß√£o do Projeto (1-2 dias)**

**Objetivo:** Configurar estrutura de pastas, reposit√≥rio, depend√™ncias base e ambiente de desenvolvimento.

**Tarefas:**

1.  **Criar estrutura de pastas e arquivos iniciais.**
    *   **Subtarefa 1.1:** Criar pasta raiz `kaven-boilerplate`.
    *   **Subtarefa 1.2:** Criar subpastas `backend`, `frontend`, `prisma`, `scripts`, `infra`, `docs` conforme definido.
    *   **Subtarefa 1.3:** Criar arquivos iniciais `.gitignore`, `README.md`, `.env.example`, `setup.sh`.
    *   **Subtarefa 1.4:** Criar `docker-compose.yml` b√°sico para PostgreSQL e Redis.
    *   **Crit√©rios de Aceita√ß√£o:** Estrutura de pastas clara, `.gitignore` configurado, `README.md` inicial com instru√ß√µes de setup.

2.  **Configurar backend (Node.js, Fastify, TypeScript).**
    *   **Subtarefa 2.1:** Iniciar `package.json` no `backend`.
    *   **Subtarefa 2.2:** Instalar depend√™ncias: `fastify`, `typescript`, `@types/node`, `prisma`, `@prisma/client`, `zod`, `dotenv`, `fastify-jwt`, `fastify-rate-limit`, `bcrypt`, `@fastify/autoload`, `@fastify/sensible`.
    *   **Subtarefa 2.3:** Configurar `tsconfig.json` para backend.
    *   **Subtarefa 2.4:** Criar `backend/src/app.ts` com configura√ß√£o b√°sica do Fastify (plugins, hooks, logging).
    *   **Crit√©rios de Aceita√ß√£o:** Projeto backend compila, servidor Fastify inicia com logging b√°sico.

3.  **Configurar frontend (React, Vite, TypeScript).**
    *   **Subtarefa 3.1:** Iniciar `package.json` no `frontend`.
    *   **Subtarefa 3.2:** Instalar depend√™ncias: `react`, `react-dom`, `typescript`, `vite`, `@vitejs/plugin-react`, `tailwindcss`, `radix-ui`, `@tanstack/react-query`, `zustand`.
    *   **Subtarefa 3.3:** Configurar `tsconfig.json` para frontend.
    *   **Subtarefa 3.4:** Configurar `vite.config.ts`.
    *   **Subtarefa 3.5:** Configurar Tailwind CSS.
    *   **Subtarefa 3.6:** Criar `frontend/src/App.tsx` e `frontend/src/main.tsx` b√°sicos.
    *   **Crit√©rios de Aceita√ß√£o:** Projeto frontend compila, servidor Vite inicia, p√°gina inicial React carrega.

4.  **Configurar Prisma com PostgreSQL.**
    *   **Subtarefa 4.1:** Instalar `prisma` como dev dependency no backend.
    *   **Subtarefa 4.2:** Inicializar Prisma (`npx prisma init`).
    *   **Subtarefa 4.3:** Ajustar `schema.prisma` com os modelos definidos (`Tenant`, `User`, `Plan`, `Metric`), RLS, √≠ndices.
    *   **Subtarefa 4.4:** Configurar `DATABASE_URL` no `.env` e `.env.example`.
    *   **Subtarefa 4.5:** Executar `npx prisma db push` para aplicar o schema no banco de desenvolvimento.
    *   **Crit√©rios de Aceita√ß√£o:** Schema Prisma est√° alinhado com a an√°lise t√©cnica, conex√£o com o banco √© estabelecida via Prisma Client.

#### **Fase 2: Implementa√ß√£o de Autentica√ß√£o e Autoriza√ß√£o (2-3 dias)**

**Objetivo:** Implementar fluxo completo de autentica√ß√£o (login, logout, refresh, recupera√ß√£o de senha) com JWT e RLS.

**Tarefas:**

1.  **Implementar autentica√ß√£o no backend.**
    *   **Subtarefa 1.1:** Criar `backend/src/services/auth.service.ts` (fun√ß√µes: `hashPassword`, `verifyPassword`, `generateTokens`, `verifyToken`).
    *   **Subtarefa 1.2:** Criar `backend/src/controllers/auth.controller.ts` (fun√ß√µes: `login`, `logout`, `refresh`, `forgotPassword`, `resetPassword`).
    *   **Subtarefa 1.3:** Criar `backend/src/routes/auth.routes.ts` e conectar ao `app.ts`.
    *   **Subtarefa 1.4:** Implementar middleware de autentica√ß√£o JWT (`backend/src/middleware/auth.middleware.ts`).
    *   **Subtarefa 1.5:** Adicionar valida√ß√£o de input com Zod para payloads de autentica√ß√£o.
    *   **Crit√©rios de Aceita√ß√£o:** Endpoints `/api/auth/login`, `/api/auth/forgot-password` funcionam conforme contrato. Middleware protege rotas. Tokens s√£o gerados e verificados corretamente.

2.  **Implementar autoriza√ß√£o e RLS.**
    *   **Subtarefa 2.1:** Configurar RLS no PostgreSQL para as tabelas `users` e `metrics` conforme an√°lise t√©cnica.
    *   **Subtarefa 2.2:** Criar middleware para extrair e definir o `tenantId` no contexto da requisi√ß√£o (`backend/src/middleware/tenant.middleware.ts`), baseado no token JWT.
    *   **Subtarefa 2.3:** Testar RLS com queries manuais no banco para garantir isolamento.
    *   **Crit√©rios de Aceita√ß√£o:** Usu√°rios s√≥ conseguem acessar dados do seu pr√≥prio tenant via API e banco (RLS ativado).

3.  **Implementar autentica√ß√£o no frontend.**
    *   **Subtarefa 3.1:** Criar `frontend/src/services/api.ts` com configura√ß√£o base para chamadas √† API (incluir `Authorization` header).
    *   **Subtarefa 3.2:** Criar `frontend/src/services/auth.service.ts` (fun√ß√µes: `login`, `logout`, `forgotPassword`).
    *   **Subtarefa 3.3:** Criar `frontend/src/hooks/useAuth.ts` para gerenciar estado de autentica√ß√£o (token, dados do usu√°rio, `isAuthenticated`).
    *   **Subtarefa 3.4:** Criar p√°ginas `frontend/src/pages/Login.tsx` e `frontend/src/pages/ForgotPassword.tsx` com formul√°rios e valida√ß√£o.
    *   **Subtarefa 3.5:** Implementar `ProtectedRoute` ou l√≥gica similar para redirecionar usu√°rios n√£o autenticados.
    *   **Crit√©rios de Aceita√ß√£o:** Fluxo de login/recupera√ß√£o de senha funciona. Token √© armazenado e utilizado nas chamadas √† API. Usu√°rios n√£o autenticados s√£o redirecionados.

4.  **Testes de Autentica√ß√£o.**
    *   **Subtarefa 4.1:** Escrever testes unit√°rios para `auth.service.ts`.
    *   **Subtarefa 4.2:** Escrever testes de integra√ß√£o para os endpoints `/api/auth/login`, `/api/auth/forgot-password`.
    *   **Crit√©rios de Aceita√ß√£o:** Cobertura de testes para l√≥gica de autentica√ß√£o e endpoints cr√≠ticos.

#### **Fase 3: Implementa√ß√£o de Gest√£o de Usu√°rios e Tenants (2-3 dias)**

**Objetivo:** Permitir que administradores gerenciem usu√°rios e tenants (listar, criar, editar, excluir).

**Tarefas:**

1.  **Implementar gest√£o de usu√°rios no backend.**
    *   **Subtarefa 1.1:** Criar `backend/src/services/user.service.ts` (fun√ß√µes: `createUser`, `findUserById`, `findUsersByTenantId`, `updateUser`, `deleteUser`).
    *   **Subtarefa 1.2:** Criar `backend/src/controllers/user.controller.ts` (fun√ß√µes: `getUsers`, `createUser`, `updateUser`, `deleteUser`).
    *   **Subtarefa 1.3:** Criar `backend/src/routes/user.routes.ts` e conectar ao `app.ts`.
    *   **Subtarefa 1.4:** Aplicar middleware de autentica√ß√£o e autoriza√ß√£o (`isAdm`) para proteger endpoints de gest√£o.
    *   **Subtarefa 1.5:** Adicionar valida√ß√£o de input com Zod para payloads de usu√°rio.
    *   **Crit√©rios de Aceita√ß√£o:** Endpoints `/api/users` funcionam conforme contrato, respeitando permiss√µes de administrador e RLS.

2.  **Implementar gest√£o de tenants no backend (se aplic√°vel).**
    *   **Subtarefa 2.1:** Criar `backend/src/services/tenant.service.ts` (fun√ß√µes: `createTenant`, `findTenantById`, `updateTenant`, `deleteTenant`).
    *   **Subtarefa 2.2:** Criar `backend/src/controllers/tenant.controller.ts` (fun√ß√µes: `getTenants`, `createTenant`, `updateTenant`, `deleteTenant`).
    *   **Subtarefa 2.3:** Criar `backend/src/routes/tenant.routes.ts` e conectar ao `app.ts`.
    *   **Subtarefa 2.4:** Aplicar middleware de autentica√ß√£o e autoriza√ß√£o (ex: `isGlobalAdm` - `[ASSUMPTION]` novo papel necess√°rio).
    *   **Subtarefa 2.5:** Adicionar valida√ß√£o de input com Zod para payloads de tenant.
    *   **Crit√©rios de Aceita√ß√£o:** Endpoints `/api/tenants` funcionam conforme contrato, protegidos por permiss√£o de administrador global.

3.  **Implementar gest√£o de usu√°rios no frontend.**
    *   **Subtarefa 3.1:** Criar `frontend/src/services/user.service.ts` (fun√ß√µes: `getUsers`, `createUser`, `updateUser`, `deleteUser`).
    *   **Subtarefa 3.2:** Criar `frontend/src/hooks/useUsers.ts` (fun√ß√µes: `useGetUsers`, `useCreateUser`, `useUpdateUser`, `useDeleteUser`) usando TanStack Query.
    *   **Subtarefa 3.3:** Criar p√°gina `frontend/src/pages/Users.tsx` com tabela de usu√°rios e modal de edi√ß√£o/cria√ß√£o.
    *   **Subtarefa 3.4:** Integrar hooks com os componentes da p√°gina.
    *   **Crit√©rios de Aceita√ß√£o:** P√°gina de gest√£o de usu√°rios permite visualizar, adicionar, editar e excluir usu√°rios (para administradores).

4.  **Testes de Gest√£o de Usu√°rios/Tenants.**
    *   **Subtarefa 4.1:** Escrever testes unit√°rios para `user.service.ts` e `tenant.service.ts`.
    *   **Subtarefa 4.2:** Escrever testes de integra√ß√£o para os endpoints `/api/users/*` e `/api/tenants/*`.
    *   **Crit√©rios de Aceita√ß√£o:** Cobertura de testes para l√≥gica de CRUD e endpoints de gest√£o.

#### **Fase 4: Implementa√ß√£o de Observabilidade e M√©tricas (1-2 dias)**

**Objetivo:** Configurar coleta, armazenamento e visualiza√ß√£o das m√©tricas m√≠nimas definidas no PDR.

**Tarefas:**

1.  **Coleta de M√©tricas no Backend.**
    *   **Subtarefa 1.1:** Instalar biblioteca de m√©tricas (ex: `prom-client`).
    *   **Subtarefa 1.2:** Criar e registrar m√©tricas definidas no PDR (`time_response_per_tenant`, `errors_per_tenant`, `queue_length_per_tenant`, `cpu_usage_per_tenant`) no `app.ts`.
    *   **Subtarefa 1.3:** Instrumentar rotas para registrar tempo de resposta e erros por tenant.
    *   **Subtarefa 1.4:** Expor endpoint `/metrics` para coleta do Prometheus.
    *   **Crit√©rios de Aceita√ß√£o:** Endpoint `/metrics` retorna dados no formato Prometheus, incluindo as m√©tricas definidas.

2.  **Armazenamento e Visualiza√ß√£o (Prometheus + Grafana).**
    *   **Subtarefa 2.1:** Adicionar Prometheus ao `docker-compose.yml`.
    *   **Subtarefa 2.2:** Configurar Prometheus para coletar m√©tricas do endpoint `/metrics` do backend.
    *   **Subtarefa 2.3:** Adicionar Grafana ao `docker-compose.yml`.
    *   **Subtarefa 2.4:** Configurar Grafana para usar Prometheus como datasource.
    *   **Subtarefa 2.5:** Criar dashboards b√°sicos no Grafana para visualizar as m√©tricas por tenant.
    *   **Crit√©rios de Aceita√ß√£o:** M√©tricas s√£o coletadas pelo Prometheus e visualizadas em dashboards no Grafana.

3.  **Implementa√ß√£o de obten√ß√£o de M√©tricas via API.**
    *   **Subtarefa 3.1:** Criar `backend/src/services/metric.service.ts` (fun√ß√µes: `getMetricsByTenantId`).
    *   **Subtarefa 3.2:** Criar `backend/src/controllers/metric.controller.ts` (fun√ß√µes: `getMetrics`).
    *   **Subtarefa 3.3:** Criar `backend/src/routes/metric.routes.ts` e conectar ao `app.ts`.
    *   **Subtarefa 3.4:** Aplicar middleware de autentica√ß√£o e RLS.
    *   **Subtarefa 3.5:** Adicionar valida√ß√£o de query params com Zod.
    *   **Subtarefa 3.6:** Criar `frontend/src/services/metric.service.ts` e `frontend/src/hooks/useMetrics.ts`.
    *   **Subtarefa 3.7:** Integrar hooks com componentes do Dashboard para exibir cards/gr√°ficos.
    *   **Crit√©rios de Aceita√ß√£o:** Endpoint `/api/metrics` funciona e retorna dados filtrados corretamente. Frontend exibe m√©tricas do tenant logado.

#### **Fase 5: Integra√ß√£o Final, Testes e Valida√ß√£o (1-2 dias)**

**Objetivo:** Garantir que todas as partes (frontend, backend, banco, observabilidade) funcionem juntas como um todo coeso e seguro.

**Tarefas:**

1.  **Verifica√ß√£o e Integra√ß√£o do Frontend.**
    *   **Subtarefa 1.1:** Verificar se todas as p√°ginas principais (Login, Dashboard, Users, ForgotPassword) est√£o criadas e estilizadas de acordo com a descri√ß√£o textual da UI.
    *   **Subtarefa 1.2:** Garantir que todos os endpoints definidos no contrato de API estejam implementados no backend.
    *   **Subtarefa 1.3:** Conectar todos os hooks do frontend com os servi√ßos e endpoints correspondentes.
    *   **Subtarefa 1.4:** Testar fluxos completos (login -> dashboard -> gest√£o de usu√°rios -> logout) manualmente.
    *   **Crit√©rios de Aceita√ß√£o:** Interface do usu√°rio est√° funcional e integrada com o backend. Todos os fluxos cr√≠ticos operam corretamente.

2.  **Testes de Integra√ß√£o e End-to-End.**
    *   **Subtarefa 2.1:** Escrever testes de integra√ß√£o para fluxos cr√≠ticos (ex: login completo, cria√ß√£o de usu√°rio).
    *   **Subtarefa 2.2:** (Opcional) Configurar e escrever testes E2E b√°sicos (ex: com Playwright).
    *   **Crit√©rios de Aceita√ß√£o:** Testes de integra√ß√£o passam, cobrindo intera√ß√µes entre diferentes camadas da aplica√ß√£o.

3.  **Verifica√ß√£o de Seguran√ßa e Preven√ß√£o de Retrabalho.**
    *   **Subtarefa 3.1:** Verificar a implementa√ß√£o de RLS no banco.
    *   **Subtarefa 3.2:** Verificar o uso de hashing para senhas.
    *   **Subtarefa 3.3:** Verificar a implementa√ß√£o de rate limiting.
    *   **Subtarefa 3.4:** Verificar o uso de headers de seguran√ßa (Helmet, CORS).
    *   **Subtarefa 3.5:** Verificar logs estruturados sem dados sens√≠veis.
    *   **Crit√©rios de Aceita√ß√£o:** Medidas de seguran√ßa definidas no PDR est√£o implementadas e ativas.

4.  **Documenta√ß√£o e Valida√ß√£o Final.**
    *   **Subtarefa 4.1:** Atualizar `README.md` com instru√ß√µes completas de setup e execu√ß√£o.
    *   **Subtarefa 4.2:** Verificar se os artefatos definidos no PDR (ex: `schema.prisma`, `API_Contracts.md` impl√≠cito nos arquivos), est√£o presentes e corretos.
    *   **Subtarefa 4.3:** Validar os crit√©rios de sucesso definidos no PDR.
    *   **Crit√©rios de Aceita√ß√£o:** Projeto est√° documentado, funcional, seguro e observ√°vel, alinhado com o PDR. Pronto para ser usado como boilerplate plug-and-play.
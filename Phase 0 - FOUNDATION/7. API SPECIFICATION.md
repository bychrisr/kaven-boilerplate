# API SPECIFICATION - Kaven Boilerplate

> **Version:** 1.0.0  
> **Date:** December 16, 2025  
> **Author:** Chris (@bychrisr)  
> **Type:** Complete API Documentation  
> **Status:** Foundation Phase

---

## üìã TABLE OF CONTENTS

1. [API Overview](#api-overview)
2. [Authentication Endpoints](#authentication-endpoints)
3. [User Management Endpoints](#user-management-endpoints)
4. [Tenant Management Endpoints](#tenant-management-endpoints)
5. [Payment Endpoints](#payment-endpoints)
6. [Invoice Endpoints](#invoice-endpoints)
7. [Order Endpoints](#order-endpoints)
8. [Audit Log Endpoints](#audit-log-endpoints)
9. [Health Check Endpoints](#health-check-endpoints)
10. [Error Codes](#error-codes)
11. [Rate Limiting](#rate-limiting)

---

## üéØ API OVERVIEW

### Base Information

- **Base URL:** `https://api.kaven.io` (production)
- **Base URL:** `http://localhost:8000` (development)
- **Protocol:** HTTPS only (TLS 1.3)
- **Format:** JSON (application/json)
- **Authentication:** JWT Bearer tokens
- **Versioning:** URL-based (v1, v2, etc) - future

---

### Global Headers

**Request Headers:**
```http
Content-Type: application/json
Authorization: Bearer <access_token>
X-Tenant-ID: <tenant_id> (optional, auto-detected from subdomain)
```

**Response Headers:**
```http
Content-Type: application/json
X-Request-ID: <unique_request_id>
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640000000
```

---

### Authentication Flow

```
1. Register: POST /api/auth/register
   ‚îî‚îÄ> Email verification link sent
   
2. Verify Email: POST /api/auth/verify-email
   ‚îî‚îÄ> Email verified, can now login

3. Login: POST /api/auth/login
   ‚îî‚îÄ> Returns: accessToken (15min) + refreshToken (7days)
   
4. Access Protected Routes:
   ‚îî‚îÄ> Authorization: Bearer <accessToken>
   
5. Refresh Token: POST /api/auth/refresh
   ‚îî‚îÄ> Returns: new accessToken + new refreshToken (rotation)
   
6. Logout: POST /api/auth/logout
   ‚îî‚îÄ> Deletes refreshToken from database
```

---

### Common Response Patterns

**Success Response:**
```json
{
  "data": {
    "id": "123",
    "name": "John Doe"
  },
  "meta": {
    "requestId": "req_abc123",
    "timestamp": "2025-12-16T12:00:00Z"
  }
}
```

**Error Response:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": [
      {
        "field": "email",
        "message": "Invalid email format"
      }
    ]
  },
  "meta": {
    "requestId": "req_abc123",
    "timestamp": "2025-12-16T12:00:00Z"
  }
}
```

**Paginated Response:**
```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "totalPages": 5,
    "totalItems": 95,
    "hasNext": true,
    "hasPrev": false
  },
  "meta": {
    "requestId": "req_abc123",
    "timestamp": "2025-12-16T12:00:00Z"
  }
}
```

---

## üîê AUTHENTICATION ENDPOINTS

### 1. Register User

**Endpoint:** `POST /api/auth/register`

**Description:** Creates a new user account and sends email verification.

**Authentication:** None (public)

**Rate Limit:** 3 requests per hour per IP

**Request Body:**
```json
{
  "email": "john@example.com",
  "password": "Password123!",
  "name": "John Doe",
  "tenantId": "tenant-uuid" // Optional, for joining existing tenant
}
```

**Validation Rules:**
```typescript
const registerSchema = z.object({
  email: z.string().email('Invalid email format'),
  password: z.string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain uppercase letter')
    .regex(/[a-z]/, 'Password must contain lowercase letter')
    .regex(/[0-9]/, 'Password must contain number')
    .regex(/[^A-Za-z0-9]/, 'Password must contain special character'),
  name: z.string().min(2, 'Name must be at least 2 characters'),
  tenantId: z.string().uuid().optional()
});
```

**Success Response (201 Created):**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "john@example.com",
    "name": "John Doe",
    "emailVerified": false,
    "tenantId": null,
    "createdAt": "2025-12-16T12:00:00Z"
  },
  "meta": {
    "requestId": "req_abc123",
    "timestamp": "2025-12-16T12:00:00Z"
  }
}
```

**Error Responses:**

**409 Conflict - Email Already Exists:**
```json
{
  "error": {
    "code": "EMAIL_EXISTS",
    "message": "Email already registered",
    "details": {
      "email": "john@example.com"
    }
  }
}
```

**400 Bad Request - Validation Error:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": [
      {
        "field": "password",
        "message": "Password must contain uppercase letter"
      }
    ]
  }
}
```

**Business Rules:**
1. Email must be unique across all users
2. Password hashed with bcrypt (cost factor 12)
3. Verification email sent asynchronously (non-blocking)
4. User cannot login until email verified
5. If tenantId provided, user joins that tenant (if exists)

---

### 2. Verify Email

**Endpoint:** `POST /api/auth/verify-email`

**Description:** Verifies user email using token from email link.

**Authentication:** None (public)

**Rate Limit:** 5 requests per hour per IP

**Request Body:**
```json
{
  "token": "email-verification-token"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Email verified successfully",
    "emailVerified": true
  }
}
```

**Error Responses:**

**400 Bad Request - Invalid Token:**
```json
{
  "error": {
    "code": "INVALID_TOKEN",
    "message": "Invalid or expired verification token"
  }
}
```

**Business Rules:**
1. Token valid for 24 hours
2. Token single-use (deleted after verification)
3. Sets emailVerified = true
4. Sets emailVerifiedAt = now()

---

### 3. Resend Verification Email

**Endpoint:** `POST /api/auth/resend-verification`

**Description:** Resends email verification link.

**Authentication:** None (public)

**Rate Limit:** 3 requests per hour per email

**Request Body:**
```json
{
  "email": "john@example.com"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Verification email sent"
  }
}
```

**Error Responses:**

**404 Not Found - Email Not Found:**
```json
{
  "error": {
    "code": "EMAIL_NOT_FOUND",
    "message": "No user found with this email"
  }
}
```

**400 Bad Request - Already Verified:**
```json
{
  "error": {
    "code": "ALREADY_VERIFIED",
    "message": "Email already verified"
  }
}
```

---

### 4. Login

**Endpoint:** `POST /api/auth/login`

**Description:** Authenticates user and returns JWT tokens.

**Authentication:** None (public)

**Rate Limit:** 5 requests per 15 minutes per IP

**Request Body:**
```json
{
  "email": "john@example.com",
  "password": "Password123!",
  "remember": true // Optional, extends refresh token to 30 days
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "user": {
      "id": "user-uuid",
      "email": "john@example.com",
      "name": "John Doe",
      "tenantId": "tenant-uuid",
      "role": "TENANT_ADMIN",
      "twoFactorEnabled": false
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "refresh-token-uuid",
      "expiresIn": 900 // 15 minutes in seconds
    }
  }
}
```

**Success Response with 2FA (200 OK):**
```json
{
  "data": {
    "requiresTwoFactor": true,
    "tempToken": "temp-token-for-2fa"
  }
}
```

**Error Responses:**

**401 Unauthorized - Invalid Credentials:**
```json
{
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Invalid email or password"
  }
}
```

**403 Forbidden - Email Not Verified:**
```json
{
  "error": {
    "code": "EMAIL_NOT_VERIFIED",
    "message": "Please verify your email before logging in"
  }
}
```

**Business Rules:**
1. Email must be verified
2. Password verified with bcrypt
3. Access token expires in 15 minutes
4. Refresh token expires in 7 days (30 days if remember=true)
5. If 2FA enabled, returns tempToken instead of full tokens
6. Failed login attempts tracked (lockout after 10 attempts)

---

### 5. Login with 2FA

**Endpoint:** `POST /api/auth/login/2fa`

**Description:** Completes login after 2FA code verification.

**Authentication:** Temp token from initial login

**Rate Limit:** 5 requests per 15 minutes per user

**Request Headers:**
```http
Authorization: Bearer <temp_token>
```

**Request Body:**
```json
{
  "code": "123456" // 6-digit TOTP code
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "user": {
      "id": "user-uuid",
      "email": "john@example.com",
      "name": "John Doe",
      "tenantId": "tenant-uuid",
      "role": "TENANT_ADMIN"
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "refresh-token-uuid",
      "expiresIn": 900
    }
  }
}
```

**Error Responses:**

**401 Unauthorized - Invalid Code:**
```json
{
  "error": {
    "code": "INVALID_2FA_CODE",
    "message": "Invalid 2FA code"
  }
}
```

**Business Rules:**
1. Temp token valid for 5 minutes
2. TOTP code verified using speakeasy
3. Backup codes can be used instead of TOTP
4. Backup codes are one-time use

---

### 6. Refresh Token

**Endpoint:** `POST /api/auth/refresh`

**Description:** Exchanges refresh token for new access token.

**Authentication:** Refresh token in body

**Rate Limit:** 10 requests per 15 minutes per user

**Request Body:**
```json
{
  "refreshToken": "refresh-token-uuid"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "new-refresh-token-uuid",
    "expiresIn": 900
  }
}
```

**Error Responses:**

**401 Unauthorized - Invalid Refresh Token:**
```json
{
  "error": {
    "code": "INVALID_REFRESH_TOKEN",
    "message": "Invalid or expired refresh token"
  }
}
```

**Business Rules:**
1. Old refresh token deleted from database
2. New refresh token generated (rotation)
3. New access token issued with same claims
4. Refresh tokens single-use only

---

### 7. Logout

**Endpoint:** `POST /api/auth/logout`

**Description:** Invalidates refresh token and logs out user.

**Authentication:** Required (Bearer token)

**Rate Limit:** 10 requests per 15 minutes per user

**Request Body:**
```json
{
  "refreshToken": "refresh-token-uuid" // Optional, logout all if omitted
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Logged out successfully"
  }
}
```

**Business Rules:**
1. Deletes specified refresh token from database
2. If no refreshToken provided, deletes all user's refresh tokens
3. Access token remains valid until expiration (15 min)

---

### 8. Forgot Password

**Endpoint:** `POST /api/auth/forgot-password`

**Description:** Initiates password reset flow via email.

**Authentication:** None (public)

**Rate Limit:** 3 requests per hour per email

**Request Body:**
```json
{
  "email": "john@example.com"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Password reset email sent if account exists"
  }
}
```

**Business Rules:**
1. Always returns success (prevents email enumeration)
2. Only sends email if account exists
3. Reset token valid for 1 hour
4. Token single-use

---

### 9. Reset Password

**Endpoint:** `POST /api/auth/reset-password`

**Description:** Resets password using token from email.

**Authentication:** None (public)

**Rate Limit:** 5 requests per hour per IP

**Request Body:**
```json
{
  "token": "password-reset-token",
  "password": "NewPassword123!"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Password reset successfully"
  }
}
```

**Error Responses:**

**400 Bad Request - Invalid Token:**
```json
{
  "error": {
    "code": "INVALID_TOKEN",
    "message": "Invalid or expired reset token"
  }
}
```

**Business Rules:**
1. Token valid for 1 hour
2. Token deleted after use
3. All refresh tokens invalidated (force re-login)
4. Password validated same as registration

---

### 10. Setup 2FA

**Endpoint:** `POST /api/auth/2fa/setup`

**Description:** Generates 2FA secret and QR code.

**Authentication:** Required (Bearer token)

**Rate Limit:** 5 requests per hour per user

**Request Body:**
```json
{}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "secret": "JBSWY3DPEHPK3PXP",
    "qrCodeUrl": "data:image/png;base64,iVBORw0KGgo...",
    "backupCodes": [
      "12345678",
      "23456789",
      "34567890",
      "45678901",
      "56789012",
      "67890123",
      "78901234",
      "89012345",
      "90123456",
      "01234567"
    ]
  }
}
```

**Business Rules:**
1. Secret encrypted before storage (AES-256-CBC)
2. Backup codes encrypted before storage
3. QR code generated using speakeasy
4. 2FA not enabled until verification

---

### 11. Verify 2FA Setup

**Endpoint:** `POST /api/auth/2fa/verify`

**Description:** Verifies 2FA setup with test code.

**Authentication:** Required (Bearer token)

**Rate Limit:** 5 requests per 15 minutes per user

**Request Body:**
```json
{
  "code": "123456"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "2FA enabled successfully",
    "twoFactorEnabled": true
  }
}
```

**Error Responses:**

**400 Bad Request - Invalid Code:**
```json
{
  "error": {
    "code": "INVALID_2FA_CODE",
    "message": "Invalid 2FA code"
  }
}
```

**Business Rules:**
1. Sets twoFactorEnabled = true
2. All future logins require 2FA
3. Audit log created

---

### 12. Disable 2FA

**Endpoint:** `POST /api/auth/2fa/disable`

**Description:** Disables 2FA for user account.

**Authentication:** Required (Bearer token)

**Rate Limit:** 5 requests per hour per user

**Request Body:**
```json
{
  "password": "Password123!" // Requires password confirmation
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "2FA disabled successfully",
    "twoFactorEnabled": false
  }
}
```

**Business Rules:**
1. Requires password confirmation
2. Deletes 2FA secret and backup codes
3. Sets twoFactorEnabled = false
4. Audit log created

---

## üë§ USER MANAGEMENT ENDPOINTS

### 13. Get Current User

**Endpoint:** `GET /api/users/me`

**Description:** Returns authenticated user's profile.

**Authentication:** Required (Bearer token)

**Rate Limit:** 100 requests per 15 minutes per user

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "john@example.com",
    "name": "John Doe",
    "avatar": "https://cdn.kaven.io/avatars/john.jpg",
    "emailVerified": true,
    "twoFactorEnabled": true,
    "tenantId": "tenant-uuid",
    "role": "TENANT_ADMIN",
    "metadata": {
      "preferences": {
        "theme": "dark",
        "language": "pt-BR"
      }
    },
    "createdAt": "2025-01-01T00:00:00Z",
    "updatedAt": "2025-12-16T12:00:00Z"
  }
}
```

---

### 14. Update Current User

**Endpoint:** `PATCH /api/users/me`

**Description:** Updates authenticated user's profile.

**Authentication:** Required (Bearer token)

**Rate Limit:** 20 requests per hour per user

**Request Body:**
```json
{
  "name": "John Smith",
  "avatar": "https://cdn.kaven.io/avatars/john-new.jpg",
  "metadata": {
    "preferences": {
      "theme": "light"
    }
  }
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "john@example.com",
    "name": "John Smith",
    "avatar": "https://cdn.kaven.io/avatars/john-new.jpg",
    "updatedAt": "2025-12-16T12:05:00Z"
  }
}
```

**Business Rules:**
1. Cannot update email directly (separate endpoint)
2. Cannot update role (admin only)
3. Avatar URL validated
4. Metadata merged (not replaced)

---

### 15. Change Password

**Endpoint:** `POST /api/users/me/password`

**Description:** Changes user password (requires current password).

**Authentication:** Required (Bearer token)

**Rate Limit:** 5 requests per hour per user

**Request Body:**
```json
{
  "currentPassword": "Password123!",
  "newPassword": "NewPassword456!"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Password changed successfully"
  }
}
```

**Error Responses:**

**401 Unauthorized - Wrong Current Password:**
```json
{
  "error": {
    "code": "INVALID_PASSWORD",
    "message": "Current password is incorrect"
  }
}
```

**Business Rules:**
1. Current password verified
2. New password validated (same rules as registration)
3. All refresh tokens invalidated (force re-login)
4. Audit log created

---

### 16. List Users (Admin)

**Endpoint:** `GET /api/users`

**Description:** Lists all users (tenant-scoped).

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 100 requests per 15 minutes per user

**Query Parameters:**
```
?page=1             // Page number (default: 1)
&pageSize=20        // Items per page (default: 20, max: 100)
&search=john        // Search by name or email
&role=USER          // Filter by role
&emailVerified=true // Filter by verification status
&sortBy=createdAt   // Sort field (default: createdAt)
&sortOrder=desc     // Sort order (asc/desc, default: desc)
```

**Success Response (200 OK):**
```json
{
  "data": [
    {
      "id": "user-uuid-1",
      "email": "john@example.com",
      "name": "John Doe",
      "role": "TENANT_ADMIN",
      "emailVerified": true,
      "createdAt": "2025-01-01T00:00:00Z"
    },
    {
      "id": "user-uuid-2",
      "email": "jane@example.com",
      "name": "Jane Smith",
      "role": "USER",
      "emailVerified": true,
      "createdAt": "2025-01-02T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "totalPages": 5,
    "totalItems": 95,
    "hasNext": true,
    "hasPrev": false
  }
}
```

**Business Rules:**
1. TENANT_ADMIN sees only tenant users
2. SUPER_ADMIN sees all users (if tenantId not specified)
3. Search is case-insensitive
4. Deleted users excluded by default

---

### 17. Get User by ID (Admin)

**Endpoint:** `GET /api/users/:id`

**Description:** Returns specific user details.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 100 requests per 15 minutes per user

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "john@example.com",
    "name": "John Doe",
    "avatar": "https://cdn.kaven.io/avatars/john.jpg",
    "emailVerified": true,
    "twoFactorEnabled": true,
    "tenantId": "tenant-uuid",
    "role": "USER",
    "metadata": {},
    "createdAt": "2025-01-01T00:00:00Z",
    "updatedAt": "2025-12-16T12:00:00Z"
  }
}
```

**Error Responses:**

**404 Not Found:**
```json
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User not found"
  }
}
```

---

### 18. Create User (Admin)

**Endpoint:** `POST /api/users`

**Description:** Creates new user (admin action).

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 20 requests per hour per user

**Request Body:**
```json
{
  "email": "newuser@example.com",
  "password": "Password123!",
  "name": "New User",
  "role": "USER",
  "emailVerified": false // Admin can create pre-verified users
}
```

**Success Response (201 Created):**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "newuser@example.com",
    "name": "New User",
    "role": "USER",
    "emailVerified": false,
    "tenantId": "tenant-uuid",
    "createdAt": "2025-12-16T12:00:00Z"
  }
}
```

**Business Rules:**
1. Auto-assigns to current tenant (TENANT_ADMIN)
2. Can specify any tenant (SUPER_ADMIN)
3. Sends welcome email
4. Audit log created

---

### 19. Update User (Admin)

**Endpoint:** `PATCH /api/users/:id`

**Description:** Updates user details (admin action).

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 20 requests per hour per user

**Request Body:**
```json
{
  "name": "Updated Name",
  "role": "TENANT_ADMIN",
  "emailVerified": true
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "user@example.com",
    "name": "Updated Name",
    "role": "TENANT_ADMIN",
    "emailVerified": true,
    "updatedAt": "2025-12-16T12:05:00Z"
  }
}
```

**Business Rules:**
1. Cannot update email (use separate endpoint)
2. Cannot update own role (prevent privilege escalation)
3. Audit log created

---

### 20. Delete User (Admin)

**Endpoint:** `DELETE /api/users/:id`

**Description:** Soft deletes user.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 10 requests per hour per user

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "User deleted successfully"
  }
}
```

**Business Rules:**
1. Soft delete (sets deletedAt)
2. Cannot delete self
3. Invalidates all user's refresh tokens
4. Audit log created
5. Can be recovered within 30 days (by SUPER_ADMIN)

---

## üè¢ TENANT MANAGEMENT ENDPOINTS

### 21. List Tenants (Super Admin)

**Endpoint:** `GET /api/tenants`

**Description:** Lists all tenants.

**Authentication:** Required (Bearer token)

**Authorization:** SUPER_ADMIN only

**Rate Limit:** 100 requests per 15 minutes per user

**Query Parameters:**
```
?page=1
&pageSize=20
&search=acme
&status=ACTIVE
&sortBy=createdAt
&sortOrder=desc
```

**Success Response (200 OK):**
```json
{
  "data": [
    {
      "id": "tenant-uuid-1",
      "name": "Acme Corp",
      "slug": "acme",
      "status": "ACTIVE",
      "userCount": 25,
      "createdAt": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "totalPages": 3,
    "totalItems": 45,
    "hasNext": true,
    "hasPrev": false
  }
}
```

---

### 22. Get Current Tenant

**Endpoint:** `GET /api/tenants/me`

**Description:** Returns current tenant details.

**Authentication:** Required (Bearer token)

**Rate Limit:** 100 requests per 15 minutes per user

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "tenant-uuid",
    "name": "Acme Corp",
    "slug": "acme",
    "status": "ACTIVE",
    "settings": {
      "theme": "light",
      "features": ["2fa", "api"]
    },
    "subscription": {
      "status": "ACTIVE",
      "plan": "PRO",
      "currentPeriodEnd": "2025-02-01T00:00:00Z"
    },
    "createdAt": "2025-01-01T00:00:00Z",
    "updatedAt": "2025-12-16T12:00:00Z"
  }
}
```

---

### 23. Create Tenant (Super Admin)

**Endpoint:** `POST /api/tenants`

**Description:** Creates new tenant.

**Authentication:** Required (Bearer token)

**Authorization:** SUPER_ADMIN only

**Rate Limit:** 10 requests per hour per user

**Request Body:**
```json
{
  "name": "New Company",
  "slug": "newcompany",
  "settings": {
    "theme": "light"
  }
}
```

**Success Response (201 Created):**
```json
{
  "data": {
    "id": "tenant-uuid",
    "name": "New Company",
    "slug": "newcompany",
    "status": "ACTIVE",
    "createdAt": "2025-12-16T12:00:00Z"
  }
}
```

**Error Responses:**

**409 Conflict - Slug Already Exists:**
```json
{
  "error": {
    "code": "SLUG_EXISTS",
    "message": "Tenant slug already exists"
  }
}
```

**Business Rules:**
1. Slug must be unique
2. Slug must be URL-safe (lowercase, alphanumeric, hyphens)
3. Creates trial subscription automatically
4. Audit log created

---

### 24. Update Tenant

**Endpoint:** `PATCH /api/tenants/:id`

**Description:** Updates tenant details.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 20 requests per hour per user

**Request Body:**
```json
{
  "name": "Updated Company Name",
  "settings": {
    "theme": "dark",
    "features": ["2fa", "api", "analytics"]
  }
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "tenant-uuid",
    "name": "Updated Company Name",
    "slug": "company",
    "settings": {
      "theme": "dark",
      "features": ["2fa", "api", "analytics"]
    },
    "updatedAt": "2025-12-16T12:05:00Z"
  }
}
```

**Business Rules:**
1. Cannot update slug (prevents breaking subdomains)
2. Settings merged (not replaced)
3. Audit log created

---

### 25. Suspend Tenant (Super Admin)

**Endpoint:** `POST /api/tenants/:id/suspend`

**Description:** Suspends tenant (blocks all users).

**Authentication:** Required (Bearer token)

**Authorization:** SUPER_ADMIN only

**Rate Limit:** 10 requests per hour per user

**Request Body:**
```json
{
  "reason": "Payment failure"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Tenant suspended successfully",
    "status": "SUSPENDED"
  }
}
```

**Business Rules:**
1. Sets status = SUSPENDED
2. All tenant users immediately blocked from login
3. Audit log created with reason
4. Email notification sent to tenant admins

---

### 26. Reactivate Tenant (Super Admin)

**Endpoint:** `POST /api/tenants/:id/reactivate`

**Description:** Reactivates suspended tenant.

**Authentication:** Required (Bearer token)

**Authorization:** SUPER_ADMIN only

**Rate Limit:** 10 requests per hour per user

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Tenant reactivated successfully",
    "status": "ACTIVE"
  }
}
```

**Business Rules:**
1. Sets status = ACTIVE
2. Users can login again
3. Audit log created

---

## üí≥ PAYMENT ENDPOINTS

### 27. Get Subscription

**Endpoint:** `GET /api/payments/subscription`

**Description:** Returns current tenant subscription.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 100 requests per 15 minutes per user

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "subscription-uuid",
    "tenantId": "tenant-uuid",
    "status": "ACTIVE",
    "plan": "PRO",
    "currentPeriodStart": "2025-01-01T00:00:00Z",
    "currentPeriodEnd": "2025-02-01T00:00:00Z",
    "cancelAtPeriodEnd": false,
    "stripeCustomerId": "cus_xxx",
    "stripePriceId": "price_xxx"
  }
}
```

---

### 28. Create Subscription

**Endpoint:** `POST /api/payments/subscription`

**Description:** Creates subscription for tenant.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 10 requests per hour per user

**Request Body:**
```json
{
  "priceId": "price_xxx", // Stripe price ID
  "paymentMethodId": "pm_xxx" // Stripe payment method ID
}
```

**Success Response (201 Created):**
```json
{
  "data": {
    "id": "subscription-uuid",
    "status": "ACTIVE",
    "clientSecret": "pi_xxx_secret_xxx" // For 3D Secure
  }
}
```

**Business Rules:**
1. Creates Stripe customer if not exists
2. Attaches payment method
3. Creates Stripe subscription
4. Handles 3D Secure authentication
5. Webhook confirms activation

---

### 29. Update Subscription

**Endpoint:** `PATCH /api/payments/subscription`

**Description:** Updates subscription (upgrade/downgrade).

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 10 requests per hour per user

**Request Body:**
```json
{
  "priceId": "price_new_plan"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "subscription-uuid",
    "status": "ACTIVE",
    "plan": "ENTERPRISE",
    "proratedAmount": 50.00 // Amount charged/refunded
  }
}
```

**Business Rules:**
1. Calculates proration
2. Charges/refunds immediately
3. Updates Stripe subscription
4. Audit log created

---

### 30. Cancel Subscription

**Endpoint:** `DELETE /api/payments/subscription`

**Description:** Cancels subscription at period end.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 5 requests per hour per user

**Request Body:**
```json
{
  "immediately": false, // If true, cancel now. If false, at period end
  "reason": "Too expensive"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Subscription will be canceled at period end",
    "cancelAtPeriodEnd": true,
    "currentPeriodEnd": "2025-02-01T00:00:00Z"
  }
}
```

**Business Rules:**
1. If immediately=false, sets cancelAtPeriodEnd=true
2. If immediately=true, cancels now and downgrades to free tier
3. Audit log created with reason
4. Email confirmation sent

---

### 31. Create Pix Payment

**Endpoint:** `POST /api/payments/pix`

**Description:** Creates Pix payment (Brazilian market).

**Authentication:** Required (Bearer token)

**Rate Limit:** 10 requests per hour per user

**Request Body:**
```json
{
  "amount": 100.00,
  "description": "Pro Plan Subscription"
}
```

**Success Response (201 Created):**
```json
{
  "data": {
    "id": "payment-uuid",
    "qrCode": "data:image/png;base64,iVBORw0KGgo...",
    "qrCodeText": "00020126580014br.gov.bcb.pix...",
    "amount": 100.00,
    "expiresAt": "2025-12-16T12:30:00Z" // 30 minutes
  }
}
```

**Business Rules:**
1. QR code valid for 30 minutes
2. Webhook confirms payment
3. Auto-activates subscription on payment
4. Refundable within 7 days

---

### 32. Check Pix Payment Status

**Endpoint:** `GET /api/payments/pix/:id`

**Description:** Checks Pix payment status.

**Authentication:** Required (Bearer token)

**Rate Limit:** 20 requests per minute per user

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "payment-uuid",
    "status": "PAID", // PENDING, PAID, EXPIRED, REFUNDED
    "paidAt": "2025-12-16T12:15:00Z"
  }
}
```

---

### 33. Stripe Webhook

**Endpoint:** `POST /api/webhooks/stripe`

**Description:** Handles Stripe webhook events.

**Authentication:** Stripe signature verification

**Rate Limit:** None

**Request Body:** (Stripe event payload)

**Success Response (200 OK):**
```json
{
  "received": true
}
```

**Events Handled:**
- `payment_intent.succeeded`
- `payment_intent.payment_failed`
- `customer.subscription.created`
- `customer.subscription.updated`
- `customer.subscription.deleted`
- `invoice.paid`
- `invoice.payment_failed`

---

## üßæ INVOICE ENDPOINTS

### 34. List Invoices

**Endpoint:** `GET /api/invoices`

**Description:** Lists invoices (tenant-scoped).

**Authentication:** Required (Bearer token)

**Rate Limit:** 100 requests per 15 minutes per user

**Query Parameters:**
```
?page=1
&pageSize=20
&status=PAID
&sortBy=createdAt
&sortOrder=desc
```

**Success Response (200 OK):**
```json
{
  "data": [
    {
      "id": "invoice-uuid",
      "number": "INV-2025-001",
      "status": "PAID",
      "total": 110.00,
      "currency": "BRL",
      "dueDate": "2025-01-15T00:00:00Z",
      "paidAt": "2025-01-10T00:00:00Z",
      "createdAt": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "totalPages": 2,
    "totalItems": 35
  }
}
```

---

### 35. Get Invoice

**Endpoint:** `GET /api/invoices/:id`

**Description:** Returns invoice details with line items.

**Authentication:** Required (Bearer token)

**Rate Limit:** 100 requests per 15 minutes per user

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "invoice-uuid",
    "number": "INV-2025-001",
    "status": "PAID",
    "subtotal": 100.00,
    "tax": 10.00,
    "discount": 0.00,
    "total": 110.00,
    "currency": "BRL",
    "dueDate": "2025-01-15T00:00:00Z",
    "paidAt": "2025-01-10T00:00:00Z",
    "items": [
      {
        "id": "item-uuid",
        "description": "Pro Plan - Monthly",
        "quantity": 1,
        "price": 100.00,
        "total": 100.00
      }
    ],
    "createdAt": "2025-01-01T00:00:00Z"
  }
}
```

---

### 36. Create Invoice (Admin)

**Endpoint:** `POST /api/invoices`

**Description:** Creates new invoice.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 20 requests per hour per user

**Request Body:**
```json
{
  "customerId": "customer-uuid",
  "items": [
    {
      "description": "Consulting Service",
      "quantity": 10,
      "price": 50.00
    }
  ],
  "tax": 50.00,
  "discount": 0.00,
  "dueDate": "2025-01-31T00:00:00Z"
}
```

**Success Response (201 Created):**
```json
{
  "data": {
    "id": "invoice-uuid",
    "number": "INV-2025-002",
    "status": "DRAFT",
    "subtotal": 500.00,
    "tax": 50.00,
    "total": 550.00,
    "currency": "BRL"
  }
}
```

**Business Rules:**
1. Auto-generates sequential number
2. Calculates totals automatically
3. Status = DRAFT initially
4. Must be sent to become payable

---

### 37. Send Invoice

**Endpoint:** `POST /api/invoices/:id/send`

**Description:** Sends invoice to customer via email.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 20 requests per hour per user

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Invoice sent successfully",
    "status": "SENT",
    "sentAt": "2025-12-16T12:00:00Z"
  }
}
```

**Business Rules:**
1. Changes status from DRAFT to SENT
2. Sends email with PDF attachment
3. Includes payment link
4. Audit log created

---

### 38. Download Invoice PDF

**Endpoint:** `GET /api/invoices/:id/pdf`

**Description:** Downloads invoice as PDF.

**Authentication:** Required (Bearer token)

**Rate Limit:** 50 requests per hour per user

**Success Response (200 OK):**
```
Content-Type: application/pdf
Content-Disposition: attachment; filename="INV-2025-001.pdf"

<PDF binary data>
```

---

## üì¶ ORDER ENDPOINTS

### 39. List Orders

**Endpoint:** `GET /api/orders`

**Description:** Lists orders (tenant-scoped).

**Authentication:** Required (Bearer token)

**Rate Limit:** 100 requests per 15 minutes per user

**Query Parameters:**
```
?page=1
&pageSize=20
&status=DELIVERED
&sortBy=createdAt
&sortOrder=desc
```

**Success Response (200 OK):**
```json
{
  "data": [
    {
      "id": "order-uuid",
      "number": "ORD-2025-001",
      "status": "DELIVERED",
      "total": 235.00,
      "createdAt": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "totalPages": 3,
    "totalItems": 50
  }
}
```

---

### 40. Get Order

**Endpoint:** `GET /api/orders/:id`

**Description:** Returns order details with items and history.

**Authentication:** Required (Bearer token)

**Rate Limit:** 100 requests per 15 minutes per user

**Success Response (200 OK):**
```json
{
  "data": {
    "id": "order-uuid",
    "number": "ORD-2025-001",
    "status": "DELIVERED",
    "subtotal": 200.00,
    "shipping": 15.00,
    "tax": 20.00,
    "total": 235.00,
    "items": [
      {
        "id": "item-uuid",
        "description": "Widget Pro",
        "quantity": 2,
        "price": 100.00,
        "total": 200.00
      }
    ],
    "statusHistory": [
      {
        "status": "PENDING",
        "createdAt": "2025-01-01T00:00:00Z"
      },
      {
        "status": "PROCESSING",
        "createdAt": "2025-01-01T01:00:00Z"
      },
      {
        "status": "SHIPPED",
        "notes": "FedEx tracking: 1234567890",
        "createdAt": "2025-01-02T00:00:00Z"
      },
      {
        "status": "DELIVERED",
        "createdAt": "2025-01-05T00:00:00Z"
      }
    ],
    "createdAt": "2025-01-01T00:00:00Z"
  }
}
```

---

### 41. Update Order Status (Admin)

**Endpoint:** `PATCH /api/orders/:id/status`

**Description:** Updates order status.

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 50 requests per hour per user

**Request Body:**
```json
{
  "status": "SHIPPED",
  "notes": "FedEx tracking: 1234567890"
}
```

**Success Response (200 OK):**
```json
{
  "data": {
    "message": "Order status updated",
    "status": "SHIPPED",
    "updatedAt": "2025-12-16T12:00:00Z"
  }
}
```

**Business Rules:**
1. Creates status history entry
2. Sends email notification to customer
3. Audit log created
4. Cannot revert to previous status (one-way progression)

---

## üìú AUDIT LOG ENDPOINTS

### 42. List Audit Logs (Admin)

**Endpoint:** `GET /api/audit-logs`

**Description:** Lists audit logs (tenant-scoped for TENANT_ADMIN).

**Authentication:** Required (Bearer token)

**Authorization:** TENANT_ADMIN or SUPER_ADMIN

**Rate Limit:** 100 requests per 15 minutes per user

**Query Parameters:**
```
?page=1
&pageSize=50
&action=user.created
&entityType=User
&userId=user-uuid
&startDate=2025-01-01T00:00:00Z
&endDate=2025-12-31T23:59:59Z
```

**Success Response (200 OK):**
```json
{
  "data": [
    {
      "id": "log-uuid",
      "action": "user.created",
      "entityType": "User",
      "entityId": "user-uuid",
      "userId": "admin-uuid",
      "userName": "Admin User",
      "changes": {
        "before": null,
        "after": {
          "email": "newuser@example.com",
          "name": "New User"
        }
      },
      "ipAddress": "192.168.1.1",
      "createdAt": "2025-12-16T12:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 50,
    "totalPages": 10,
    "totalItems": 485
  }
}
```

---

## ‚ù§Ô∏è HEALTH CHECK ENDPOINTS

### 43. Health Check

**Endpoint:** `GET /health`

**Description:** Basic liveness check.

**Authentication:** None (public)

**Rate Limit:** None

**Success Response (200 OK):**
```json
{
  "status": "ok",
  "timestamp": "2025-12-16T12:00:00Z",
  "version": "1.0.0"
}
```

---

### 44. Readiness Check

**Endpoint:** `GET /ready`

**Description:** Checks if all dependencies are healthy.

**Authentication:** None (public)

**Rate Limit:** None

**Success Response (200 OK):**
```json
{
  "status": "ready",
  "timestamp": "2025-12-16T12:00:00Z",
  "checks": {
    "database": "healthy",
    "redis": "healthy"
  }
}
```

**Error Response (503 Service Unavailable):**
```json
{
  "status": "not_ready",
  "timestamp": "2025-12-16T12:00:00Z",
  "checks": {
    "database": "healthy",
    "redis": "unhealthy"
  }
}
```

---

## ‚ö†Ô∏è ERROR CODES

### Standard Error Format

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable message",
    "details": {} // Optional additional context
  },
  "meta": {
    "requestId": "req_abc123",
    "timestamp": "2025-12-16T12:00:00Z"
  }
}
```

---

### Error Code Reference

| HTTP Status | Error Code | Description |
|------------|------------|-------------|
| 400 | `VALIDATION_ERROR` | Request validation failed |
| 400 | `INVALID_TOKEN` | Token invalid or expired |
| 400 | `INVALID_2FA_CODE` | 2FA code incorrect |
| 400 | `ALREADY_VERIFIED` | Email already verified |
| 401 | `UNAUTHORIZED` | Not authenticated |
| 401 | `INVALID_CREDENTIALS` | Wrong email or password |
| 401 | `INVALID_PASSWORD` | Current password incorrect |
| 401 | `INVALID_REFRESH_TOKEN` | Refresh token invalid |
| 403 | `FORBIDDEN` | Not authorized for this action |
| 403 | `EMAIL_NOT_VERIFIED` | Email verification required |
| 404 | `NOT_FOUND` | Resource not found |
| 404 | `USER_NOT_FOUND` | User does not exist |
| 404 | `TENANT_NOT_FOUND` | Tenant does not exist |
| 404 | `EMAIL_NOT_FOUND` | No account with this email |
| 409 | `CONFLICT` | Resource conflict |
| 409 | `EMAIL_EXISTS` | Email already registered |
| 409 | `SLUG_EXISTS` | Tenant slug already taken |
| 429 | `RATE_LIMIT_EXCEEDED` | Too many requests |
| 500 | `INTERNAL_ERROR` | Server error (logged) |
| 503 | `SERVICE_UNAVAILABLE` | Service temporarily down |

---

## üö¶ RATE LIMITING

### Rate Limit Rules

| Endpoint Pattern | Limit | Window |
|-----------------|-------|--------|
| `POST /api/auth/register` | 3 requests | 1 hour |
| `POST /api/auth/login` | 5 requests | 15 minutes |
| `POST /api/auth/forgot-password` | 3 requests | 1 hour |
| `POST /api/auth/2fa/*` | 5 requests | 15 minutes |
| `GET /api/users` | 100 requests | 15 minutes |
| `POST /api/users` | 20 requests | 1 hour |
| `PATCH /api/users/*` | 20 requests | 1 hour |
| `DELETE /api/users/*` | 10 requests | 1 hour |
| `GET /api/invoices` | 100 requests | 15 minutes |
| `POST /api/payments/*` | 10 requests | 1 hour |
| Default (all others) | 100 requests | 15 minutes |

### Rate Limit Headers

```http
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640000000 (Unix timestamp)
```

### Rate Limit Exceeded Response (429)

```json
{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many requests. Please try again later.",
    "details": {
      "limit": 100,
      "reset": 1640000000
    }
  }
}
```

---

## üìù CHANGELOG

### v1.0.0 (December 16, 2025)
- Initial API specification
- 44 endpoints documented
- Complete request/response schemas
- Business rules defined
- Error codes standardized
- Rate limiting rules established
- Validation rules with Zod schemas
- Authentication flow documented

---

**API specification complete! Ready for implementation in Phase 1.**

**Total Endpoints:** 44
- Authentication: 12 endpoints
- User Management: 8 endpoints
- Tenant Management: 6 endpoints
- Payments: 7 endpoints
- Invoices: 5 endpoints
- Orders: 3 endpoints
- Audit Logs: 1 endpoint
- Health Checks: 2 endpoints
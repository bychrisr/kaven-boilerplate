// ===========================
// TENANT INVITES
// ===========================

model TenantInvite {
  id        String   @id @default(uuid())
  email     String
  role      Role     @default(USER)
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  
  // OPTIONAL: tenantId is null for SUPER_ADMIN, required for ADMIN/MEMBER
  tenant      Tenant?   @relation("TenantInvites", fields: [tenantId], references: [id])
  tenantId    String?   @map("tenant_id")
  
  invitedBy   User      @relation("SentInvites", fields: [invitedById], references: [id])
  invitedById String    @map("invited_by_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  inviteSpaces InviteSpace[]
  
  @@index([email])
  @@index([token])
  @@index([tenantId])
  @@map("tenant_invites")
}

// ===========================
// SPACES SYSTEM
// ===========================


/// Spaces configuráveis para organização de permissões
/// Exemplos: Finance, Marketing, Support, DevOps
model Space {
  id          String   @id @default(uuid())
  tenantId    String?  @map("tenant_id") // null = global space (platform-wide)
  
  /// Código único do space (ex: 'FINANCE', 'MARKETING')
  code        String
  
  /// Nome para exibição
  name        String
  
  /// Descrição do space
  description String?
  
  /// Ícone Lucide (ex: 'DollarSign', 'TrendingUp')
  icon        String   @default("Folder")
  
  /// Cor em hexadecimal (ex: '#10B981')
  color       String   @default("#6B7280")
  
  /// Permissões padrão deste space
  /// Exemplo: ["view:invoices", "manage:refunds"]
  defaultPermissions String[] @map("default_permissions")
  
  /// Se o space está ativo
  isActive    Boolean  @default(true) @map("is_active")
  
  /// Ordem de exibição
  sortOrder   Int      @default(0) @map("sort_order")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant       Tenant?       @relation("TenantSpaces", fields: [tenantId], references: [id], onDelete: Cascade)
  userSpaces   UserSpace[]
  inviteSpaces InviteSpace[]
  projects     Project[]
  
  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@map("spaces")
}

/// Relação entre User e Space (many-to-many)
/// Define quais spaces um usuário pode acessar
model UserSpace {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  spaceId   String   @map("space_id")
  
  /// Permissões customizadas para este usuário neste space
  /// Sobrescreve defaultPermissions do Space se definido
  /// Array vazio [] significa usar defaultPermissions do Space
  customPermissions String[] @map("custom_permissions") @default([])
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  user  User  @relation("UserSpaces", fields: [userId], references: [id], onDelete: Cascade)
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@unique([userId, spaceId])
  @@index([userId])
  @@index([spaceId])
  @@map("user_spaces")
}

/// Relação entre TenantInvite e Space (many-to-many)
/// Define quais spaces serão atribuídos ao usuário quando aceitar o convite
model InviteSpace {
  id        String   @id @default(uuid())
  inviteId  String   @map("invite_id")
  spaceId   String   @map("space_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  invite TenantInvite @relation(fields: [inviteId], references: [id], onDelete: Cascade)
  space  Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@unique([inviteId, spaceId])
  @@index([inviteId])
  @@index([spaceId])
  @@map("invite_spaces")
}

// ===========================
// DEMO FEATURES (Projects/Tasks)
// ===========================

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  color       String?  @default("#3B82F6")

  tenantId    String   @map("tenant_id")
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Space Isolation
  spaceId     String?  @map("space_id")
  space       Space?   @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  createdById String   @map("created_by_id")
  createdBy   User     @relation("ProjectCreator", fields: [createdById], references: [id])

  tasks       Task[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([spaceId])
  @@index([createdById])
  @@map("projects")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String   @id @default(uuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime? @map("due_date")

  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assigneeId  String?  @map("assignee_id")
  assignee    User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])

  tenantId    String   @map("tenant_id")
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdById String   @map("created_by_id")
  createdBy   User     @relation("TaskCreator", fields: [createdById], references: [id])

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([projectId])
  @@index([assigneeId])
  @@map("tasks")
}
// ============================================
// EMAIL INFRASTRUCTURE MODELS
// ============================================

enum EmailProvider {
  POSTMARK
  RESEND
  AWS_SES
  SMTP
}

enum EmailType {
  TRANSACTIONAL
  MARKETING
}

enum EmailEventType {
  SENT
  DELIVERED
  BOUNCE
  COMPLAINT
  OPEN
  CLICK
  UNSUBSCRIBE
}

enum BounceType {
  HARD
  SOFT
  TRANSIENT
}

enum TemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum EmailQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  RETRY
}

/// Email Integration Configuration
/// Stores provider credentials and settings (configurable via Admin Panel)
model EmailIntegration {
  id String @id @default(uuid())

  // Provider Configuration
  provider  EmailProvider @default(SMTP)
  isActive  Boolean       @default(false) @map("is_active")
  isPrimary Boolean       @default(false) @map("is_primary")

  // Provider-specific credentials (encrypted in application layer)
  apiKey        String? @map("api_key") // For Postmark/Resend/AWS SES
  apiSecret     String? @map("api_secret") // For AWS SES
  webhookSecret String? @map("webhook_secret") // For webhook validation

  // SMTP Configuration (fallback)
  smtpHost     String?  @map("smtp_host")
  smtpPort     Int?     @default(587) @map("smtp_port")
  smtpSecure   Boolean? @default(false) @map("smtp_secure")
  smtpUser     String?  @map("smtp_user")
  smtpPassword String?  @map("smtp_password")

  // Domain Configuration
  transactionalDomain String? @map("transactional_domain") // e.g., auth.kaven.site
  marketingDomain     String? @map("marketing_domain") // e.g., mail.kaven.site
  fromName            String? @default("Kaven Platform") @map("from_name")
  fromEmail           String? @map("from_email") // e.g., noreply@auth.kaven.site
  testEmail           String? @map("test_email") // Email para testes (usado principalmente para Resend)

  // Message Streams (Postmark)
  transactionalStream String? @default("outbound") @map("transactional_stream")
  marketingStream     String? @default("broadcasts") @map("marketing_stream")

  // Features
  trackOpens  Boolean @default(true) @map("track_opens")
  trackClicks Boolean @default(true) @map("track_clicks")
  enableDkim  Boolean @default(true) @map("enable_dkim")
  enableBimi  Boolean @default(false) @map("enable_bimi")

  // Rate Limiting
  dailyLimit  Int? @map("daily_limit") // Max emails per day
  hourlyLimit Int? @map("hourly_limit") // Max emails per hour

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([isPrimary], name: "primary_integration_unique")
  @@index([provider])
  @@index([isActive])
  @@index([isPrimary])
  @@map("email_integrations")
}

/// Email Events Tracking
/// Tracks all email events (bounces, complaints, opens, clicks)
model EmailEvent {
  id String @id @default(uuid())

  // User/Tenant Association
  userId   String? @map("user_id")
  tenantId String? @map("tenant_id")
  email    String

  // Event Details
  eventType EmailEventType @map("event_type")
  emailType EmailType      @default(TRANSACTIONAL) @map("email_type")
  messageId String         @map("message_id") // Provider message ID
  template  String? // Template name used

  // Bounce/Complaint Details
  bounceType            BounceType? @map("bounce_type")
  bounceReason          String?     @map("bounce_reason")
  complaintFeedbackType String?     @map("complaint_feedback_type")

  // Tracking
  userAgent   String? @map("user_agent")
  ipAddress   String? @map("ip_address")
  linkClicked String? @map("link_clicked") // URL clicked (for CLICK events)

  // Provider Info
  provider        EmailProvider? @map("provider")
  providerEventId String?        @map("provider_event_id") // Original event ID from provider

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([tenantId])
  @@index([email])
  @@index([messageId])
  @@index([eventType])
  @@index([createdAt])
  @@map("email_events")
}

/// Email Templates
/// Stores email templates with i18n support
model EmailTemplate {
  id          String         @id @default(uuid())
  code        String         @unique // e.g., welcome, password-reset
  name        String
  description String?
  type        EmailType      @default(TRANSACTIONAL)
  status      TemplateStatus @default(ACTIVE)

  // Content (supports i18n)
  subjectPt     String  @map("subject_pt")
  subjectEn     String? @map("subject_en")
  htmlContentPt String  @map("html_content_pt") @db.Text
  htmlContentEn String? @map("html_content_en") @db.Text
  textContentPt String? @map("text_content_pt") @db.Text
  textContentEn String? @map("text_content_en") @db.Text

  // Template Variables
  variables Json? // Array of required variables

  // Provider-specific IDs
  postmarkTemplateId String? @map("postmark_template_id")
  resendTemplateId   String? @map("resend_template_id")

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@index([type])
  @@index([status])
  @@map("email_templates")
}

/// Email Queue
/// Async email queue with retry logic
model EmailQueue {
  id String @id @default(uuid())

  // Recipient
  to  String
  cc  String[]
  bcc String[]

  // Content
  subject      String
  htmlBody     String? @map("html_body") @db.Text
  textBody     String? @map("text_body") @db.Text
  templateCode String? @map("template_code")
  templateData Json?   @map("template_data")

  // Configuration
  emailType EmailType      @default(TRANSACTIONAL) @map("email_type")
  provider  EmailProvider?
  fromEmail String?        @map("from_email")
  fromName  String?        @map("from_name")
  replyTo   String?        @map("reply_to")

  // Status
  status      EmailQueueStatus @default(PENDING)
  attempts    Int              @default(0)
  maxAttempts Int              @default(3) @map("max_attempts")
  lastError   String?          @map("last_error")

  // Tracking
  messageId String? @map("message_id") // Provider message ID after sending
  userId    String? @map("user_id")
  tenantId  String? @map("tenant_id")

  // Idempotency
  idempotencyKey String? @unique @map("idempotency_key")

  // Scheduling
  scheduledAt DateTime? @map("scheduled_at")
  sentAt      DateTime? @map("sent_at")

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([scheduledAt])
  @@index([userId])
  @@index([tenantId])
  @@index([idempotencyKey])
  @@map("email_queue")
}

/// Email Metrics
/// Aggregated email metrics for analytics
model EmailMetrics {
  id String @id @default(uuid())

  // Time Period
  date DateTime @db.Date
  hour Int? // 0-23 for hourly metrics

  // Segmentation
  tenantId     String?        @map("tenant_id")
  emailType    EmailType?     @map("email_type")
  provider     EmailProvider?
  templateCode String?        @map("template_code")

  // Metrics
  sentCount         Int @default(0) @map("sent_count")
  deliveredCount    Int @default(0) @map("delivered_count")
  bounceCount       Int @default(0) @map("bounce_count")
  hardBounceCount   Int @default(0) @map("hard_bounce_count")
  softBounceCount   Int @default(0) @map("soft_bounce_count")
  complaintCount    Int @default(0) @map("complaint_count")
  openCount         Int @default(0) @map("open_count")
  uniqueOpenCount   Int @default(0) @map("unique_open_count")
  clickCount        Int @default(0) @map("click_count")
  uniqueClickCount  Int @default(0) @map("unique_click_count")
  unsubscribeCount  Int @default(0) @map("unsubscribe_count")

  // Calculated Rates
  deliveryRate Decimal? @map("delivery_rate") @db.Decimal(5, 2) // %
  bounceRate   Decimal? @map("bounce_rate") @db.Decimal(5, 2) // %
  openRate     Decimal? @map("open_rate") @db.Decimal(5, 2) // %
  clickRate    Decimal? @map("click_rate") @db.Decimal(5, 2) // %

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([date, hour, tenantId, emailType, provider, templateCode], name: "metrics_unique")
  @@index([date])
  @@index([tenantId])
  @@map("email_metrics")
}

# Middleware CamaleÃ£o - Guia de Uso

## ğŸ“‹ VisÃ£o Geral

O **Middleware CamaleÃ£o** permite detecÃ§Ã£o automÃ¡tica de tenant em aplicaÃ§Ãµes multi-tenant, suportando 3 mÃ©todos diferentes de identificaÃ§Ã£o.

---

## ğŸ¯ MÃ©todos de DetecÃ§Ã£o

### 1. Header `X-Tenant-ID` (Recomendado)

**Uso:** Enviar UUID do tenant no header da requisiÃ§Ã£o.

```bash
curl -H "X-Tenant-ID: 08711e98-5eda-46a1-8792-8ec74f61b6c7" \
  http://localhost:8000/api/users
```

**Vantagens:**

- âœ… Simples de implementar
- âœ… Funciona em qualquer ambiente
- âœ… NÃ£o requer configuraÃ§Ã£o de DNS

---

### 2. Subdomain

**Uso:** Acessar via subdomain configurado no tenant.

```bash
# Adicionar ao /etc/hosts:
127.0.0.1 empresa-teste.localhost

# Fazer requisiÃ§Ã£o:
curl http://empresa-teste.localhost:8000/api/users
```

**Vantagens:**

- âœ… URL amigÃ¡vel para usuÃ¡rios
- âœ… Isolamento visual claro
- âœ… Ideal para produÃ§Ã£o

**Desvantagens:**

- âŒ Requer configuraÃ§Ã£o de DNS
- âŒ Mais complexo em desenvolvimento

---

### 3. Path `/tenants/:slug`

**Uso:** Incluir slug do tenant no path da URL.

```bash
curl http://localhost:8000/tenants/empresa-teste/api/users
```

**Status:** ğŸš§ Em desenvolvimento (rotas precisam ser ajustadas)

---

## ğŸ”§ ConfiguraÃ§Ã£o

### VariÃ¡veis de Ambiente

```env
# Modo multi-tenant (true) ou single-tenant (false)
MULTI_TENANT_MODE="true"
```

### Modo Single Tenant

Se `MULTI_TENANT_MODE=false`, o middleware nÃ£o detecta tenant e permite acesso sem restriÃ§Ãµes.

---

## ğŸ’» Uso no CÃ³digo

### Acessar Tenant Context

```typescript
import { FastifyRequest } from 'fastify';

async function handler(request: FastifyRequest) {
  const { tenantId, tenantSlug, isSingleTenant } = request.tenantContext || {};

  if (isSingleTenant) {
    // Modo single tenant - sem restriÃ§Ãµes
    return await getUsers();
  }

  if (!tenantId) {
    // Multi-tenant mas sem tenant detectado
    throw new Error('Tenant nÃ£o identificado');
  }

  // Filtrar por tenant
  return await getUsers({ tenantId });
}
```

### Require Tenant Helper

```typescript
import { requireTenant } from '../middleware/tenant.middleware';

// Em uma rota:
fastify.get('/api/users', {
  preHandler: [requireTenant],
  handler: userController.list,
});
```

---

## ğŸ§ª Testes

### Criar Tenant

```bash
curl -X POST http://localhost:8000/api/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Minha Empresa",
    "slug": "minha-empresa",
    "domain": "minha-empresa.localhost"
  }'
```

### Testar DetecÃ§Ã£o

```bash
# Via header
curl -H "X-Tenant-ID: <tenant-id>" http://localhost:8000/api/users

# Via subdomain (apÃ³s configurar /etc/hosts)
curl http://minha-empresa.localhost:8000/api/users
```

---

## ğŸ“Š Fluxo de DetecÃ§Ã£o

```
Request recebido
    â†“
Modo SINGLE? â†’ Sim â†’ tenantContext = { tenantId: null, isSingleTenant: true }
    â†“ NÃ£o
Header X-Tenant-ID presente? â†’ Sim â†’ Buscar tenant por ID
    â†“ NÃ£o
Path /tenants/:slug? â†’ Sim â†’ Buscar tenant por slug
    â†“ NÃ£o
Subdomain vÃ¡lido? â†’ Sim â†’ Buscar tenant por domain
    â†“ NÃ£o
tenantContext = { tenantId: null, isSingleTenant: false }
```

---

## âš ï¸ LimitaÃ§Ãµes Atuais

1. **Path-based routing** ainda nÃ£o implementado completamente
2. **Subdomain** requer configuraÃ§Ã£o manual de DNS/hosts
3. **Cache** de tenant nÃ£o implementado (cada request faz query no DB)

---

## ğŸš€ Melhorias Futuras

- [ ] Cache Redis para tenant lookups
- [ ] Suporte completo a path-based routing
- [ ] Wildcard subdomain support
- [ ] Tenant switching via cookie
- [ ] Audit log de tenant access

---

## ğŸ“ Exemplo Completo

```typescript
// 1. Criar tenant
const tenant = await prisma.tenant.create({
  data: {
    name: 'Acme Corp',
    slug: 'acme',
    domain: 'acme.myapp.com',
    status: 'ACTIVE',
  },
});

// 2. Fazer requisiÃ§Ã£o com tenant
const response = await fetch('http://localhost:8000/api/users', {
  headers: {
    'X-Tenant-ID': tenant.id,
    'Content-Type': 'application/json',
  },
});

// 3. No backend, o middleware jÃ¡ injetou tenantContext
// request.tenantContext.tenantId === tenant.id
```

---

**VersÃ£o:** 1.0.0  
**Ãšltima atualizaÃ§Ã£o:** 2025-12-19

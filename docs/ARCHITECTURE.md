# Kaven Boilerplate - Arquitetura

## ğŸ“ VisÃ£o Geral

Sistema SaaS multi-tenant completo com arquitetura modular e escalÃ¡vel.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FRONTEND (Next.js)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Auth Pages  â”‚  â”‚  Dashboard   â”‚  â”‚  Admin Panel â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API GATEWAY (Fastify)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Middlewares: Auth, RBAC, Tenant, Metrics, RLS      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auth Module â”‚    â”‚ User Module  â”‚    â”‚Tenant Module â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Payment Moduleâ”‚    â”‚Invoice Moduleâ”‚    â”‚ Order Module â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Audit Module â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INFRASTRUCTURE                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚  â”‚Prometheusâ”‚  â”‚ Grafana  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Estrutura de DiretÃ³rios

```
kaven-boilerplate/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                    # Backend API (Fastify)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/           # Bibliotecas compartilhadas
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ prisma.ts  # Prisma client + RLS
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.ts     # JWT utils
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ bcrypt.ts  # Password hashing
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ 2fa.ts     # TOTP 2FA
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ metrics.ts # Prometheus metrics
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ email.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/    # Middlewares globais
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant.middleware.ts (CamaleÃ£o)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rbac.middleware.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ metrics.middleware.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ modules/       # MÃ³dulos de negÃ³cio
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenants/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ payments/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ invoices/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ orders/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ health.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts      # Entry point
â”‚   â”‚   â””â”€â”€ prisma/
â”‚   â”‚       â””â”€â”€ schema.prisma  # Database schema
â”‚   â”‚
â”‚   â””â”€â”€ admin/                 # Frontend Admin (Next.js)
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ (auth)/       # Auth pages
â”‚       â”‚   â”‚   â”œâ”€â”€ login/
â”‚       â”‚   â”‚   â”œâ”€â”€ register/
â”‚       â”‚   â”‚   â”œâ”€â”€ forgot-password/
â”‚       â”‚   â”‚   â”œâ”€â”€ reset-password/
â”‚       â”‚   â”‚   â”œâ”€â”€ verify-email/
â”‚       â”‚   â”‚   â””â”€â”€ 2fa-setup/
â”‚       â”‚   â””â”€â”€ (dashboard)/  # Dashboard pages
â”‚       â”‚       â”œâ”€â”€ users/
â”‚       â”‚       â”œâ”€â”€ tenants/
â”‚       â”‚       â”œâ”€â”€ invoices/
â”‚       â”‚       â””â”€â”€ orders/
â”‚       â””â”€â”€ components/       # Shared components
â”‚
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma         # Shared Prisma schema
â”‚
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ docker-compose.yml    # Dev environment
â”‚   â””â”€â”€ Dockerfile.api        # Production build
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ API.md               # API documentation
    â””â”€â”€ ARCHITECTURE.md      # This file
```

---

## ğŸ” Camadas de SeguranÃ§a

### 1. AutenticaÃ§Ã£o (JWT)

```typescript
// JWT Payload
{
  userId: string,
  email: string,
  role: Role,
  tenantId?: string,
  iat: number,
  exp: number
}
```

- **Access Token:** 15 minutos (curto)
- **Refresh Token:** 7 dias (longo)
- **Rotation:** Refresh token Ã© rotacionado a cada uso

### 2. RBAC (Role-Based Access Control)

```typescript
enum Role {
  SUPER_ADMIN, // Acesso total (todos os tenants)
  TENANT_ADMIN, // Acesso total ao seu tenant
  USER, // Acesso limitado (apenas seus dados)
}
```

**Hierarquia:**

```
SUPER_ADMIN > TENANT_ADMIN > USER
```

### 3. Prisma RLS (Row-Level Security)

Middleware que auto-injeta `tenantId` em queries:

```typescript
// Query original
prisma.user.findMany();

// Query com RLS aplicado
prisma.user.findMany({
  where: { tenantId: currentTenantId },
});
```

**Modelos protegidos:**

- User
- Subscription
- Invoice
- Order
- AuditLog

### 4. Rate Limiting

- **Global:** 100 req/min por IP
- **Auth endpoints:** 3-5 req/min
- **Redis:** DistribuÃ­do em produÃ§Ã£o

---

## ğŸ¦ Middleware CamaleÃ£o (Multi-Tenant)

DetecÃ§Ã£o automÃ¡tica de tenant em 3 nÃ­veis:

### 1. Header (Prioridade Alta)

```http
X-Tenant-ID: uuid-do-tenant
```

### 2. Path (Prioridade MÃ©dia)

```
/tenants/empresa-abc/api/users
         ^^^^^^^^^^^
         slug do tenant
```

### 3. Subdomain (Prioridade Baixa)

```
https://empresa-abc.app.com
        ^^^^^^^^^^^
        domain do tenant
```

**Fluxo:**

```typescript
Request â†’ CamaleÃ£o Middleware â†’ Detecta Tenant â†’ Injeta tenantContext
                                                          â†“
                                                   Prisma RLS aplica filtro
```

---

## ğŸ’¾ Database Schema

### Core Models

```prisma
model Tenant {
  id        String
  name      String
  slug      String @unique
  domain    String? @unique
  status    TenantStatus

  users         User[]
  subscriptions Subscription[]
  invoices      Invoice[]
  orders        Order[]
}

model User {
  id                String
  email             String @unique
  password          String
  name              String
  role              Role
  tenantId          String?
  twoFactorEnabled  Boolean
  twoFactorSecret   String?

  tenant        Tenant?
  refreshTokens RefreshToken[]
}
```

### Billing Models

```prisma
model Subscription {
  id                   String
  tenantId             String
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               SubscriptionStatus
  planName             String
  priceMonthly         Decimal

  tenant   Tenant
  invoices Invoice[]
}

model Invoice {
  id             String
  tenantId       String
  subscriptionId String?
  invoiceNumber  String @unique
  status         InvoiceStatus
  amountDue      Decimal
  amountPaid     Decimal
  dueDate        DateTime
  paidAt         DateTime?

  tenant       Tenant
  subscription Subscription?
  payments     Payment[]
}

model Order {
  id          String
  tenantId    String
  orderNumber String @unique
  status      OrderStatus
  totalAmount Decimal
  metadata    Json?

  tenant   Tenant
  payments Payment[]
}

model Payment {
  id            String
  invoiceId     String?
  orderId       String?
  amount        Decimal
  method        PaymentMethod
  status        PaymentStatus
  pixQrCode     String?
  pixQrCodeUrl  String?

  invoice Invoice?
  order   Order?
}
```

---

## ğŸ”„ Fluxos Principais

### 1. Fluxo de AutenticaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚                                    â”‚Serverâ”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                                    â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚                                           â”‚
   â”‚  POST /api/auth/register                 â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                           â”‚
   â”‚  201 Created + user data                 â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                           â”‚
   â”‚  POST /api/auth/login                    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                           â”‚
   â”‚  200 OK + accessToken + refreshToken     â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                           â”‚
   â”‚  GET /api/users/me                       â”‚
   â”‚  Header: Authorization: Bearer <token>   â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                           â”‚
   â”‚  200 OK + user data                      â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### 2. Fluxo de Pagamento Pix

```
â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚         â”‚Serverâ”‚         â”‚Gatewayâ”‚
â””â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚                â”‚                â”‚
   â”‚ POST /pix/create                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                â”‚                â”‚
   â”‚                â”‚ Generate QR    â”‚
   â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                â”‚                â”‚
   â”‚                â”‚ QR Code        â”‚
   â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                â”‚                â”‚
   â”‚ QR + pixCode   â”‚                â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚                â”‚                â”‚
   â”‚ [User pays]    â”‚                â”‚
   â”‚                â”‚                â”‚
   â”‚                â”‚ Webhook        â”‚
   â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                â”‚                â”‚
   â”‚                â”‚ Update Payment â”‚
   â”‚                â”‚ Update Invoice â”‚
   â”‚                â”‚                â”‚
   â”‚ GET /pix/:id/status             â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                â”‚                â”‚
   â”‚ status: COMPLETED               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
```

### 3. Fluxo Multi-Tenant

```
Request: GET /api/users
Header: X-Tenant-ID: abc-123

         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tenant Middleware  â”‚
â”‚ (CamaleÃ£o)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Detecta tenant via header
         â”‚   tenantId = "abc-123"
         â”‚
         â”œâ”€> Injeta em request.tenantContext
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auth Middleware    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Verifica JWT
         â”œâ”€> Extrai userId, role
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RBAC Middleware    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Verifica permissÃµes
         â”œâ”€> TENANT_ADMIN pode acessar
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> userService.listUsers(tenantId)
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Prisma RLS         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Auto-injeta WHERE tenantId = "abc-123"
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Observability

### Prometheus Metrics

**MÃ©tricas coletadas:**

- `http_request_duration_seconds` - DuraÃ§Ã£o de requests
- `http_requests_total` - Total de requests
- `http_requests_active` - Requests ativos
- `http_request_size_bytes` - Tamanho de requests
- `http_response_size_bytes` - Tamanho de responses
- `auth_login_attempts_total` - Tentativas de login
- `database_query_duration_seconds` - DuraÃ§Ã£o de queries

### Health Checks

- `/health` - Basic health check
- `/health/ready` - Readiness probe (verifica DB)
- `/health/live` - Liveness probe (verifica app)

### Grafana Dashboards

- **API Performance:** LatÃªncia, throughput, error rate
- **Database:** Query performance, connections
- **Auth:** Login attempts, 2FA usage
- **Business:** Subscriptions, invoices, orders

---

## ğŸš€ Deployment

### Docker Compose (Development)

```yaml
services:
  api:
    build: ./apps/api
    ports: ['8000:8000']
    depends_on: [postgres, redis]

  postgres:
    image: postgres:16
    volumes: [postgres_data:/var/lib/postgresql/data]

  redis:
    image: redis:7-alpine

  prometheus:
    image: prom/prometheus
    volumes: [./prometheus.yml:/etc/prometheus/prometheus.yml]

  grafana:
    image: grafana/grafana
    ports: ['3001:3000']
```

### Production (Kubernetes)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kaven-api
spec:
  replicas: 3
  template:
    spec:
      containers:
        - name: api
          image: kaven-api:latest
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: kaven-secrets
                  key: database-url
```

---

## ğŸ”§ Tecnologias

### Backend

- **Runtime:** Node.js 20+
- **Framework:** Fastify
- **ORM:** Prisma
- **Database:** PostgreSQL 16
- **Cache:** Redis 7
- **Auth:** JWT (jose)
- **2FA:** TOTP (speakeasy)
- **Payments:** Stripe SDK
- **Validation:** Zod
- **Logging:** Winston
- **Metrics:** prom-client

### Frontend

- **Framework:** Next.js 14 (App Router)
- **Internationalization**: [i18n Implementation](architecture/INTERNATIONALIZATION.md) using `next-intl`.
- **Styling**: TailwindCSS with CSS Variables for dynamic theming./ui
- **State:** Zustand (planned)
- **API Client:** TanStack Query (planned)
- **Forms:** React Hook Form + Zod (planned)

### Infrastructure

- **Container:** Docker
- **Orchestration:** Docker Compose / Kubernetes
- **Monitoring:** Prometheus + Grafana
- **CI/CD:** GitHub Actions (planned)

---

## ğŸ“ˆ Escalabilidade

### Horizontal Scaling

- **API:** Stateless, pode escalar horizontalmente
- **Rate Limiting:** Redis distribuÃ­do
- **Sessions:** JWT stateless (sem sessÃµes no servidor)

### Vertical Scaling

- **Database:** PostgreSQL com read replicas
- **Cache:** Redis Cluster
- **Files:** S3-compatible storage

### Performance

- **Connection Pooling:** Prisma connection pool
- **Query Optimization:** Indexes, selective fields
- **Caching:** Redis para rate limiting e sessions
- **CDN:** Static assets via CDN (planned)

---

## ğŸ”’ SeguranÃ§a

### OWASP Top 10 Mitigations

1. **Injection:** Prisma ORM (prepared statements)
2. **Broken Auth:** JWT + 2FA + refresh token rotation
3. **Sensitive Data:** bcrypt password hashing
4. **XML External Entities:** N/A (JSON API)
5. **Broken Access Control:** RBAC + RLS
6. **Security Misconfiguration:** Environment variables
7. **XSS:** Input validation (Zod)
8. **Insecure Deserialization:** JSON only
9. **Components with Known Vulnerabilities:** Dependabot
10. **Insufficient Logging:** Winston + Audit logs

### Headers de SeguranÃ§a

```typescript
// TODO: Implementar
- Content-Security-Policy
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Strict-Transport-Security
- X-XSS-Protection
```

---

## ğŸ“ PrÃ³ximos Passos

- [ ] Implementar testes (unit + integration + E2E)
- [ ] Completar frontend dashboard
- [ ] Adicionar CI/CD pipeline
- [ ] Implementar file upload (S3)
- [ ] Adicionar email templates
- [ ] Configurar security headers
- [ ] Deploy em staging/production

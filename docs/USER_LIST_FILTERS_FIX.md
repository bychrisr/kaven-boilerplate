# Fix: Contadores Inst√°veis nos Filtros da Lista de Usu√°rios

## Problema Reportado

Contadores dos filtros (All, Active, Pending, Banned, Rejected) mudavam incorretamente ao clicar:

- All mostrava 9, Active mostrava 6
- Ao clicar em Active ‚Üí All mudava para 6, Active mudava para 8
- N√∫meros ficavam "dan√ßando" entre os filtros

## Investiga√ß√£o

### Sintomas Observados

**Logs do Frontend:**

```
üìä [getStatusCount] status: all, count: 6, filterStatus: all
üìä [getStatusCount] status: active, count: 6, filterStatus: all
üìä [getStatusCount] status: pending, count: 0, filterStatus: all
```

**Logs do Backend:**

```
üìä [getStats] tenantId: b51e68bf-e541-45c0-aed7-87dd5c3479c8
üìä [getStats] where: {"tenantId":"b51e68bf-e541-45c0-aed7-87dd5c3479c8","deletedAt":null}
üìä [getStats] Results: { total: 6, active: 6, pending: 0, banned: 0, rejected: 0 }
```

Mas `listUsers` retornava `total: 9` (sem filtro de tenant).

### Causa Raiz Dupla

#### 1. Problema no Frontend (Race Condition)

**Arquivo:** `apps/admin/sections/user/view/user-view.tsx`

**C√≥digo Problem√°tico:**

```typescript
const getStatusCount = (status: string) => {
  const isCurrentlySelected =
    (status === 'all' && filterStatus === 'all') ||
    (status !== 'all' && status.toUpperCase() === filterStatus.toUpperCase());

  if (isCurrentlySelected) {
    return totalUsers; // ‚ùå PROBLEMA: usa dados da query filtrada
  }

  return statusCounts[status as keyof typeof statusCounts] ?? 0;
};
```

**Problema:** Misturava duas fontes de dados:

- Tab selecionada: `totalUsers` (dados din√¢micos da query filtrada)
- Tabs n√£o selecionadas: `statusCounts` (stats globais fixos)

**Race Condition:**

1. Usu√°rio clica em "Active"
2. `filterStatus` muda para "active" (s√≠ncrono)
3. `totalUsers` ainda √© 9 (dados do filtro anterior)
4. `getStatusCount("active")` retorna 9 ‚ùå
5. Query nova executa
6. `totalUsers` atualiza para 6
7. Re-render: `getStatusCount("active")` retorna 6 ‚úÖ

Entre os passos 4 e 7, o contador estava **ERRADO**!

#### 2. Problema no Backend (Inconsist√™ncia de Filtros)

**Arquivo:** `apps/api/src/modules/users/controllers/user.controller.ts`

**Inconsist√™ncia:**

**`getStats` (ANTES):**

```typescript
const tenantId = request.headers['x-tenant-id']; // ‚ùå Usa header
const stats = await userService.getStats(tenantId);
```

**`listUsers`:**

```typescript
const { tenantId } = request.query; // ‚úÖ Usa query parameter
const result = await userService.listUsers(tenantId, ...);
```

**Resultado:**

- `getStats` filtrava por tenant (6 usu√°rios do tenant)
- `listUsers` N√ÉO filtrava para SUPER_ADMIN (9 usu√°rios globais)
- **Inconsist√™ncia:** Contadores mostravam 6, lista mostrava 9!

---

## Solu√ß√£o Implementada

### 1. Frontend: Usar APENAS Stats Globais

**Arquivo:** `apps/admin/sections/user/view/user-view.tsx`

**C√≥digo Corrigido:**

```typescript
const getStatusCount = (status: string) => {
  return statusCounts[status as keyof typeof statusCounts] ?? 0;
};
```

**Benef√≠cios:**

- ‚úÖ Elimina race condition
- ‚úÖ Contadores sempre est√°veis
- ‚úÖ Simplifica c√≥digo (14 linhas ‚Üí 3 linhas)
- ‚úÖ Uma √∫nica fonte de verdade (statusCounts)

**Comportamento:**

- "All" sempre mostra total global (ex: 9)
- "Active" sempre mostra total de ativos globais (ex: 7)
- "Pending" sempre mostra total de pendentes globais (ex: 1)
- N√∫meros **NUNCA** mudam, independente do filtro selecionado

### 2. Backend: Consist√™ncia de Filtros

**Arquivo:** `apps/api/src/modules/users/controllers/user.controller.ts`

**C√≥digo Corrigido:**

```typescript
async getStats(request: FastifyRequest, reply: FastifyReply) {
  try {
    // N√ÉO usar x-tenant-id automaticamente
    // SUPER_ADMIN deve ver stats globais (sem filtro de tenant)
    // Se precisar filtrar por tenant, passar como query parameter
    const { tenantId } = request.query as any;
    const stats = await userService.getStats(tenantId);
    reply.send(stats);
  } catch (error: any) {
    reply.status(400).send({ error: error.message });
  }
}
```

**Mudan√ßa:**

- ‚ùå ANTES: `request.headers['x-tenant-id']` (autom√°tico)
- ‚úÖ DEPOIS: `request.query.tenantId` (expl√≠cito)

**Benef√≠cios:**

- ‚úÖ Consist√™ncia com `listUsers`
- ‚úÖ SUPER_ADMIN v√™ stats globais
- ‚úÖ Filtro por tenant apenas quando explicitamente solicitado

---

## Arquivos Modificados

### Frontend

- `apps/admin/sections/user/view/user-view.tsx` - Simplifica getStatusCount

### Backend

- `apps/api/src/modules/users/controllers/user.controller.ts` - Usa query parameter
- `apps/api/src/modules/users/services/user.service.ts` - Logs de debug (removidos)

---

## Valida√ß√£o

### Antes da Corre√ß√£o

```
Estado inicial:
- All: 9 ‚úÖ
- Active: 6 ‚úÖ

Clica em "Active":
- All: 6 ‚ùå (errado! deveria ser 9)
- Active: 8 ‚ùå (errado! deveria ser 6)
```

### Depois da Corre√ß√£o

```
Estado inicial:
- All: 9 ‚úÖ
- Active: 7 ‚úÖ
- Pending: 1 ‚úÖ
- Banned: 1 ‚úÖ
- Rejected: 0 ‚úÖ

Clica em "Active":
- All: 9 ‚úÖ (correto! n√£o muda)
- Active: 7 ‚úÖ (correto! n√£o muda)

Clica em "Pending":
- All: 9 ‚úÖ
- Active: 7 ‚úÖ
- Pending: 1 ‚úÖ
```

**Contadores permanecem EST√ÅVEIS independente do filtro selecionado!** ‚úÖ

---

## Li√ß√µes Aprendidas

### 1. Nunca Misture Fontes de Dados Din√¢micas e Est√°ticas

**Padr√£o Problem√°tico:**

```typescript
// ‚ùå NUNCA fa√ßa isso:
const getValue = () => {
  if (isSelected) {
    return dynamicData; // Dados que podem estar desatualizados
  }
  return cachedData;
};
```

**Padr√£o Correto:**

```typescript
// ‚úÖ SEMPRE use uma √∫nica fonte de verdade:
const getValue = () => {
  return cachedData; // Sempre consistente
};
```

### 2. Consist√™ncia Entre Endpoints

Endpoints relacionados devem usar a **mesma l√≥gica de filtros**:

- ‚úÖ Ambos usam query parameters
- ‚úÖ Ambos respeitam permiss√µes de SUPER_ADMIN
- ‚úÖ Ambos retornam dados consistentes

### 3. Quando Usar Dados Din√¢micos

Dados din√¢micos (como `totalUsers`) devem ser usados APENAS para:

- ‚úÖ Exibir a lista filtrada
- ‚úÖ Mostrar pagina√ß√£o ("1-5 of 7")
- ‚úÖ Indicadores de "X resultados encontrados"

**NUNCA** para contadores de filtros que devem ser est√°veis!

---

## Rela√ß√£o com Problema Anterior (Tenant Select)

Este problema tem a **MESMA CAUSA RAIZ** do bug do Tenant Select:

**Tenant Select (Problema Anterior):**

- `tenantId` mudava (s√≠ncrono)
- `tenants` ainda n√£o carregados (ass√≠ncrono)
- Select mostrava valor errado temporariamente

**User Filters (Problema Atual):**

- `filterStatus` mudava (s√≠ncrono)
- `totalUsers` ainda n√£o atualizado (ass√≠ncrono)
- Contadores mostravam valores errados temporariamente

**Solu√ß√£o Comum:**

- **N√£o misturar estado s√≠ncrono com dados ass√≠ncronos**
- **Usar apenas uma fonte de verdade est√°vel**

---

## Commits Realizados

```bash
# 1. Corre√ß√£o do frontend
fix(admin): corrige contadores inst√°veis nos filtros de usu√°rios

# 2. Corre√ß√£o do backend
fix(api): corrige getStats para respeitar permiss√µes de SUPER_ADMIN

# 3. Limpeza
chore: remove logs de debug dos contadores de usu√°rios
```

---

## Refer√™ncias

- [Documenta√ß√£o do Tenant Select Fix](file:///home/bychrisr/projects/kaven-boilerplate/docs/USER_EDIT_TENANT_FIX.md)
- [React: Avoiding Race Conditions](https://react.dev/learn/you-might-not-need-an-effect#fetching-data)
- [TanStack Query: Stale While Revalidate](https://tanstack.com/query/latest/docs/framework/react/guides/important-defaults)

---

**Data:** 2025-12-26  
**Vers√£o:** 1.0.0  
**Status:** ‚úÖ Resolvido e Validado

# Kaven Boilerplate - DocumentaÃ§Ã£o de ImplementaÃ§Ã£o

> **Data:** 2025-12-24
> **Status:** MVP Implementado + Axisor Security Hardening
> **Tempo:** ~14 horas

---

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Arquitetura](#arquitetura)
3. [Backend API](#backend-api)
4. [Frontend](#frontend)
5. [Database](#database)
6. [SeguranÃ§a & Hardening](SECURITY_ARCHITECTURE.md)
7. [UI Design](UI_DESIGN.md)
8. [Como Executar](#como-executar)
9. [Estrutura de Arquivos](#estrutura-de-arquivos)
10. [PrÃ³ximos Passos](#prÃ³ximos-passos)

---

## ğŸ¯ VisÃ£o Geral

O **Kaven Boilerplate** Ã© uma base sÃ³lida para aplicaÃ§Ãµes SaaS multi-tenant, construÃ­da com as melhores prÃ¡ticas de desenvolvimento moderno.

### Stack TecnolÃ³gica

**Backend:**

- **AutenticaÃ§Ã£o AvanÃ§ada**: JWT, Refresh Tokens, 2FA, e RBAC.
- **Multi-tenancy Nativo**: Isolamento lÃ³gico de dados por tenant via middleware "CamaleÃ£o".
- **Observabilidade**: [Dashboard nativo](OBSERVABILITY.md) com mÃ©tricas em tempo real e logs de auditoria.
- Node.js 20 LTS + TypeScript 5.3
- Fastify 4 (API REST)
- Prisma 5 (ORM)
- PostgreSQL 16
- Redis 7

**Frontend:**

- **Frontend Moderno**: Next.js 14 (App Router) com Shadcn UI.
- React 18
- TypeScript 5.3
- Tailwind CSS

**SeguranÃ§a:**

- JWT (jose library)
- bcrypt (cost factor 12)
- 2FA TOTP (speakeasy)
- ValidaÃ§Ã£o Zod

---

## ğŸ—ï¸ Arquitetura

### Multi-Tenant "CamaleÃ£o"

O sistema foi projetado para suportar:

- **Modo SINGLE:** Um Ãºnico tenant (mais simples)
- **Modo MULTI:** MÃºltiplos tenants com isolamento completo

DetecÃ§Ã£o de tenant via:

- Subdomain (`empresa1.app.com`)
- Header (`X-Tenant-ID`)
- Path (`/tenants/:slug`)

### Estrutura Monorepo (Turborepo)

```
kaven-boilerplate/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/          # Backend Fastify
â”‚   â””â”€â”€ admin/        # Frontend Next.js
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/       # CÃ³digo compartilhado
â”‚   â””â”€â”€ ui/           # Componentes UI
â””â”€â”€ prisma/           # Schema e migraÃ§Ãµes
```

---

## ğŸ”Œ Backend API

### Endpoints Implementados (21 total)

#### ğŸ” AutenticaÃ§Ã£o (`/api/auth`) - 10 endpoints

| MÃ©todo | Rota               | DescriÃ§Ã£o                  |
| ------ | ------------------ | -------------------------- |
| POST   | `/register`        | Registra novo usuÃ¡rio      |
| POST   | `/verify-email`    | Verifica email             |
| POST   | `/login`           | Login com JWT              |
| POST   | `/refresh`         | Renova access token        |
| POST   | `/logout`          | Invalida refresh token     |
| POST   | `/forgot-password` | Envia email de recuperaÃ§Ã£o |
| POST   | `/reset-password`  | Reseta senha               |
| POST   | `/2fa/setup`       | Configura 2FA + QR code    |
| POST   | `/2fa/verify`      | Verifica cÃ³digo TOTP       |
| POST   | `/2fa/disable`     | Desabilita 2FA             |

#### ğŸ‘¥ Users (`/api/users`) - 6 endpoints

| MÃ©todo | Rota   | DescriÃ§Ã£o                 |
| ------ | ------ | ------------------------- |
| GET    | `/`    | Lista usuÃ¡rios (paginado) |
| GET    | `/me`  | UsuÃ¡rio atual             |
| GET    | `/:id` | Busca por ID              |
| POST   | `/`    | Cria usuÃ¡rio              |
| PUT    | `/:id` | Atualiza usuÃ¡rio          |
| DELETE | `/:id` | Deleta (soft delete)      |

#### ğŸ¢ Tenants (`/api/tenants`) - 5 endpoints

| MÃ©todo | Rota   | DescriÃ§Ã£o                |
| ------ | ------ | ------------------------ |
| GET    | `/`    | Lista tenants (paginado) |
| GET    | `/:id` | Busca por ID             |
| POST   | `/`    | Cria tenant              |
| PUT    | `/:id` | Atualiza tenant          |
| DELETE | `/:id` | Deleta (soft delete)     |

### Estrutura de Services

Cada mÃ³dulo segue a arquitetura em camadas:

```
modules/auth/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ auth.service.ts      # LÃ³gica de negÃ³cio
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ auth.controller.ts   # Handlers HTTP
â””â”€â”€ routes/
    â””â”€â”€ auth.routes.ts       # DefiniÃ§Ã£o de rotas
```

**Exemplo de uso:**

```typescript
// Service (lÃ³gica)
export class AuthService {
  async login(data: LoginInput) {
    const user = await prisma.user.findUnique({ where: { email: data.email } });
    // ... validaÃ§Ãµes
    const accessToken = await generateAccessToken({ userId: user.id, ... });
    return { accessToken, user };
  }
}

// Controller (HTTP)
export class AuthController {
  async login(request, reply) {
    const data = loginSchema.parse(request.body);
    const result = await authService.login(data);
    reply.send(result);
  }
}
```

---

## ğŸ¨ Frontend

### PÃ¡ginas Implementadas (3)

#### `/setup` - Setup Wizard

- Assistente de configuraÃ§Ã£o inicial em 4 etapas
- Step 1: Branding & Global Settings (nome, email, senha, idioma, moeda, cor)
- Step 2: Architecture Selection (Single vs Multi-tenant)
- Step 3: Administrative Team (seleÃ§Ã£o de personas)
- Step 4: Finalization (resumo e instalaÃ§Ã£o)
- ValidaÃ§Ã£o visual de senha em tempo real
- Design dark glassmorphism consistente
- DocumentaÃ§Ã£o completa em [SETUP_WIZARD.md](SETUP_WIZARD.md)

#### `/login` - PÃ¡gina de Login

- FormulÃ¡rio com email/senha
- IntegraÃ§Ã£o com API `/api/auth/login`
- Tratamento de erros
- Loading states
- Redirecionamento pÃ³s-login

#### `/dashboard` - Dashboard

- ProteÃ§Ã£o de rota (verifica token)
- ExibiÃ§Ã£o de dados do usuÃ¡rio
- EstatÃ­sticas bÃ¡sicas
- Logout funcional

### Exemplo de IntegraÃ§Ã£o com API

```typescript
// Login
const response = await fetch('http://localhost:8000/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email, password }),
});

const data = await response.json();

// Salvar tokens
localStorage.setItem('accessToken', data.accessToken);
localStorage.setItem('refreshToken', data.refreshToken);
```

---

## ğŸ—„ï¸ Database

### Schema Prisma (11 modelos)

```prisma
model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  status    TenantStatus @default(ACTIVE)
  users     User[]
  // ... mais campos
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  password         String
  name             String
  role             Role     @default(USER)
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?
  tenantId         String?
  tenant           Tenant?  @relation(...)
  // ... mais campos
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  user      User     @relation(...)
}

// + AuditLog, Subscription, Invoice, Order, Payment
```

### Enums

- `TenantStatus`: ACTIVE, SUSPENDED, DELETED
- `Role`: SUPER_ADMIN, TENANT_ADMIN, USER
- `SubscriptionStatus`: ACTIVE, CANCELED, PAST_DUE, TRIALING, EXPIRED
- `InvoiceStatus`: DRAFT, PENDING, PAID, OVERDUE, CANCELED
- `OrderStatus`: PENDING, PROCESSING, COMPLETED, CANCELED, REFUNDED
- `PaymentMethod`: STRIPE, PIX, CREDIT_CARD, BOLETO
- `PaymentStatus`: PENDING, COMPLETED, FAILED, REFUNDED

---

## ğŸ” SeguranÃ§a

### AutenticaÃ§Ã£o JWT

```typescript
// Access Token (curta duraÃ§Ã£o: 15min)
const accessToken = await generateAccessToken({
  userId: user.id,
  email: user.email,
  role: user.role,
  tenantId: user.tenantId,
});

// Refresh Token (longa duraÃ§Ã£o: 7 dias)
const refreshToken = generateRefreshToken(); // UUID-like
await prisma.refreshToken.create({
  data: { token: refreshToken, userId: user.id, expiresAt: ... }
});
```

### Hash de Senhas (bcrypt)

```typescript
// Registro
const hashedPassword = await hashPassword(plainPassword); // cost: 12

// Login
const isValid = await comparePassword(plainPassword, hashedPassword);
```

### 2FA TOTP

```typescript
// Setup
const { secret, qrCodeUrl } = await generate2FASecret(email);
const backupCodes = generateBackupCodes(); // 10 cÃ³digos

// VerificaÃ§Ã£o
const isValid = verify2FACode(secret, userInputCode);
```

### ValidaÃ§Ã£o (Zod)

```typescript
const loginSchema = z.object({
  email: z.string().email('Email invÃ¡lido'),
  password: z.string().min(1, 'Senha Ã© obrigatÃ³ria'),
  twoFactorCode: z.string().length(6).optional(),
});

const data = loginSchema.parse(request.body); // Throws se invÃ¡lido
```

---

## ğŸš€ Como Executar

### PrÃ©-requisitos

```bash
# VersÃµes necessÃ¡rias
node --version  # v20+
pnpm --version  # v8+
docker --version
```

### 1. Instalar DependÃªncias

```bash
pnpm install
```

### 2. Configurar VariÃ¡veis de Ambiente

```bash
cp .env.example .env
```

Editar `.env`:

```env
DATABASE_URL="postgresql://kaven:kaven_dev_password@localhost:5432/kaven_dev"
REDIS_URL="redis://localhost:6379"
JWT_SECRET="seu-secret-super-seguro-aqui"
NODE_ENV="development"
PORT=8000
```

### 3. Iniciar Docker

```bash
docker-compose up -d
```

Verifica containers:

```bash
docker ps
# Deve mostrar: kaven-postgres, kaven-redis, kaven-pgadmin
```

### 4. Rodar MigraÃ§Ãµes

```bash
npx prisma migrate dev
npx prisma generate
```

### 5. Iniciar Backend

```bash
cd apps/api
pnpm dev
```

Backend rodarÃ¡ em: **http://localhost:8000**

### 6. Iniciar Frontend

```bash
cd apps/admin
pnpm dev
```

Frontend rodarÃ¡ em: **http://localhost:3000**

### 7. Acessar a AplicaÃ§Ã£o

1. Acesse: http://localhost:3000/login
2. Registre um usuÃ¡rio via API ou use credentials de seed

---

## ğŸ“ Estrutura de Arquivos

```
kaven-boilerplate/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/                    # Bibliotecas compartilhadas
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ prisma.ts          # Cliente Prisma
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.ts             # UtilitÃ¡rios JWT
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ bcrypt.ts          # Hash de senhas
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ 2fa.ts             # TOTP + QR codes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validation.ts      # Schemas Zod
â”‚   â”‚   â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services/auth.service.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ controllers/auth.controller.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ routes/auth.routes.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services/user.service.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ controllers/user.controller.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ routes/user.routes.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tenants/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ services/tenant.service.ts
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ controllers/tenant.controller.ts
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ routes/tenant.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts              # Servidor Fastify
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ admin/
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ login/
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx           # PÃ¡gina de login
â”‚       â”‚   â”œâ”€â”€ dashboard/
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx           # Dashboard
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â””â”€â”€ page.tsx
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma                  # Schema completo
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 20251220002433_mvp_complete_schema/
â”œâ”€â”€ .agent/
â”‚   â”œâ”€â”€ reports/                       # RelatÃ³rios de telemetria
â”‚   â”œâ”€â”€ scripts/                       # Scripts de automaÃ§Ã£o
â”‚   â””â”€â”€ workflows/                     # Workflows documentados
â”œâ”€â”€ docker-compose.yml                 # PostgreSQL + Redis
â”œâ”€â”€ package.json                       # Raiz do monorepo
â”œâ”€â”€ turbo.json                         # ConfiguraÃ§Ã£o Turborepo
â””â”€â”€ pnpm-workspace.yaml               # Workspaces
```

---

## ğŸ“Š PrÃ³ximos Passos

### Curto Prazo (1-2 semanas)

- [ ] **Middleware CamaleÃ£o:** DetecÃ§Ã£o automÃ¡tica de tenant
- [ ] **RBAC Middleware:** Controle de permissÃµes
- [ ] **Payment System:** IntegraÃ§Ã£o Stripe + Pix
- [ ] **Frontend Auth Completo:** 9 pÃ¡ginas de autenticaÃ§Ã£o
- [ ] **Testes UnitÃ¡rios:** 80%+ coverage

### MÃ©dio Prazo (3-4 semanas)

- [ ] **Frontend Dashboard Completo:** 27 pÃ¡ginas
- [ ] **Observability:** Prometheus + Grafana dashboards
- [ ] **CI/CD:** GitHub Actions pipeline
- [ ] **Testes E2E:** Playwright
- [ ] **DocumentaÃ§Ã£o API:** Swagger/OpenAPI

### Longo Prazo (Post-MVP)

- [ ] **CRM Module:** Leads, Deals, Contacts
- [ ] **Advanced Invoicing:** Templates, Recurring, Multi-currency
- [ ] **File Manager:** S3 integration
- [ ] **Real-time Chat:** WebSocket
- [ ] **Email System:** Internal mail
- [ ] **Referral Program:** Tracking, Rewards

---

## ğŸ“ˆ EstatÃ­sticas

### CÃ³digo Implementado

- **Backend:** ~2.000 linhas TypeScript
- **Frontend:** ~300 linhas TypeScript/TSX
- **Database:** 11 modelos Prisma
- **Total:** 21+ arquivos criados

### Commits Realizados

1. `d7e0b56` - feat: mÃ³dulo completo de autenticaÃ§Ã£o
2. `99bd269` - feat: mÃ³dulos users e tenants management
3. `521c8a8` - feat: frontend funcional
4. `[prÃ³ximo]` - fix: corrige TypeScript errors

### Telemetria

- 3 workflows executados
- 3 relatÃ³rios gerados
- ~2 horas de desenvolvimento

---

## ğŸ¤ Contribuindo

Para contribuir com o projeto:

1. Siga os [Conventional Commits](https://www.conventionalcommits.org/)
2. Mantenha coverage de testes acima de 80%
3. Execute linting: `pnpm lint`
4. Teste localmente antes de commitar

---

## ğŸ“ LicenÃ§a

MIT

---

**Ãšltima atualizaÃ§Ã£o:** 2025-12-19  
**VersÃ£o:** 0.3.0 (MVP Parcial)

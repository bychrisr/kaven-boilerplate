# Plans & Products System - DocumentaÃ§Ã£o TÃ©cnica

**VersÃ£o:** 1.0.0  
**Data:** 05 de janeiro de 2026  
**Status:** âœ… IMPLEMENTADO (Database Schema) | ğŸ”„ EM IMPLEMENTAÃ‡ÃƒO (API Endpoints)

---

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Arquitetura](#arquitetura)
3. [Modelos de Dados](#modelos-de-dados)
4. [API Endpoints](#api-endpoints)
5. [Fluxos de NegÃ³cio](#fluxos-de-negÃ³cio)
6. [Exemplos de Uso](#exemplos-de-uso)
7. [Guias de ImplementaÃ§Ã£o](#guias-de-implementaÃ§Ã£o)

---

## 1. VisÃ£o Geral

### 1.1 Objetivo

Sistema completo de **Plans & Products** para monetizaÃ§Ã£o SaaS que suporta:

- âœ… **Subscription Plans** (Free, Basic, Pro, Enterprise)
- âœ… **One-time Products** (Add-ons, CrÃ©ditos, LicenÃ§as)
- âœ… **Feature Flags** (Controle de acesso por features)
- âœ… **Quotas** (Limites configurÃ¡veis por plano)
- âœ… **Multi-tenant** (Planos globais ou por tenant)
- âœ… **Multi-provider** (Stripe, PagueBit, MercadoPago)

### 1.2 Componentes Principais

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PLANS & PRODUCTS SYSTEM                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Feature â”‚â”€â”€â”€â–¶â”‚   Plan   â”‚â”€â”€â”€â–¶â”‚ Subscription â”‚          â”‚
â”‚  â”‚ (Catalog)â”‚    â”‚(Template)â”‚    â”‚   (Active)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚       â”‚               â”‚                                      â”‚
â”‚       â”‚               â–¼                                      â”‚
â”‚       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚       â”‚          â”‚  Price   â”‚                               â”‚
â”‚       â”‚          â”‚(Variants)â”‚                               â”‚
â”‚       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Product  â”‚â”€â”€â”€â–¶â”‚  Effect  â”‚â”€â”€â”€â–¶â”‚ Purchase â”‚             â”‚
â”‚  â”‚(One-time)â”‚    â”‚ (Impact) â”‚    â”‚ (Record) â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Arquitetura

### 2.1 Estrutura de Arquivos

```
apps/api/src/modules/
â”œâ”€â”€ plans/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â””â”€â”€ plan.controller.ts       # HTTP handlers
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ plan.service.ts          # Business logic
â”‚   â”‚   â””â”€â”€ feature.service.ts       # Feature management
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ plan.routes.ts           # Route definitions
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ create-plan.dto.ts       # Input validation
â”‚   â”‚   â”œâ”€â”€ update-plan.dto.ts
â”‚   â”‚   â””â”€â”€ plan-response.dto.ts     # Output formatting
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ plan.types.ts            # TypeScript types
â”‚
â”œâ”€â”€ products/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â””â”€â”€ product.controller.ts
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ product.service.ts
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ product.routes.ts
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ create-product.dto.ts
â”‚   â”‚   â”œâ”€â”€ update-product.dto.ts
â”‚   â”‚   â””â”€â”€ product-response.dto.ts
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ product.types.ts
â”‚
â””â”€â”€ subscriptions/
    â”œâ”€â”€ controllers/
    â”‚   â””â”€â”€ subscription.controller.ts
    â”œâ”€â”€ services/
    â”‚   â”œâ”€â”€ subscription.service.ts
    â”‚   â””â”€â”€ entitlement.service.ts   # Feature access control
    â”œâ”€â”€ routes/
    â”‚   â””â”€â”€ subscription.routes.ts
    â”œâ”€â”€ dto/
    â”‚   â”œâ”€â”€ upgrade-plan.dto.ts
    â”‚   â””â”€â”€ subscription-response.dto.ts
    â””â”€â”€ types/
        â””â”€â”€ subscription.types.ts
```

### 2.2 Camadas de AbstraÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT (Frontend)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ROUTES (Fastify)                        â”‚
â”‚  - Validation (Zod schemas)                              â”‚
â”‚  - Authentication (JWT middleware)                       â”‚
â”‚  - Authorization (RBAC middleware)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CONTROLLERS                              â”‚
â”‚  - Request/Response handling                             â”‚
â”‚  - DTO transformation                                    â”‚
â”‚  - Error handling                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SERVICES                                â”‚
â”‚  - Business logic                                        â”‚
â”‚  - Transaction management                                â”‚
â”‚  - Event emission                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PRISMA CLIENT (ORM)                         â”‚
â”‚  - Database queries                                      â”‚
â”‚  - Type safety                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              POSTGRESQL DATABASE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Modelos de Dados

### 3.1 Feature (CatÃ¡logo de Funcionalidades)

```prisma
model Feature {
  id           String      @id @default(uuid())
  code         String      @unique          // Ex: "USERS", "STORAGE_MB"
  name         String                       // Ex: "UsuÃ¡rios", "Armazenamento"
  description  String?
  type         FeatureType @default(BOOLEAN) // BOOLEAN | QUOTA | CUSTOM
  defaultValue String?
  unit         String?                      // Ex: "users", "MB", "calls"
  category     String?                      // Ex: "Limits", "Features"
  sortOrder    Int         @default(0)
  isActive     Boolean     @default(true)

  planFeatures   PlanFeature[]
  productEffects ProductEffect[]
  usageRecords   UsageRecord[]
}

enum FeatureType {
  BOOLEAN   // On/Off (ex: "API Access")
  QUOTA     // Numeric limit (ex: "5 users")
  CUSTOM    // Custom value (ex: "Custom domain: example.com")
}
```

**Exemplos de Features:**

| Code                  | Name                | Type    | Unit  | Default |
| --------------------- | ------------------- | ------- | ----- | ------- |
| `USERS`               | UsuÃ¡rios            | QUOTA   | users | 1       |
| `STORAGE_MB`          | Armazenamento       | QUOTA   | MB    | 100     |
| `API_CALLS_MONTH`     | Chamadas API/mÃªs    | QUOTA   | calls | 1000    |
| `DASHBOARD_ANALYTICS` | Dashboard Analytics | BOOLEAN | -     | false   |
| `EXPORT_CSV`          | Exportar CSV        | BOOLEAN | -     | false   |
| `CUSTOM_DOMAIN`       | DomÃ­nio Customizado | BOOLEAN | -     | false   |

### 3.2 Plan (Plano de Assinatura)

```prisma
model Plan {
  id              String   @id @default(uuid())
  tenantId        String?                    // null = plano global
  code            String                     // Ex: "free", "pro"
  name            String                     // Ex: "Plano Pro"
  description     String?
  type            PlanType @default(SUBSCRIPTION)
  trialDays       Int      @default(0)
  isDefault       Boolean  @default(false)  // Plano padrÃ£o para novos tenants
  isPublic        Boolean  @default(true)   // VisÃ­vel na pricing page
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)
  badge           String?                    // Ex: "Popular", "Best Value"
  stripeProductId String?  @unique
  metadata        Json?

  prices        Price[]
  features      PlanFeature[]
  subscriptions Subscription[]
}

enum PlanType {
  SUBSCRIPTION  // Recorrente
  LIFETIME      // Pagamento Ãºnico, acesso vitalÃ­cio
}
```

### 3.3 Price (VariaÃ§Ãµes de PreÃ§o)

```prisma
model Price {
  id             String          @id @default(uuid())
  planId         String
  code           String?
  interval       BillingInterval @default(MONTHLY)
  intervalCount  Int             @default(1)  // Ex: 3 para trimestral
  amount         Decimal         @db.Decimal(10, 2)
  currency       String          @default("BRL")
  originalAmount Decimal?        @db.Decimal(10, 2)  // Para mostrar desconto
  isActive       Boolean         @default(true)
  stripePriceId  String?         @unique
  pagueBitPriceId String?
  metadata       Json?

  plan          Plan
  subscriptions Subscription[]
}

enum BillingInterval {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
  FOREVER       // Free tier
}
```

### 3.4 PlanFeature (Features do Plano)

```prisma
model PlanFeature {
  id              String   @id @default(uuid())
  planId          String
  featureId       String
  enabled         Boolean  @default(true)     // Para BOOLEAN features
  limitValue      Int?                        // Para QUOTA features (-1 = unlimited)
  customValue     String?                     // Para CUSTOM features
  displayOverride String?                     // Override de texto na UI

  plan    Plan
  feature Feature

  @@unique([planId, featureId])
}
```

**Exemplo de ConfiguraÃ§Ã£o:**

```typescript
// Plano Pro
{
  planId: "plan_pro_uuid",
  features: [
    { featureId: "USERS", limitValue: 25 },
    { featureId: "STORAGE_MB", limitValue: 10000 },
    { featureId: "API_CALLS_MONTH", limitValue: 100000 },
    { featureId: "DASHBOARD_ANALYTICS", enabled: true },
    { featureId: "EXPORT_CSV", enabled: true },
    { featureId: "CUSTOM_DOMAIN", enabled: true },
  ]
}
```

### 3.5 Product (Produto One-time)

```prisma
model Product {
  id              String      @id @default(uuid())
  tenantId        String?                      // null = produto global
  code            String                       // Ex: "extra_storage_10gb"
  name            String                       // Ex: "Armazenamento Extra (10GB)"
  description     String?
  type            ProductType @default(ONE_TIME)
  price           Decimal     @db.Decimal(10, 2)
  currency        String      @default("BRL")
  originalPrice   Decimal?    @db.Decimal(10, 2)
  isActive        Boolean     @default(true)
  isPublic        Boolean     @default(true)
  sortOrder       Int         @default(0)
  stock           Int         @default(-1)     // -1 = ilimitado
  maxPerTenant    Int         @default(-1)     // -1 = ilimitado
  stripeProductId String?     @unique
  stripePriceId   String?     @unique
  imageUrl        String?
  metadata        Json?

  effects   ProductEffect[]
  purchases Purchase[]
}

enum ProductType {
  ONE_TIME    // Compra Ãºnica
  CONSUMABLE  // Pode comprar mÃºltiplas vezes
  ADD_ON      // Adiciona Ã  subscription
}
```

### 3.6 ProductEffect (Efeito do Produto)

```prisma
model ProductEffect {
  id           String     @id @default(uuid())
  productId    String
  featureId    String
  effectType   EffectType @default(ADD)
  value        Int?
  isPermanent  Boolean    @default(false)  // Sobrevive a mudanÃ§as de plano
  durationDays Int?                        // null = permanente

  product Product
  feature Feature

  @@unique([productId, featureId])
}

enum EffectType {
  ADD      // Adiciona ao limite atual
  SET      // Define valor absoluto
  MULTIPLY // Multiplica limite atual
  ENABLE   // Habilita feature boolean
}
```

**Exemplo:**

```typescript
// Produto: "Armazenamento Extra (10GB)"
{
  productId: "prod_storage_uuid",
  effects: [
    {
      featureId: "STORAGE_MB",
      effectType: "ADD",
      value: 10000,  // +10GB
      isPermanent: false,
      durationDays: 365  // VÃ¡lido por 1 ano
    }
  ]
}
```

### 3.7 Subscription (Assinatura Ativa)

```prisma
model Subscription {
  id                     String             @id @default(uuid())
  tenantId               String             @unique
  planId                 String
  priceId                String?
  stripeCustomerId       String?            @unique
  stripeSubscriptionId   String?            @unique
  status                 SubscriptionStatus @default(TRIALING)
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)
  canceledAt             DateTime?
  cancelReason           String?
  trialEnd               DateTime?
  discountCode           String?
  discountPercent        Int?
  metadata               Json?

  tenant   Tenant
  plan     Plan
  price    Price?
  invoices Invoice[]
}

enum SubscriptionStatus {
  ACTIVE      // Ativa e paga
  TRIALING    // Em perÃ­odo de trial
  PAST_DUE    // Pagamento atrasado
  CANCELED    // Cancelada
  EXPIRED     // Expirada
}
```

---

## 4. API Endpoints

### 4.1 Plans API

#### GET /api/plans

Lista todos os planos pÃºblicos.

**Query Parameters:**

```typescript
{
  tenantId?: string;  // Filtrar por tenant (admin only)
  isActive?: boolean; // Filtrar ativos/inativos
  type?: 'SUBSCRIPTION' | 'LIFETIME';
}
```

**Response:**

```typescript
{
  plans: [
    {
      id: 'uuid',
      code: 'pro',
      name: 'Plano Pro',
      description: 'Para equipes em crescimento',
      type: 'SUBSCRIPTION',
      trialDays: 14,
      badge: 'Popular',
      sortOrder: 2,
      prices: [
        {
          id: 'uuid',
          interval: 'MONTHLY',
          amount: 99.0,
          currency: 'BRL',
          originalAmount: 129.0,
        },
        {
          id: 'uuid',
          interval: 'YEARLY',
          amount: 990.0,
          currency: 'BRL',
          originalAmount: 1290.0,
        },
      ],
      features: [
        {
          code: 'USERS',
          name: 'UsuÃ¡rios',
          type: 'QUOTA',
          limitValue: 25,
          unit: 'users',
        },
        {
          code: 'DASHBOARD_ANALYTICS',
          name: 'Dashboard Analytics',
          type: 'BOOLEAN',
          enabled: true,
        },
      ],
    },
  ];
}
```

#### GET /api/plans/:id

Detalhes de um plano especÃ­fico.

**Response:** Mesmo formato acima, mas objeto Ãºnico.

#### POST /api/plans (Admin Only)

Criar novo plano.

**Request Body:**

```typescript
{
  code: "enterprise",
  name: "Plano Enterprise",
  description: "Para grandes empresas",
  type: "SUBSCRIPTION",
  trialDays: 30,
  isPublic: true,
  badge: "Best Value",
  sortOrder: 3,
  prices: [
    {
      interval: "MONTHLY",
      amount: 299.00,
      currency: "BRL"
    }
  ],
  features: [
    { featureCode: "USERS", limitValue: -1 },  // Unlimited
    { featureCode: "STORAGE_MB", limitValue: -1 },
    { featureCode: "DASHBOARD_ANALYTICS", enabled: true }
  ]
}
```

#### PUT /api/plans/:id (Admin Only)

Atualizar plano existente.

#### DELETE /api/plans/:id (Admin Only)

Desativar plano (soft delete via `isActive = false`).

---

### 4.2 Products API

#### GET /api/products

Lista produtos disponÃ­veis.

**Query Parameters:**

```typescript
{
  tenantId?: string;
  isActive?: boolean;
  type?: 'ONE_TIME' | 'CONSUMABLE' | 'ADD_ON';
}
```

**Response:**

```typescript
{
  products: [
    {
      id: 'uuid',
      code: 'extra_storage_10gb',
      name: 'Armazenamento Extra (10GB)',
      description: 'Adicione 10GB ao seu plano',
      type: 'ONE_TIME',
      price: 19.0,
      currency: 'BRL',
      originalPrice: 29.0,
      imageUrl: 'https://...',
      stock: -1,
      maxPerTenant: 5,
      effects: [
        {
          featureCode: 'STORAGE_MB',
          effectType: 'ADD',
          value: 10000,
          durationDays: 365,
        },
      ],
    },
  ];
}
```

#### GET /api/products/:id

Detalhes de um produto.

#### POST /api/products (Admin Only)

Criar produto.

#### PUT /api/products/:id (Admin Only)

Atualizar produto.

#### DELETE /api/products/:id (Admin Only)

Desativar produto.

---

### 4.3 Subscriptions API

#### GET /api/subscriptions/current

Subscription atual do tenant autenticado.

**Response:**

```typescript
{
  subscription: {
    id: "uuid",
    status: "ACTIVE",
    plan: {
      code: "pro",
      name: "Plano Pro"
    },
    price: {
      interval: "MONTHLY",
      amount: 99.00,
      currency: "BRL"
    },
    currentPeriodStart: "2026-01-01T00:00:00Z",
    currentPeriodEnd: "2026-02-01T00:00:00Z",
    cancelAtPeriodEnd: false,
    features: {
      USERS: { type: "QUOTA", limit: 25, current: 12 },
      STORAGE_MB: { type: "QUOTA", limit: 10000, current: 3500 },
      DASHBOARD_ANALYTICS: { type: "BOOLEAN", enabled: true }
    }
  }
}
```

#### POST /api/subscriptions/upgrade

Fazer upgrade/downgrade de plano.

**Request Body:**

```typescript
{
  planId: "uuid",
  priceId: "uuid",  // Opcional: escolher intervalo especÃ­fico
  prorated: true    // Calcular valor proporcional
}
```

#### POST /api/subscriptions/cancel

Cancelar subscription.

**Request Body:**

```typescript
{
  immediately: false,  // true = cancela agora, false = no fim do perÃ­odo
  reason: "Muito caro"
}
```

---

## 5. Fluxos de NegÃ³cio

### 5.1 CriaÃ§Ã£o de Tenant com Plano Free

```
1. Tenant se registra
2. Sistema cria Subscription automÃ¡tica com Plan "free"
3. Features do plano free sÃ£o aplicadas
4. Tenant pode usar sistema dentro dos limites
```

### 5.2 Upgrade de Plano

```
1. Tenant seleciona novo plano (ex: Pro)
2. Sistema calcula valor proporcional (se aplicÃ¡vel)
3. Cria pagamento (Stripe/PagueBit)
4. ApÃ³s confirmaÃ§Ã£o de pagamento:
   - Atualiza Subscription.planId
   - Atualiza features disponÃ­veis
   - Registra em AuditLog
5. Tenant tem acesso imediato Ã s novas features
```

### 5.3 Compra de Produto One-time

```
1. Tenant compra "Armazenamento Extra (10GB)"
2. Sistema cria Purchase record
3. Cria pagamento
4. ApÃ³s confirmaÃ§Ã£o:
   - Aplica ProductEffect (adiciona 10GB)
   - Atualiza UsageRecord
   - Tenant vÃª limite aumentado
```

---

## 6. Exemplos de Uso

### 6.1 Verificar se Tenant Tem Acesso a Feature

```typescript
// apps/api/src/modules/subscriptions/services/entitlement.service.ts

export class EntitlementService {
  async hasFeature(tenantId: string, featureCode: string): Promise<boolean> {
    const subscription = await prisma.subscription.findUnique({
      where: { tenantId },
      include: {
        plan: {
          include: {
            features: {
              where: { feature: { code: featureCode } },
              include: { feature: true },
            },
          },
        },
      },
    });

    if (!subscription) return false;

    const planFeature = subscription.plan.features.find(
      (f) => f.feature.code === featureCode,
    );

    if (!planFeature) return false;

    if (planFeature.feature.type === 'BOOLEAN') {
      return planFeature.enabled;
    }

    return true;
  }

  async getQuotaLimit(tenantId: string, featureCode: string): Promise<number> {
    const subscription = await prisma.subscription.findUnique({
      where: { tenantId },
      include: {
        plan: {
          include: {
            features: {
              where: { feature: { code: featureCode } },
              include: { feature: true },
            },
          },
        },
      },
    });

    const planFeature = subscription?.plan.features.find(
      (f) => f.feature.code === featureCode,
    );

    return planFeature?.limitValue ?? 0;
  }
}
```

### 6.2 Middleware de VerificaÃ§Ã£o de Feature

```typescript
// apps/api/src/middleware/feature-guard.middleware.ts

export function requireFeature(featureCode: string) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    const tenantId = request.user.tenantId;

    const hasAccess = await entitlementService.hasFeature(
      tenantId,
      featureCode,
    );

    if (!hasAccess) {
      return reply.status(403).send({
        error: 'Feature not available in your plan',
        featureCode,
        upgradeUrl: '/pricing',
      });
    }
  };
}

// Uso:
fastify.get(
  '/api/analytics',
  {
    preHandler: requireFeature('DASHBOARD_ANALYTICS'),
  },
  analyticsController.getAnalytics,
);
```

---

## 7. Guias de ImplementaÃ§Ã£o

### 7.1 Adicionar Nova Feature

1. **Criar feature no banco:**

```sql
INSERT INTO features (code, name, type, unit, category)
VALUES ('API_WEBHOOKS', 'Webhooks', 'BOOLEAN', null, 'Integrations');
```

2. **Adicionar aos planos:**

```sql
INSERT INTO plan_features (plan_id, feature_id, enabled)
SELECT p.id, f.id, true
FROM plans p, features f
WHERE p.code IN ('pro', 'enterprise')
  AND f.code = 'API_WEBHOOKS';
```

3. **Usar no cÃ³digo:**

```typescript
if (await entitlementService.hasFeature(tenantId, 'API_WEBHOOKS')) {
  // Permitir configuraÃ§Ã£o de webhooks
}
```

### 7.2 Criar Novo Plano via API

```bash
curl -X POST http://localhost:3001/api/plans \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "startup",
    "name": "Plano Startup",
    "description": "Para startups em crescimento",
    "type": "SUBSCRIPTION",
    "trialDays": 14,
    "isPublic": true,
    "badge": "Recomendado",
    "sortOrder": 1,
    "prices": [
      {
        "interval": "MONTHLY",
        "amount": 49.00,
        "currency": "BRL"
      }
    ],
    "features": [
      { "featureCode": "USERS", "limitValue": 10 },
      { "featureCode": "STORAGE_MB", "limitValue": 5000 },
      { "featureCode": "DASHBOARD_ANALYTICS", "enabled": true }
    ]
  }'
```

---

## ğŸ“š ReferÃªncias

- [PLANS_PRODUCTS_SPECIFICATION.md](file:///home/bychrisr/projects/kaven-boilerplate/PLANS_PRODUCTS_SPECIFICATION.md) - EspecificaÃ§Ã£o completa
- [Prisma Schema](file:///home/bychrisr/projects/kaven-boilerplate/prisma/schema.prisma) - Modelos de dados
- [Phase 0 - Database Specification](file:///home/bychrisr/projects/kaven-boilerplate/Phase%200%20-%20FOUNDATION/9.%20DATABASE%20SPECIFICATION.md) - DocumentaÃ§Ã£o do banco

---

**Ãšltima AtualizaÃ§Ã£o:** 05/01/2026  
**Autor:** Kaven Development Team

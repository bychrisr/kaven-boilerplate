# üõ°Ô∏è Guia de Troubleshooting: Autentica√ß√£o & "Zombie Sessions"

Este guia documenta o problema de "Zombie Session Loop" encontrado e resolvido em Dezembro/2025, para refer√™ncia futura.

## üö® Sintoma: O Loop Infinito

1. Usu√°rio faz login com sucesso (`200 OK`, recebe tokens).
2. Usu√°rio √© redirecionado para o Dashboard.
3. Dashboard pisca e usu√°rio volta para o Login.
4. Console mostra erro `401 Unauthorized` em `/api/users/me` ou `/api/users`.

## üïµÔ∏è Causa Raiz: "The Soft-Delete Trap"

O problema ocorre quando um usu√°rio est√° marcado como **DELETADO** (`deletedAt !== null`) no banco de dados, mas o sistema de login n√£o valida isso.

### O Fluxo da Falha

1. **Login (AuthService):** Aceitava email/senha corretos, ignorando `deletedAt`. Gerava um JWT v√°lido.
2. **Dashboard (AuthMiddleware):** Recebia o JWT. Validava a assinatura (ok). Consultava o usu√°rio no banco pelo ID do token.
3. **Bloqueio (AuthMiddleware):** O middleware (Axisor Style) checa se `deletedAt` existe. Se sim, retorna `401 Unauthorized`.
4. **Frontend (Axios Interceptor):** Recebe `401`. Tenta refresh.
5. **Refresh (AuthService):** Tamb√©m falha pois o usu√°rio est√° deletado.
6. **Frontend:** Redireciona para `/login`.

Resultado: O usu√°rio tem credenciais "v√°lidas" para gerar token, mas o token √© "inv√°lido" para usar a API.

## ‚úÖ Solu√ß√£o Implementada

### 1. Backend: Bloqueio no Login

Modificado `AuthService.login` para rejeitar o login se o usu√°rio estiver deletado.

```typescript
// apps/api/src/modules/auth/services/auth.service.ts
if (!user || user.deletedAt) {
  throw new Error('Credenciais inv√°lidas');
}
```

Isso previne a cria√ß√£o de tokens "zumbi".

### 2. Frontend: Robust AuthGuard

Implementado `RobustAuthGuard` (Axisor Pattern) que lida melhor com falhas de inicializa√ß√£o.

- Timeout de seguran√ßa (3s) para evitar loading infinito.
- Verifica√ß√£o direta no `localStorage` como fallback.

## üõ†Ô∏è Ferramentas Forenses

Scripts criados para diagnosticar este problema:

- `apps/api/scripts/debug-auth.ts`: Verifica a exist√™ncia do usu√°rio, tipos de ID e gera/valida tokens manualmente.
- `apps/api/scripts/restore-user.ts`: Restaura um usu√°rio soft-deleted (remove `deletedAt`).

## üìù Checklist de Preven√ß√£o

- [ ] Sempre verificar `deletedAt` em opera√ß√µes de Login/Recovery.
- [ ] Middleware deve continuar retornando 401 para usu√°rios deletados (Correto).
- [ ] Frontend deve tratar 401 como logout definitivo (Correto).

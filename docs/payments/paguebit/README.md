# PagueBit - DocumentaÃ§Ã£o Completa

**VersÃ£o:** 1.0.0  
**Data:** 05 de janeiro de 2026  
**Status:** âœ… IMPLEMENTADO E TESTADO

---

## ğŸ“‘ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Arquitetura](#arquitetura)
3. [ImplementaÃ§Ã£o](#implementaÃ§Ã£o)
4. [API Reference](#api-reference)
5. [Webhooks](#webhooks)
6. [SeguranÃ§a](#seguranÃ§a)
7. [Testes](#testes)
8. [Troubleshooting](#troubleshooting)
9. [Respostas TÃ©cnicas Confirmadas](#respostas-tÃ©cnicas-confirmadas)

---

## 1. VisÃ£o Geral

### 1.1 O que Ã© PagueBit?

PagueBit Ã© um gateway de pagamentos brasileiro especializado em PIX. Nossa integraÃ§Ã£o permite:

- âœ… **QR Code DinÃ¢mico** - Pagamentos com valor fixo e expiraÃ§Ã£o de 10 minutos
- âœ… **Webhooks HMAC v2** - NotificaÃ§Ãµes seguras de mudanÃ§a de status
- âœ… **Retry AutomÃ¡tico** - Backoff exponencial em rate limit (300 req/min)
- âœ… **IdempotÃªncia** - Processamento seguro de webhooks duplicados
- âœ… **Multi-tenant** - Suporte completo para arquitetura multi-tenant

### 1.2 Fluxo de Pagamento

```mermaid
sequenceDiagram
    participant U as UsuÃ¡rio
    participant F as Frontend
    participant A as API Kaven
    participant P as PagueBit API
    participant W as Webhook

    U->>F: Seleciona plano/produto
    F->>A: POST /api/payments/paguebit/create
    A->>A: Cria Purchase (PENDING)
    A->>P: POST /qrcode/dynamic
    P-->>A: QR Code + paymentId
    A->>A: Salva externalPaymentId
    A-->>F: QR Code + expiresAt
    F-->>U: Exibe QR Code (10min)

    U->>P: Paga via PIX
    P->>P: Processa pagamento
    P->>W: POST /webhooks/paguebit (approved)
    W->>W: Valida HMAC-SHA256
    W->>W: Verifica idempotÃªncia
    W->>W: Atualiza Purchase (COMPLETED)
    W->>W: Aplica efeitos
    W-->>P: 200 OK

    F->>A: GET /api/payments/paguebit/:id/status
    A-->>F: status: COMPLETED
    F-->>U: âœ… Pagamento confirmado!
```

---

## 2. Arquitetura

### 2.1 Estrutura de Arquivos

```
apps/api/src/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ validation-payments.ts              # Schemas Zod
â”‚
â”œâ”€â”€ modules/payments/
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ pix.interface.ts                # Interface agnÃ³stica
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ paguebit/
â”‚   â”‚       â”œâ”€â”€ paguebit.client.ts          # HTTP client + retry
â”‚   â”‚       â”œâ”€â”€ paguebit.service.ts         # Service principal
â”‚   â”‚       â”œâ”€â”€ paguebit.types.ts           # DTOs TypeScript
â”‚   â”‚       â””â”€â”€ paguebit.webhook.ts         # Webhook handler
â”‚   â”‚
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â””â”€â”€ payment.controller.ts           # Endpoints HTTP
â”‚   â”‚
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ payment.routes.ts               # DefiniÃ§Ã£o de rotas
â”‚
prisma/
â””â”€â”€ schema.prisma                           # WebhookEvent model
```

### 2.2 Componentes

#### IPixProvider (Interface AgnÃ³stica)

AbstraÃ§Ã£o que permite trocar de provider sem alterar cÃ³digo:

```typescript
export interface IPixProvider {
  createDynamicQRCode(params: CreateQRCodeParams): Promise<QRCodeResponse>;
  getPaymentStatus(paymentId: string): Promise<PaymentStatus>;
  validateWebhook(signature: string, body: string, timestamp: string): boolean;
  processWebhook(payload: WebhookPayload): Promise<void>;
}
```

**BenefÃ­cios:**

- Facilita migraÃ§Ã£o entre providers (PagueBit â†’ Mercado Pago)
- Permite mÃºltiplos providers simultÃ¢neos
- Testes mais fÃ¡ceis (mocks)

#### PagueBitClient (HTTP com Retry)

```typescript
export class PagueBitClient {
  private client: AxiosInstance;

  async post<T>(endpoint: string, data: any, retries = 3): Promise<T> {
    try {
      const response = await this.client.post(endpoint, data);
      return response.data;
    } catch (error) {
      // Rate limit (429) - retry com backoff exponencial
      if (error.response?.status === 429 && retries > 0) {
        const delay = Math.pow(2, 4 - retries) * 1000; // 2s, 4s, 8s
        await this.sleep(delay);
        return this.post(endpoint, data, retries - 1);
      }
      throw error;
    }
  }
}
```

**CaracterÃ­sticas:**

- Base URL: `https://api.paguebit.com/v1`
- Timeout: 30 segundos
- Retry automÃ¡tico em 429 (rate limit)
- Backoff: 2s â†’ 4s â†’ 8s

#### PagueBitService

```typescript
export class PagueBitService implements IPixProvider {
  async createDynamicQRCode(
    params: CreateQRCodeParams,
  ): Promise<QRCodeResponse> {
    const response = await this.client.post('/qrcode/dynamic', {
      value: params.amount,
      description: params.description,
      external_id: params.externalId,
      metadata: params.metadata,
    });

    return {
      paymentId: response.id,
      qrCode: response.qr_code, // Base64 da imagem
      qrCodeText: response.qr_code_text, // CÃ³digo copia-e-cola
      expiresAt: new Date(Date.now() + 10 * 60 * 1000), // 10 minutos
    };
  }

  validateWebhook(signature: string, body: string, timestamp: string): boolean {
    const secret = process.env.PAGUEBIT_WEBHOOK_SECRET!;

    // HMAC-SHA256 VersÃ£o 2: hash(timestamp + body, secret)
    const payload = timestamp + body;
    const expectedSignature = crypto
      .createHmac('sha256', secret)
      .update(payload)
      .digest('hex');

    return crypto.timingSafeEqual(
      Buffer.from(signature),
      Buffer.from(expectedSignature),
    );
  }
}
```

#### PagueBitWebhook (Handler)

```typescript
export async function handlePagueBitWebhook(
  request: FastifyRequest,
  reply: FastifyReply,
) {
  // 1. Validar assinatura HMAC
  const isValid = pagueBitService.validateWebhook(signature, body, timestamp);
  if (!isValid) {
    return reply.status(401).send({ error: 'Invalid signature' });
  }

  // 2. IdempotÃªncia
  const existingEvent = await prisma.webhookEvent.findUnique({
    where: { externalId: eventId },
  });
  if (existingEvent) {
    return reply.status(200).send({ received: true, duplicate: true });
  }

  // 3. Salvar evento
  await prisma.webhookEvent.create({
    data: {
      externalId: eventId,
      provider: 'PAGUEBIT',
      event: 'payment.status_changed',
      payload: request.body,
      processedAt: null,
    },
  });

  // 4. Processar
  await processPaymentWebhook(payload);

  // 5. Marcar como processado
  await prisma.webhookEvent.update({
    where: { externalId: eventId },
    data: { processedAt: new Date() },
  });

  return reply.status(200).send({ received: true });
}
```

---

## 3. ImplementaÃ§Ã£o

### 3.1 ConfiguraÃ§Ã£o

#### VariÃ¡veis de Ambiente

```bash
# .env
PAGUEBIT_API_TOKEN=seu-token-aqui
PAGUEBIT_WEBHOOK_SECRET=seu-secret-aqui
```

#### Obter Credenciais

1. Acesse [PagueBit Dashboard](https://dashboard.paguebit.com)
2. **ConfiguraÃ§Ãµes** â†’ **API**
3. Copie **API Token** e **Webhook Secret**

### 3.2 Database Schema

```prisma
model WebhookEvent {
  id String @id @default(uuid())

  externalId String @unique @map("external_id")
  provider String
  event String
  payload Json
  processedAt DateTime? @map("processed_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([provider])
  @@index([event])
  @@map("webhook_events")
}
```

**MigraÃ§Ã£o:**

```bash
npx prisma migrate dev --name add_webhook_event
npx prisma generate
```

---

## 4. API Reference

### 4.1 POST /api/payments/paguebit/create

Criar pagamento PIX.

**Headers:**

```
Content-Type: application/json
Authorization: Bearer {token}
```

**Request Body:**

```json
{
  "userId": "uuid",
  "tenantId": "uuid",
  "productId": "uuid", // OU planId
  "planId": "uuid" // OU productId
}
```

**Response (201):**

```json
{
  "purchaseId": "550e8400-e29b-41d4-a716-446655440000",
  "paymentId": "paguebit_payment_123",
  "qrCode": "data:image/png;base64,iVBORw0KGgoAAAANS...",
  "qrCodeText": "00020126580014br.gov.bcb.pix...",
  "expiresAt": "2026-01-05T12:50:00.000Z",
  "amount": 29.99
}
```

**Erros:**

- `400` - Dados invÃ¡lidos
- `404` - Produto/plano nÃ£o encontrado
- `500` - Erro ao criar pagamento

### 4.2 GET /api/payments/paguebit/:id/status

Verificar status de pagamento.

**Response (200):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "PENDING", // PENDING | COMPLETED | FAILED
  "amount": 29.99,
  "externalPaymentId": "paguebit_payment_123"
}
```

### 4.3 POST /api/webhooks/paguebit

Webhook do PagueBit (chamado automaticamente).

**Headers:**

```
X-Paguebit-Signature: a1b2c3d4e5f6...
X-Paguebit-Timestamp: 1704470400
X-Paguebit-Event-Id: evt_unique_id_123
Content-Type: application/json
```

**Payload:**

```json
{
  "id": "paguebit_payment_123",
  "external_id": "550e8400-e29b-41d4-a716-446655440000",
  "value": 29.99,
  "status": "approved",
  "paid_at": "2026-01-05T12:45:00.000Z",
  "metadata": {
    "userId": "uuid",
    "tenantId": "uuid"
  }
}
```

**Response (200):**

```json
{
  "received": true
}
```

---

## 5. Webhooks

### 5.1 Status de Pagamento

| Status         | DescriÃ§Ã£o                    | AÃ§Ã£o                    |
| -------------- | ---------------------------- | ----------------------- |
| `pending`      | Aguardando pagamento         | NÃ£o fazer nada          |
| `review`       | Em anÃ¡lise (limite diÃ¡rio)   | **NÃƒO** confirmar ainda |
| `approved`     | âœ… Pagamento aprovado        | **ÃšNICO** que confirma  |
| `not_approved` | Rejeitado/expirado/estornado | Cancelar purchase       |

### 5.2 ValidaÃ§Ã£o HMAC v2

```typescript
// VersÃ£o 2: HMAC-SHA256(timestamp + body, secret)
const payload = timestamp + body;
const expectedSignature = crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');

const isValid = crypto.timingSafeEqual(
  Buffer.from(signature),
  Buffer.from(expectedSignature),
);
```

**âš ï¸ IMPORTANTE:**

- **SEMPRE** validar assinatura antes de processar
- Usar `timingSafeEqual` para evitar timing attacks
- Rejeitar webhooks com assinatura invÃ¡lida (401)

### 5.3 IdempotÃªncia

```typescript
// Verificar se evento jÃ¡ foi processado
const existingEvent = await prisma.webhookEvent.findUnique({
  where: { externalId: eventId },
});

if (existingEvent) {
  // Webhook duplicado - retornar sucesso sem reprocessar
  return reply.status(200).send({ received: true, duplicate: true });
}
```

**Por que Ã© importante:**

- PagueBit pode enviar mesmo webhook mÃºltiplas vezes
- Evita processar pagamento 2x
- Evita aplicar efeitos duplicados

---

## 6. SeguranÃ§a

### 6.1 Checklist de SeguranÃ§a

- [x] ValidaÃ§Ã£o HMAC em todos os webhooks
- [x] IdempotÃªncia implementada
- [x] Secrets em variÃ¡veis de ambiente
- [x] HTTPS obrigatÃ³rio em produÃ§Ã£o
- [x] Rate limiting implementado
- [x] Logs de auditoria (WebhookEvent)

### 6.2 ProteÃ§Ã£o contra Ataques

#### Replay Attack

```typescript
// Verificar timestamp (max 5 minutos de diferenÃ§a)
const now = Math.floor(Date.now() / 1000);
const webhookTimestamp = parseInt(timestamp);

if (Math.abs(now - webhookTimestamp) > 300) {
  return reply.status(401).send({ error: 'Timestamp too old' });
}
```

#### Timing Attack

```typescript
// SEMPRE usar timingSafeEqual
return crypto.timingSafeEqual(
  Buffer.from(signature),
  Buffer.from(expectedSignature),
);
```

---

## 7. Testes

### 7.1 Teste Manual (Desenvolvimento)

```bash
# 1. Criar pagamento
curl -X POST http://localhost:8000/api/payments/paguebit/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "userId": "user-uuid",
    "tenantId": "tenant-uuid",
    "planId": "plan-uuid"
  }'

# 2. Verificar status
curl http://localhost:8000/api/payments/paguebit/{purchaseId}/status

# 3. Simular webhook (use ngrok para expor localhost)
curl -X POST https://your-domain.com/api/webhooks/paguebit \
  -H "X-Paguebit-Signature: {hmac-signature}" \
  -H "X-Paguebit-Timestamp: 1704470400" \
  -H "X-Paguebit-Event-Id: unique-id" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "payment-id",
    "external_id": "purchase-uuid",
    "value": 29.99,
    "status": "approved"
  }'
```

### 7.2 Gerar Assinatura HMAC (Teste)

```typescript
import crypto from 'crypto';

const secret = 'seu-webhook-secret';
const timestamp = '1704470400';
const body = JSON.stringify({
  id: 'payment-id',
  external_id: 'purchase-uuid',
  value: 29.99,
  status: 'approved',
});

const payload = timestamp + body;
const signature = crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');

console.log('X-Paguebit-Signature:', signature);
```

---

## 8. Troubleshooting

### 8.1 Problemas Comuns

#### QR Code nÃ£o aparece

**Causa:** Erro ao criar pagamento no PagueBit

**SoluÃ§Ã£o:**

```bash
# Verificar logs
tail -f logs/api.log | grep "PagueBit"

# Verificar credenciais
echo $PAGUEBIT_API_TOKEN
```

#### Webhook nÃ£o chega

**Causa:** URL nÃ£o configurada no PagueBit Dashboard

**SoluÃ§Ã£o:**

1. Acesse PagueBit Dashboard
2. **ConfiguraÃ§Ãµes** â†’ **Webhooks**
3. Adicione: `https://seu-dominio.com/api/webhooks/paguebit`

#### Webhook com assinatura invÃ¡lida

**Causa:** Secret incorreto ou body modificado

**SoluÃ§Ã£o:**

```typescript
// Verificar se body estÃ¡ sendo parseado antes da validaÃ§Ã£o
const body = JSON.stringify(request.body); // âœ… Correto
const body = request.body; // âŒ Errado
```

#### Rate limit (429)

**Causa:** Mais de 300 requisiÃ§Ãµes/minuto

**SoluÃ§Ã£o:** Retry automÃ¡tico jÃ¡ implementado (2s, 4s, 8s)

---

## 9. Respostas TÃ©cnicas Confirmadas

### 9.1 Webhook

**Pergunta:** Recebemos webhook com status `review`?

**Resposta:**

- âœ… Recebem webhook em **todas** as trocas de status
- â±ï¸ Reembolso geralmente demora **no mÃ¡ximo 1 hora**
- âš ï¸ Pode levar atÃ© **1 dia** em casos especÃ­ficos

**ImplementaÃ§Ã£o:**

- `pending` â†’ Aguardando
- `review` â†’ **NÃƒO** confirmar ainda
- `approved` â†’ âœ… **ÃšNICO** que confirma
- `not_approved` â†’ Cancelar

### 9.2 ExpiraÃ§Ã£o de QR Code

**Pergunta:** ApÃ³s 10 minutos, o que acontece?

**Resposta:**

- âœ… Muda para `not_approved` (nÃ£o existe status `expired`)
- âœ… Se cliente pagar QR expirado â†’ **estornado automaticamente**

**ImplementaÃ§Ã£o:**

```typescript
const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutos

// Frontend: Countdown
if (Date.now() > expiresAt && payment.status === 'pending') {
  // Aguardar webhook com status 'not_approved'
}
```

### 9.3 Cancelamento

**Pergunta:** Existe endpoint para cancelar pagamento `pending`?

**Resposta:**

- âŒ NÃ£o existe endpoint de cancelamento
- âœ… ApÃ³s um tempo, pagamentos `pending` sÃ£o alterados para `not_approved` automaticamente
- âœ… Isso acontece quando o QR Code expira (10 minutos)

### 9.4 Rate Limiting

**Pergunta:** API retorna headers informativos?

**Resposta:**

- âŒ NÃ£o retorna headers de rate limit
- âœ… Limite conhecido: **300 req/min por IP**

**ImplementaÃ§Ã£o:**

```typescript
// Retry com backoff exponencial
async function callPagueBitAPI(endpoint: string, data: any, retries = 3) {
  try {
    return await axios.post(endpoint, data);
  } catch (error) {
    if (error.response?.status === 429 && retries > 0) {
      const delay = Math.pow(2, 4 - retries) * 1000; // 2s, 4s, 8s
      await sleep(delay);
      return callPagueBitAPI(endpoint, data, retries - 1);
    }
    throw error;
  }
}
```

---

## ğŸ“š ReferÃªncias

- [PagueBit API Docs](https://docs.paguebit.com)
- [PagueBit Dashboard](https://dashboard.paguebit.com)
- [Plans & Products System](../PLANS_PRODUCTS.md)

---

## ğŸ“ Changelog

### v1.0.0 (05/01/2026)

- âœ… ImplementaÃ§Ã£o inicial completa
- âœ… QR Code DinÃ¢mico
- âœ… Webhook Handler com HMAC v2
- âœ… Retry automÃ¡tico em rate limit
- âœ… IdempotÃªncia
- âœ… IntegraÃ§Ã£o com Plans & Products

---

**Ãšltima AtualizaÃ§Ã£o:** 05/01/2026 12:42  
**Autor:** Antigravity AI  
**VersÃ£o:** 1.0.0

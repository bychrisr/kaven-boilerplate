# MÃ©todos de Pagamento - Kaven

DocumentaÃ§Ã£o centralizada de todos os mÃ©todos de pagamento integrados ao sistema Kaven.

---

## ğŸ“‹ Providers DisponÃ­veis

### âœ… PagueBit (Implementado)

- **Tipo:** PIX (Brasil)
- **Status:** âœ… ProduÃ§Ã£o
- **DocumentaÃ§Ã£o:** [./paguebit/README.md](./paguebit/README.md)
- **Features:**
  - QR Code DinÃ¢mico
  - Webhooks HMAC v2
  - Retry automÃ¡tico
  - IdempotÃªncia

### ğŸ”„ Stripe (Parcial)

- **Tipo:** CartÃ£o de CrÃ©dito (Internacional)
- **Status:** ğŸ”„ ImplementaÃ§Ã£o bÃ¡sica
- **DocumentaÃ§Ã£o:** [./stripe/README.md](./stripe/README.md)
- **Features:**
  - Subscriptions
  - Payment Methods
  - Webhooks

### â¸ï¸ Mercado Pago (Planejado)

- **Tipo:** PIX + CartÃ£o (Brasil)
- **Status:** â¸ï¸ Aguardando
- **DocumentaÃ§Ã£o:** [./mercadopago/README.md](./mercadopago/README.md)

---

## ğŸ—ï¸ Arquitetura

### Interface AgnÃ³stica

Todos os providers implementam `IPixProvider`:

```typescript
export interface IPixProvider {
  createDynamicQRCode(params: CreateQRCodeParams): Promise<QRCodeResponse>;
  getPaymentStatus(paymentId: string): Promise<PaymentStatus>;
  validateWebhook(signature: string, body: string, timestamp: string): boolean;
  processWebhook(payload: WebhookPayload): Promise<void>;
}
```

**BenefÃ­cios:**

- Trocar provider sem alterar cÃ³digo
- MÃºltiplos providers simultÃ¢neos
- Testes mais fÃ¡ceis

### Estrutura de Pastas

```
apps/api/src/modules/payments/
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ pix.interface.ts          # Interface agnÃ³stica
â”‚   â”œâ”€â”€ paguebit/                 # Provider PagueBit
â”‚   â”œâ”€â”€ stripe/                   # Provider Stripe
â”‚   â””â”€â”€ mercadopago/              # Provider Mercado Pago (futuro)
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ payment.controller.ts
â””â”€â”€ routes/
    â””â”€â”€ payment.routes.ts
```

---

## ğŸš€ Quick Start

### 1. Configurar VariÃ¡veis de Ambiente

```bash
# .env
PAGUEBIT_API_TOKEN=seu-token
PAGUEBIT_WEBHOOK_SECRET=seu-secret

STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

### 2. Criar Pagamento

```bash
curl -X POST http://localhost:8000/api/payments/paguebit/create \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "uuid",
    "tenantId": "uuid",
    "planId": "uuid"
  }'
```

### 3. Configurar Webhook

**PagueBit:**

```
https://seu-dominio.com/api/webhooks/paguebit
```

**Stripe:**

```
https://seu-dominio.com/api/webhooks/stripe
```

---

## ğŸ“Š ComparaÃ§Ã£o de Providers

| Feature       | PagueBit | Stripe | Mercado Pago |
| ------------- | -------- | ------ | ------------ |
| PIX           | âœ…       | âŒ     | âœ…           |
| CartÃ£o        | âŒ       | âœ…     | âœ…           |
| Boleto        | âŒ       | âŒ     | âœ…           |
| Internacional | âŒ       | âœ…     | âŒ           |
| Taxa          | ~1%      | ~4%    | ~3%          |
| Webhooks      | âœ…       | âœ…     | âœ…           |
| Retry         | âœ…       | âœ…     | â¸ï¸           |

---

## ğŸ”’ SeguranÃ§a

### Checklist Geral

- [x] ValidaÃ§Ã£o de webhooks (HMAC)
- [x] IdempotÃªncia implementada
- [x] Secrets em variÃ¡veis de ambiente
- [x] HTTPS obrigatÃ³rio
- [x] Rate limiting
- [x] Logs de auditoria

### ValidaÃ§Ã£o de Webhooks

**PagueBit (HMAC-SHA256 v2):**

```typescript
const payload = timestamp + body;
const signature = crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');
```

**Stripe:**

```typescript
const event = stripe.webhooks.constructEvent(body, signature, secret);
```

---

## ğŸ“š DocumentaÃ§Ã£o Detalhada

- **PagueBit:** [./paguebit/README.md](./paguebit/README.md)
- **Stripe:** [./stripe/README.md](./stripe/README.md)
- **Mercado Pago:** [./mercadopago/README.md](./mercadopago/README.md)

---

**Ãšltima AtualizaÃ§Ã£o:** 05/01/2026  
**VersÃ£o:** 1.0.0
